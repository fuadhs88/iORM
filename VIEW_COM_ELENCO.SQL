CREATE VIEW COM_ELENCO_VIEW (

  ID
 ,RIF_ID
 ,RIF_TIPO
 ,RIF_RIFERIMENTO
 ,ID_SOURCE
 ,ID_SOGGETTO
 ,RIF_SOGGETTO_FULL
 ,DEST_RAGSOC
 ,DEST_INDIRIZZO
 ,DEST_NUMCIVICO
 ,DEST_COMUNE
 ,DEST_PROVINCIA
 ,DEST_CAP
 ,DEST_EMAIL
 ,DEST_CELLULARE
 ,ID_PRATICA
 ,PRATICA
 ,DATAPRATICA1
 ,RIF_PRATICA_FULL
 ,DATA
 ,MSG_TYPE
 ,MSG_OGGETTO
 ,DATAULTMOD_CREAZIONE
 ,DATAULTMOD_GENERALE
 ,NUMEROINVII
 ,PRIMOINVIO_DATAORA
 ,ULTIMOINVIO_DATAORA

) AS

  SELECT
    MSG.ID
   ,MSG.RIF_ID
   ,MSG.RIF_TIPO
   ,(SELECT RIF_RIFERIMENTO FROM COM_GET_RIF_INFO (MSG.ID_SOGGETTO, MSG.ID_PRATICA, MSG.RIF_ID, MSG.RIF_TIPO))
   ,MSG.ID_SOURCE 
   ,MSG.ID_SOGGETTO
   ,CAST(CLI.RAGIONESOCIALE || '  (' || CLI.CODICE || ')' AS VARCHAR(80)) AS RIF_SOGGETTO_FULL
   ,MSG.DEST_RAGSOC
   ,MSG.DEST_INDIRIZZO
   ,MSG.DEST_NUMCIVICO
   ,MSG.DEST_COMUNE
   ,MSG.DEST_PROVINCIA
   ,MSG.DEST_CAP
   ,MSG.DEST_EMAIL
   ,MSG.DEST_CELLULARE
   ,MSG.ID_PRATICA
   ,MSG.PRATICA
   ,MSG.DATAPRATICA1
   ,CAST(PRAT.DESCRIZIONE ||'  ('||PRAT.CODICE|| ', '||PRAT.DATAAPERTURA||')' AS VARCHAR(120)) AS RIFPRATICA
   ,MSG.DATA
   ,MSG.MSG_TYPE
   ,MSG.MSG_OGGETTO
   ,MSG.DATAULTMOD_CREAZIONE
   ,MSG.DATAULTMOD_GENERALE
   ,(SELECT COUNT(*) FROM COM_STORICO CS WHERE CS.ID_MSG=MSG.ID) AS NUMEROINVII
   ,(SELECT MIN(CS.DATAORAINVIO) FROM COM_STORICO CS WHERE CS.ID_MSG=MSG.ID) AS PRIMOINVIO_DATAORA  
   ,(SELECT MAX(CS.DATAORAINVIO) FROM COM_STORICO CS WHERE CS.ID_MSG=MSG.ID) AS ULTIMOINVIO_DATAORA  

  FROM COM_MESSAGGI MSG
  LEFT JOIN CLIENTI CLI ON (CLI.CODICE=MSG.ID_SOGGETTO)
  LEFT JOIN PRATICHE PRAT ON (PRAT.ID=MSG.ID_PRATICA)
;