SET TERM ^ ;

CREATE PROCEDURE OP_PRATAPP_ADDALL (IN_IDPRATICA INTEGER, IN_IDPRATAPP INTEGER, IN_TIPOPRATAPP VARCHAR(30), IN_TIPOIMPIANTO VARCHAR(20))
AS

  /* Dati dell'OP */
  DECLARE OP_CODICE VARCHAR(25);

BEGIN

  /* Cicla per tutte le OP relative al tipo di apparecchio */
  FOR SELECT OP.CODICE FROM OP
  WHERE NOT (
        AUTOLOAD1  <> :IN_TIPOPRATAPP
    AND AUTOLOAD2  <> :IN_TIPOPRATAPP
    AND AUTOLOAD3  <> :IN_TIPOPRATAPP
    AND AUTOLOAD4  <> :IN_TIPOPRATAPP
    AND AUTOLOAD5  <> :IN_TIPOPRATAPP
    AND AUTOLOAD6  <> :IN_TIPOPRATAPP
    AND AUTOLOAD7  <> :IN_TIPOPRATAPP
    AND AUTOLOAD8  <> :IN_TIPOPRATAPP
    AND AUTOLOAD9  <> :IN_TIPOPRATAPP
    AND AUTOLOAD10 <> :IN_TIPOPRATAPP
    )
    AND OP.TIPO LIKE '%'||:IN_TIPOIMPIANTO||'%'
    AND OP.AGGNUOVOIMPIANTO = 'A'  /* Solo se l'OP è marcata come da aggiungere a specifico apparecchio */
  INTO :OP_CODICE
  DO BEGIN
   
    /* Se l'OP attuale non esiste nell'apparecchio attuale lo aggiunge */
    IF (NOT EXISTS(SELECT OP.ID FROM OPPRATICA OP WHERE OP.IDAPPARECCHIOPRAT = :IN_IDPRATAPP AND OP.IDOP = :OP_CODICE)) THEN
    BEGIN
  
      EXECUTE PROCEDURE OP_PRATAPP_ADD (IN_IDPRATICA, IN_IDPRATAPP, OP_CODICE);  

    END

  END

  /* Exit */
  EXIT;

END^

SET TERM ; ^
