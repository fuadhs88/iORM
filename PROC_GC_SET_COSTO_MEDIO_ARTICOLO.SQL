CREATE PROCEDURE GC_SET_COSTO_MEDIO_ARTICOLO (IN_COD_ART VARCHAR(25), IN_COD_CANT INTEGER, IN_DATA_CANT TIMESTAMP)
AS
  DECLARE VARIABLE loc_costomedio DECIMAL(10,4) DEFAULT 0;
BEGIN
  /* Verifica la validità dei parametri ricevuti */
  IF (IN_COD_ART IS NULL OR IN_COD_ART='' OR IN_COD_CANT IS NULL OR IN_COD_CANT=0) THEN EXIT;

  /* Esegue la procedura per il calcolo del costo medio */
  EXECUTE PROCEDURE GC_CALCOLA_COSTO_MEDIO_ARTICOLO (:IN_COD_ART, :IN_COD_CANT, :IN_DATA_CANT) RETURNING_VALUES :loc_costomedio;

  /* Aggiorna la tabella dei costi medi */
  IF (EXISTS(SELECT CM.CODICEARTICOLO FROM GC_COSTOMEDIO CM WHERE CM.PRATICA=:IN_COD_CANT AND CM.DATAPRATICA=:IN_DATA_CANT AND CM.CODICEARTICOLO=:IN_COD_ART))
  THEN BEGIN
    UPDATE GC_COSTOMEDIO SET GC_COSTOMEDIO = :loc_costomedio
    WHERE PRATICA = :IN_COD_CANT
    AND DATAPRATICA = :IN_DATA_CANT   
    AND CODICEARTICOLO = :IN_COD_ART;
  END ELSE BEGIN
    INSERT INTO GC_COSTOMEDIO
    (PRATICA, DATAPRATICA, CODICEARTICOLO, GC_COSTOMEDIO)
    VALUES
    (:IN_COD_CANT, :IN_DATA_CANT, :IN_COD_ART, :loc_costomedio);
  END
END
