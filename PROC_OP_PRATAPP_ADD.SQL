SET TERM ^ ;

CREATE PROCEDURE OP_PRATAPP_ADD (IN_IDPRATICA INTEGER, IN_IDPRATAPP INTEGER, IN_IDOP VARCHAR(25))
AS

  /* Dati operazione pianificata */
  DECLARE OP_DESCRIZIONE VARCHAR(60);
  DECLARE OP_NOTE VARCHAR(1000);
  DECLARE OP_PERIODICITA INTEGER;
  DECLARE OP_GG_AUTOSEL SMALLINT;
  DECLARE OP_MINUTIPREVISTI INTEGER;

  DECLARE OP_PRZUNIT DECIMAL(15,4);
  DECLARE OP_SCONTO1 NUMERIC(11,4);
  DECLARE OP_SCONTO2 NUMERIC(11,4);
  DECLARE OP_SCONTO3 NUMERIC(11,4);
  DECLARE OP_PRZUNITNETTO DECIMAL(15,4);
  DECLARE OP_CODICEIVA INTEGER;
  DECLARE OP_PRZUNITIVACOMP DECIMAL(15,4);
  DECLARE OP_PRZUNITNETTOIVACOMP DECIMAL(15,4);

  DECLARE OP_ADDEBITA CHAR(1);
  DECLARE OP_INABBONAMENTO CHAR(1);

  /* ID della nuova OP dell'apparecchio */
  DECLARE NEW_ID INTEGER;

BEGIN

  /* Prima di tutto ricava i dati dell'operazione pianificata */
  SELECT OP.DESCRIZIONE, OP.NOTE, OP.PERIODICITA, OP.GG_AUTOSEL, OP.MINUTIPREVISTI, OP.ADDEBITA, OP.INABBONAMENTO,
    OP.PRZUNIT, OP.SCONTO1, OP.SCONTO2, OP.SCONTO3, OP.PRZUNITNETTO, OP.CODICEIVA, OP.PRZUNITIVACOMP, OP.PRZUNITNETTOIVACOMP
  FROM OP
  WHERE OP.CODICE = :IN_IDOP
  INTO :OP_DESCRIZIONE, :OP_NOTE, :OP_PERIODICITA, :OP_GG_AUTOSEL, :OP_MINUTIPREVISTI, :OP_ADDEBITA, :OP_INABBONAMENTO,
       :OP_PRZUNIT, :OP_SCONTO1, :OP_SCONTO2, :OP_SCONTO3, :OP_PRZUNITNETTO, :OP_CODICEIVA, :OP_PRZUNITIVACOMP, :OP_PRZUNITNETTOIVACOMP;

  /* Se non ha trovato l'OP solleva un'eccezione */
  IF (ROW_COUNT = 0) THEN BEGIN
    EXCEPTION EX_GEN_RECORD_NON_TROVATO 'Procedure OP_PRATAPP_ADD: Codice OP non trovato in OP.';
  END

  /* Ricava l'ID del record */
  SELECT GEN_ID(GEN_ID_OPPRATICA,1)
  FROM RDB$DATABASE
  INTO :NEW_ID;

  /* Crea la nuova OP dell'apparecchio specificato */
  INSERT INTO OPPRATICA (
     ID
    ,IDPRATICA
    ,IDAPPARECCHIOPRAT
    ,IDOP
    ,DESCRIZIONE
    ,NOTE
    ,PERIODICITA
    ,GG_AUTOSEL
    ,MINUTIPREVISTI
    ,PRZUNIT
    ,SCONTO1
    ,SCONTO2
    ,SCONTO3
    ,PRZUNITNETTO
    ,CODICEIVA
    ,PRZUNITIVACOMP
    ,PRZUNITNETTOIVACOMP
    ,ADDEBITA
    ,INABBONAMENTO
  ) VALUES (
     :NEW_ID
    ,:IN_IDPRATICA
    ,:IN_IDPRATAPP
    ,:IN_IDOP
    ,:OP_DESCRIZIONE
    ,:OP_NOTE
    ,:OP_PERIODICITA
    ,:OP_GG_AUTOSEL
    ,:OP_MINUTIPREVISTI
    ,:OP_PRZUNIT
    ,:OP_SCONTO1
    ,:OP_SCONTO2
    ,:OP_SCONTO3
    ,:OP_PRZUNITNETTO
    ,:OP_CODICEIVA
    ,:OP_PRZUNITIVACOMP
    ,:OP_PRZUNITNETTOIVACOMP
    ,:OP_ADDEBITA
    ,:OP_INABBONAMENTO
  );

  /* Exit */
  EXIT;

END^

SET TERM ; ^
