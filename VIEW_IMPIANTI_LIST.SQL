
/* View: IMPIANTI_LIST_VIEW, Owner: 1DR0GAT3 */

CREATE VIEW IMPIANTI_LIST_VIEW (

  /* Impianto */
   ID
  ,CODICE
  ,DATAAPERTURA
  ,TIPOIMPIANTO
  ,DESCRIZIONE
  ,CODICECATASTO
  ,RESOURCEID
  ,RESOURCENAME
  ,NOTE
  ,NOTEPRIVATEEXISTS
  ,DATAINSTALLAZIONE

  /* Ubicazione impianto */
  ,INDIRIZZOIMM
  ,ZONAIMM
  ,COMUNEIMM
  ,PROVINCIAIMM
  ,CAPIMM
  ,STR_CERTIFIED_IMM

  /* Appuntamenti */
  ,DATAULTIMOINTERVENTO
  ,DATAULTIMAMANUTENZIONE
  ,PROXVISITAENTRO
  ,PERIODICITA
  ,DATAORAPROSSIMOAPPUNTAMENTO

  /* Contratto */
  ,CONTRATTO_STATO
  ,COMPUTED_CONTRATTO_SCADUTO
  ,CONTRATTO_TIPO
  ,CONTRATTO_IMPORTO
  ,CONTRATTO_IMPORTONETTO
  ,CONTRATTO_IMPORTONETTOIVACOMP
  ,CONTRATTO_VALIDITA_FINE
  ,CONTRATTO_DISDETTA_RICEVUTA

  /* Responsabile impianto */
  ,CODICERESPIMP
  ,RIFRESPIMP
  ,INQUALITADIRESPIMP
  ,TELEFONORESPIMP
  ,CELLULARERESPIMP

  /* Proprietario */
  ,CODICEPROP
  ,RIFPROP
  ,TELEFONOPROP
  ,CELLULAREPROP

  /* Utente occupante */
  ,CODICEUT
  ,RIFUT
  ,TELEFONOUT
  ,CELLULAREUT

  /* Ammministratore */
  ,CODICEINST
  ,RIFINST
  ,TELEFONOINST
  ,CELLULAREINST

  /* Flags */
  ,EXIST_PRESCRIZIONI
  ,EXIST_URGENTI
  ,EXIST_CHIAMATE
  ,EXIST_ALLEGATITOSEND
  ,EXIST_RIFDOC_CORRISPNOPAG
  ,EXIST_SCADSOFF

  /* Highlights */
  ,HIGHLIGHTs

) AS

SELECT

  /* Impianto */
   P.ID
  ,P.CODICE
  ,P.DATAAPERTURA
  ,P.TIPOIMPIANTO
  ,P.DESCRIZIONE
  ,P.CODICECATASTO
  ,TEC.RESOURCEID
  ,TEC.RESOURCENAME
  ,P.NOTE
  ,CAST((CASE WHEN (TRIM(COALESCE(P.NOTEPRIVATE,'')) <> '') THEN 'T' ELSE 'F' END) AS CHAR(1)) AS NOTEPRIVATEEXISTS
  ,P.DATAINSTALLAZIONE 

  /* Ubicazione impianto */
  ,CAST(TRIM(P.INDIRIZZOIMM || ' ' || COALESCE(P.NUMCIVICOIMM,'')) AS VARCHAR(120)) AS INDIRIZZOIMM
  ,P.ZONAIMM
  ,P.COMUNEIMM
  ,P.PROVINCIAIMM
  ,P.CAPIMM
  ,(SELECT OUTVAR FROM STRADARIO_CERTIFICATO(P.CODICEISTATCOMUNEIMM,P.COMUNEIMM,P.INDIRIZZOIMM,P.PROVINCIAIMM))


  /* Appuntamenti */
  ,(SELECT MAX(I.DATAORAINTERVENTO) FROM IMPEGNI I WHERE I.PRATICA = P.CODICE AND I.DATAPRATICA1 = P.DATAAPERTURA AND I.TIPOIMPEGNO = 'Intervento') AS DATAULTIMOINTERVENTO
  ,(SELECT MAX(I.DATAORAINTERVENTO) FROM IMPEGNI I WHERE I.PRATICA = P.CODICE AND I.DATAPRATICA1 = P.DATAAPERTURA AND I.TIPOIMPEGNO = 'Intervento' AND (I.TIPOINTERVENTO LIKE '%12:Manutenzione%' OR I.TIPOINTERVENTO LIKE '%8:Collaudo%')) AS DATAULTIMAMANUTENZIONE
  ,P.PROXVISITAENTRO
  ,P.PERIODICITA
  ,(SELECT MIN(I.START_EVENT) FROM IMPEGNI I WHERE I.PRATICA = P.CODICE AND I.DATAPRATICA1 = P.DATAAPERTURA AND I.TIPOIMPEGNO = 'Appuntamento') AS DATAORAPROSSIMOAPPUNTAMENTO

  /* Contratto */
  ,P.CONTRATTO_STATO
  ,P.COMPUTED_CONTRATTO_SCADUTO
  ,P.CONTRATTO_TIPO
  ,COALESCE(P.CONTRATTO_IMPORTO,0) AS CONTRATTO_IMPORTO
  ,COALESCE(P.CONTRATTO_IMPORTONETTO,0) AS CONTRATTO_IMPORTONETTO
  ,COALESCE(P.CONTRATTO_IMPORTONETTOIVACOMP,0) AS CONTRATTO_IMPORTONETTOIVACOMP
  ,P.CONTRATTO_VALIDITA_FINE
  ,P.CONTRATTO_DISDETTA_RICEVUTA

  /* Responsabile impianto */
  ,P.CODICERESPIMP
  ,CASE
     WHEN (COALESCE(P.CODICERESPIMP,0)=0) THEN CAST(NULL AS VARCHAR(80))
     ELSE CAST(P.RAGSOCRESPIMP || '  (' || P.CODICERESPIMP || ')' AS VARCHAR(80))
   END
  ,CASE
     WHEN (COALESCE(P.CODICERESPIMP,0)=0) THEN CAST(NULL AS VARCHAR(20))
     ELSE P.INQUALITADIRESPIMP
   END
  ,P.TELEFONORESPIMP
  ,P.CELLULARERESPIMP

  /* Proprietario */
  ,P.CLIENTE AS CODICEPROP
  ,CASE
     WHEN (COALESCE(P.CLIENTE,0)=0) THEN CAST(NULL AS VARCHAR(80))
     ELSE CAST(P.RAGSOCCLI || '  (' || P.CLIENTE || ')' AS VARCHAR(80))
   END
  ,P.TELEFONOCLI
  ,P.CELLULARECLI

  /* Utente occupante */
  ,P.CODICEUT
  ,CASE
     WHEN (COALESCE(P.CODICEUT,0)=0) THEN CAST(NULL AS VARCHAR(80))
     ELSE CAST(P.RAGSOCUT || '  (' || P.CODICEUT || ')' AS VARCHAR(80))
   END
  ,P.TELEFONOUT
  ,P.CELLULAREUT

  /* Ammministratore */
  ,P.CODICEINST
  ,CASE
     WHEN (COALESCE(P.CODICEINST,0)=0) THEN CAST(NULL AS VARCHAR(80))
     ELSE CAST(P.RAGSOCINST || '  (' || P.CODICEINST || ')' AS VARCHAR(80))
   END
  ,P.TELEFONOINST
  ,P.CELLULAREINST

  /* Flags */
  ,(SELECT OUTVAL FROM IMPIANTI_PRESCRIZ_EXISTS(P.CODICE, P.DATAAPERTURA)) 	 AS EXISTS_PRESCRIZIONI
  ,(SELECT OUTVAL FROM IMPIANTI_URGENTI_EXISTS(P.CODICE, P.DATAAPERTURA))        AS EXISTS_URGENTI
  ,(SELECT OUTVAL FROM IMPIANTI_CHIAMATE_EXISTS(P.CODICE, P.DATAAPERTURA))       AS EXISTS_CHIAMATE
  ,(SELECT OUTVAL FROM IMPIANTI_ALLEGATITOSEND_EXISTS(P.CODICE, P.DATAAPERTURA)) AS EXISTS_ALLEGATITOSEND
  ,(SELECT OUTVAL FROM IMPIANTI_CORRISPNOPAG_EXISTS(P.CODICE, P.DATAAPERTURA)) 	 AS EXIST_RIFDOC_CORRISPNOPAG
  ,(SELECT OUTVAL FROM IMPIANTI_SCADSOFF_EXISTS(P.CODICE, P.DATAAPERTURA)) 	 AS EXIST_SCADSOFF

  /* Dati primo apparecchio che trova (solo per impianti con 1 apparecchio) */
  ,(SELECT OUTVAL FROM IMPIANTI_HIGHLIGHTS(P.ID)) AS HIGHLIGHTS

FROM PRATICHE P
LEFT JOIN TECNICI TEC ON (TEC.RESOURCEID=P.RESOURCEID)
WHERE P.TIPO = 'A'
;