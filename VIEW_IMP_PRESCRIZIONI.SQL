
/* View: IMP_PRESCRIZIONI_VIEW, Owner: 1DR0GAT3 */

CREATE VIEW IMP_PRESCRIZIONI_VIEW (
  UNIQUEKEYFIELD,
  TIPORECORD,
  IDIMPEGNO,
  IDALLEGATO,
  IDAPPARECCHIOPRAT,
  CLIENTE,
  PRATICA,
  DATAPRATICA1,
  IDPRATICA,
  TIPODOC,
  REGDOC,
  NUMDOC,
  DATADOC,
  CODICE,
  DESCRIZIONE,
  FATTO,
  FATTO_DATA,
  FATTO_NOTE,
  TECNICO_ID,
  TECNICO_NOME
) AS


/*======================================================
SEZIONE RACCOMANDAZIONI INTERVENTO: IMPEGNO
======================================================*/
SELECT
 CAST('RACC.INT.' || I.MASTER_ID  AS VARCHAR(100)) AS UNIQUEKEYFIELD
,CAST('10-RACCOMANDAZIONI INT.' AS VARCHAR(25)) AS TIPORECORD
,I.ID
,CAST(NULL AS INTEGER) AS IDALLEGATO
,CAST(NULL AS INTEGER) AS IDAPPARECCHIOPRAT
,I.CLIENTE
,I.PRATICA
,I.DATAPRATICA1
,I.IDPRATICA
,I.TIPOIMPEGNO
,I.REGISTRO
,I.ID
,I.DATAORAINTERVENTO
,CAST('Raccomandazioni interv.' AS VARCHAR(25)) AS CODICE
,CAST(I.RACCOMANDAZIONI AS VARCHAR(5000)) AS DESCRIZIONE
,I.RACCOMANDAZIONI_FATTO
,I.RACCOMANDAZIONI_FATTO_DATA
,I.RACCOMANDAZIONI_FATTO_NOTE
,I.RESOURCEID
,TECN.RESOURCENAME
FROM IMPEGNI I
LEFT JOIN TECNICI TECN ON (TECN.RESOURCEID = I.RESOURCEID)
WHERE I.TIPOIMPEGNO = 'Intervento'
  AND I.RACCOMANDAZIONI_FATTO <> 'T'
  AND I.RACCOMANDAZIONI IS NOT NULL
  AND TRIM(I.RACCOMANDAZIONI) <> ''

/* ================================================== */

UNION ALL

/*======================================================
SEZIONE PRESCRIZIONI INTERVENTO: IMPEGNO
======================================================*/
SELECT
 CAST('PRESC.INT.' || I.MASTER_ID  AS VARCHAR(100)) AS UNIQUEKEYFIELD
,CAST('20-PRESCRIZIONI INT.' AS VARCHAR(25)) AS TIPORECORD
,I.ID
,CAST(NULL AS INTEGER) AS IDALLEGATO
,CAST(NULL AS INTEGER) AS IDAPPARECCHIOPRAT
,I.CLIENTE
,I.PRATICA
,I.DATAPRATICA1
,I.IDPRATICA
,I.TIPOIMPEGNO
,I.REGISTRO
,I.ID
,I.DATAORAINTERVENTO
,CAST('Prescrizioni interv.' AS VARCHAR(25)) AS CODICE
,CAST(I.PRESCRIZIONI AS VARCHAR(5000)) AS DESCRIZIONE
,I.PRESCRIZIONI_FATTO
,I.PRESCRIZIONI_FATTO_DATA
,I.PRESCRIZIONI_FATTO_NOTE
,I.RESOURCEID
,TECN.RESOURCENAME
FROM IMPEGNI I
LEFT JOIN TECNICI TECN ON (TECN.RESOURCEID = I.RESOURCEID)
WHERE I.TIPOIMPEGNO = 'Intervento'
  AND I.PRESCRIZIONI_FATTO <> 'T'
  AND I.PRESCRIZIONI IS NOT NULL
  AND TRIM(I.PRESCRIZIONI) <> ''

/* ================================================== */

UNION ALL

/*======================================================
SEZIONE RACCOMANDAZIONI ALLEGATI: ALLEGATI
======================================================*/
SELECT
 CAST('RACC.ALL.' || A.ID  AS VARCHAR(100)) AS UNIQUEKEYFIELD
,CAST('30-RACCOMANDAZIONI ALL' AS VARCHAR(25)) AS TIPORECORD
,I.ID
,A.ID AS IDALLEGATO
,A.GENCAL_ID
,I.CLIENTE
,I.PRATICA
,I.DATAPRATICA1
,I.IDPRATICA
,I.TIPOIMPEGNO
,I.REGISTRO
,I.ID
,I.DATAORAINTERVENTO
,CAST('Raccomandazioni allegato' AS VARCHAR(25)) AS CODICE
,CAST(A.RACCOMANDAZIONI AS VARCHAR(5000)) AS DESCRIZIONE
,A.RACCOMANDAZIONI_FATTO
,A.RACCOMANDAZIONI_FATTO_DATA
,A.RACCOMANDAZIONI_FATTO_NOTE
,I.RESOURCEID
,TECN.RESOURCENAME
FROM IMPEGNI I
JOIN ALLEGATI_MANUT A ON (A.IDIMPEGNO = I.MASTER_ID)
LEFT JOIN TECNICI TECN ON (TECN.RESOURCEID = I.RESOURCEID)
WHERE I.TIPOIMPEGNO = 'Intervento'
  AND A.RACCOMANDAZIONI_FATTO <> 'T'
  AND A.RACCOMANDAZIONI IS NOT NULL
  AND TRIM(A.RACCOMANDAZIONI) <> ''

/* ================================================== */

UNION ALL

/*======================================================
SEZIONE PRESCRIZIONI ALLEGATI: ALLEGATI
======================================================*/
SELECT
 CAST('PRESC.ALL.' || A.ID  AS VARCHAR(100)) AS UNIQUEKEYFIELD
,CAST('40-PRESCRIZIONI ALL' AS VARCHAR(25)) AS TIPORECORD
,I.ID
,A.ID AS IDALLEGATO
,A.GENCAL_ID
,I.CLIENTE
,I.PRATICA
,I.DATAPRATICA1
,I.IDPRATICA
,I.TIPOIMPEGNO
,I.REGISTRO
,I.ID
,I.DATAORAINTERVENTO
,CAST('Prescrizioni allegato' AS VARCHAR(25)) AS CODICE
,CAST(A.PRESCRIZIONI AS VARCHAR(5000)) AS DESCRIZIONE
,A.PRESCRIZIONI_FATTO
,A.PRESCRIZIONI_FATTO_DATA
,A.PRESCRIZIONI_FATTO_NOTE
,I.RESOURCEID
,TECN.RESOURCENAME
FROM IMPEGNI I
JOIN ALLEGATI_MANUT A ON (A.IDIMPEGNO = I.MASTER_ID)
LEFT JOIN TECNICI TECN ON (TECN.RESOURCEID = I.RESOURCEID)
WHERE I.TIPOIMPEGNO = 'Intervento'
  AND A.PRESCRIZIONI_FATTO <> 'T'
  AND A.PRESCRIZIONI IS NOT NULL
  AND TRIM(A.PRESCRIZIONI) <> ''

/* ================================================== */
;