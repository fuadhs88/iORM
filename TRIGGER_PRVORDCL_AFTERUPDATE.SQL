SET TERM ^ ;

CREATE TRIGGER PRVORDCL_AFTERUPDATE FOR PRVORDCL
ACTIVE AFTER UPDATE POSITION 0
AS
BEGIN

  /* Aggiorna i dati dedettagli della fattura elettronica */
  UPDATE PRVORDCL_FE FE SET 
     FE.TIPODOC	= NEW.TIPODOCUMENTO
    ,FE.REGDOC	= NEW.REGISTRO
    ,FE.NUMDOC	= NEW.NUMORDPREV
    ,FE.DATADOC	= NEW.DATADOCUMENTO
  WHERE FE.TIPODOC = OLD.TIPODOCUMENTO
    AND FE.REGDOC  = OLD.REGISTRO
    AND FE.NUMDOC  = OLD.NUMORDPREV
    AND FE.DATADOC = OLD.DATADOCUMENTO;

  /* Aggiorna le eventuali scadenze */
/* NB: Eliminata perchè è stato aggiunta la rigenerazione delle scadenze direttamente in Levante se i dati cambiano */  
/*UPDATE SCADENZ S SET 
     S.TIPODOC	= NEW.TIPODOCUMENTO
    ,S.REGISTRO	= NEW.REGISTRO
    ,S.NUMDOC	= NEW.NUMORDPREV
    ,S.DATADOC	= NEW.DATADOCUMENTO
  WHERE S.TIPODOC = OLD.TIPODOCUMENTO
    AND S.REGISTRO  = OLD.REGISTRO
    AND S.NUMDOC  = OLD.NUMORDPREV
    AND S.DATADOC = OLD.DATADOCUMENTO;*/

  /* Aggiorna i dati degli allegati del documento */
  UPDATE ALLEGATI A SET 
     A.CODSOGG	= CASE WHEN (A.TIPODOC=OLD.TIPODOCUMENTO AND A.REGDOC=OLD.REGISTRO AND A.NUMDOC=OLD.NUMORDPREV AND A.DATADOC=OLD.DATADOCUMENTO) THEN NEW.CODICECLIENTE ELSE A.CODSOGG END
    ,A.CODPRAT	= CASE WHEN (A.TIPODOC=OLD.TIPODOCUMENTO AND A.REGDOC=OLD.REGISTRO AND A.NUMDOC=OLD.NUMORDPREV AND A.DATADOC=OLD.DATADOCUMENTO) THEN NEW.PRATICA ELSE A.CODPRAT END
    ,A.DATAPRAT	= CASE WHEN (A.TIPODOC=OLD.TIPODOCUMENTO AND A.REGDOC=OLD.REGISTRO AND A.NUMDOC=OLD.NUMORDPREV AND A.DATADOC=OLD.DATADOCUMENTO) THEN NEW.DATAPRATICA1 ELSE A.DATAPRAT END
    ,A.TIPODOC	= NEW.TIPODOCUMENTO
    ,A.REGDOC	= NEW.REGISTRO
    ,A.NUMDOC	= NEW.NUMORDPREV
    ,A.DATADOC 	= NEW.DATADOCUMENTO
  WHERE A.TIPODOC = OLD.TIPODOCUMENTO
    AND A.REGDOC  = OLD.REGISTRO
    AND A.NUMDOC  = OLD.NUMORDPREV
    AND A.DATADOC = OLD.DATADOCUMENTO;

END^

SET TERM ; ^
