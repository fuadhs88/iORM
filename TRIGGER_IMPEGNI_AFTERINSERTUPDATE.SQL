CREATE TRIGGER IMPEGNI_AFTERINSERTUPDATE FOR IMPEGNI
ACTIVE AFTER INSERT OR UPDATE
AS
BEGIN

  /* Aggiorna la Data e l'ora di inizio e fine del controllo negli allegati F/G */
  UPDATE ALLEGATI_MANUT AM SET
    AM.DATACONTROLLO   = NEW.DATAORAINTERVENTO,
    AM.DATAORAARRIVO   = NEW.DATAORAINTERVENTO,
    AM.DATAORAPARTENZA = NEW.DATAORAFINEINTERVENTO
  WHERE AM.IDIMPEGNO = OLD.MASTER_ID
    AND COALESCE(AM.DATAORADAIMPEGNO,'F') <> 'F';

  /* Aggiorna il tecnico degli allegati relativi all'impegno */
  EXECUTE PROCEDURE IMP_AGGIORNA_TECNICO_ALL(OLD.MASTER_ID, NEW.RESOURCEID);

  /* Se in intervento di collaudo aggiorna la data di collaudo degli apparecchi ovviamente solo se è riferito ad un impianto */
  IF (NEW.TIPOIMPEGNO = 'Intervento' AND NEW.TIPOINTERVENTO LIKE '%Collaudo%' AND COALESCE(NEW.IDPRATICA,0) <> 0) THEN
  BEGIN
    UPDATE PRATAPPARECCHI PA SET
    PA.DATACOLLAUDO = NEW.DATAORAINTERVENTO
    WHERE PA.IDPRATICA = NEW.IDPRATICA
      AND PA.DATACOLLAUDO IS NULL;
  END

END
