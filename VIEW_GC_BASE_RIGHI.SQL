/* 
   =================================================
   Vista che fornisce il primo step di dati per il GC
   ed esattamente i dati grezzi dei righi con già i ricarichi
   e i campi personalizzabili (deroghe) in base alla scelta
   del ricarico voluto sul cantiere (ricarico fisso, ricarico
   come da listino 1..4 eventualmente anche con i ricarichi
   per fasce di prezzo.
   =================================================
*/

CREATE VIEW GC_BASE_RIGHI
(
   TipoDocumento
  ,NumOrdPrev
  ,Registro
  ,DATADOCUMENTO
  ,PROGRIGO
  ,PROGRIGO2
  ,CAUSALE
  ,CODICECLIENTE

  ,PRATICA
  ,DATAPRATICA1
  ,DATACHIUSURAPRATICA1
  ,STATODESCRIZIONEPRATICA1
  ,RIFPRATICA
  ,CODSOGGPRAT
  ,PRAT_PRZUNITOPERA1_1
  ,PRAT_PRZUNITOPERA1_2
  ,PRAT_PRZUNITOPERA1_3
  ,PRAT_PRZUNITOPERA1_4
  ,PRAT_PRZUNITOPERA1_5
  ,PRAT_TIPORICARICO
  ,PRAT_TIPORICDACOMMESSA
  ,PRAT_TIPOCOSTO
  ,PRAT_RICARICOPERC
  ,PRAT_LISTINO
  ,OPERAINDEX
  ,OPERACODICE
  ,OPERADESCRIZIONE

  ,GUID
  ,GUID_REF
  ,GUID_ANCESTOR
  ,TRACK_PREVENTIVO
  ,TRACK_COMMESSA
  ,TRACK_DDT
  ,TRACK_FATTURA
  ,TRACK_ESTRATTO_CONTO
  ,TRACK_SAL
  ,TRACK_BOLLA_ENTR
  ,TRACK_FATT_ACQUI
  ,TRACK_ORD_FORN

  ,SEGNOOPERAZIONECANTIERE
  ,SEGNOOPERAZIONE
  ,GC_SEZIONE
  ,STATODESCRIZIONE
  ,STATOFOREGROUND

  ,DOCUMENTO
  ,SOGGETTO

  ,CodiceMagazzino
  ,MovMag
  ,CodiceArticolo
  ,Descrizione
  ,PrezzoUnitario
  ,UnitaDiMisura
  ,Qta
  ,ScontoRigo
  ,ScontoRigo2
  ,ScontoRigo3
  ,ImportoRigo
  ,PREZZOACQUISTOARTICOLO
  ,IMPORTOACQUISTOARTICOLO
  ,NOTERIGO
  ,MARGINE
  ,PrezzoUnitarioNetto
  ,CodiceIVA
  ,DescrizioneIVA
  ,AliquotaIVA

  ,SOTTOCANTIERE1
  ,SOTTOCANTIERE2
  ,SOTTOCANTIERE3
  ,SOTTOCANTIERE4
  ,SOTTOCANTIERE5
  ,SOTTOCANTIERE6

  ,CATEGCANT1
  ,CATEGCANT2
  ,CATEGCANT3
  ,CATEGCANT4
  ,CATEGCANT5
  ,CATEGCANT6

  ,S3RIF
  ,S3UBICAZIONE
  ,S3COMPONENTE
  ,S3MATERIALE
  ,S3QTA
  ,S3DIAMETRO
  ,S3LUNGHEZZA
  ,S3INSTALLAZIONE
  ,S3CERTIFICAZIONE
  ,S3VENTILAZIONE
  ,S3SCARICO
  ,S3TIPO
  ,S3PORTATATERMICA
  ,S3TIPOCOLLEGAMENTO
  ,S3INSTALLATOINSTALLABILE
  ,S3MODELLO

  ,TIPOLOGIA

  ,GC_COSTONETTOUNITARIO_MOD
  ,GC_COSTONETTOUNITARIO

  ,GC_RICARICO_MOD
  ,GC_RICARICO

  ,GC_QTA_MOD
  ,GC_QTA

  ,GC_DESCRIZIONE_MOD
  ,GC_DESCRIZIONE
)

AS


/* =================================================
   |   RIGHI DOCUMENTI - MATERIALI/APPARECCHI      |
   =================================================
*/
SELECT

   R.TipoDocumento
  ,R.NumOrdPrev
  ,R.Registro
  ,R.DATADOCUMENTO
  ,R.PROGRIGO
  ,R.PROGRIGO2
  ,T.CAUSALE
  ,R.CODICECLIENTE

  ,R.PRATICA
  ,R.DATAPRATICA1
  ,P.DATACHIUSURA
  ,P.STATODESCRIZIONE
  ,CAST(  SUBSTRING(  (CASE P.TIPO WHEN 'A' THEN P.COSTRUTTORE||' '||P.MODELLO ELSE P.DESCRIZIONE END) || '  (' || R.PRATICA || ', ' || R.DATAPRATICA1 || ')' FROM 1 FOR 200) AS VARCHAR(200))
  ,P.CLIENTE AS CODSOGGPRAT

  ,COALESCE(P.PRZUNITOPERA1_1, 0)
  ,COALESCE(P.PRZUNITOPERA1_2, 0)
  ,COALESCE(P.PRZUNITOPERA1_3, 0)
  ,COALESCE(P.PRZUNITOPERA1_4, 0)
  ,COALESCE(P.PRZUNITOPERA1_5, 0)
  ,P.TIPORICARICO
  ,P.TIPORICARICOCOMEDACOMMESSA
  ,P.TIPOCOSTO
  ,P.RICARICOPERC
  ,P.LISTINO



  /*
     ----- In caso il rigo sia un rigo principale di manodopera simula i campi necessari a far       -----
     -----  gestire correttamente il rigo nella Tipologia opportuna, praticamente lo fa assomigliare -----
     -----  ad un dettaglio di manodopera                                                            -----
  */
  ,CASE
     WHEN ((SELECT * FROM GC_ISMANODOPERA(R.CODICEARTICOLO)) = 'F') THEN CAST(NULL AS INTEGER)
     ELSE (SELECT * FROM GC_CODART_TO_OPERAINDEX(R.CODICEARTICOLO))
   END
  ,CASE
     WHEN ((SELECT * FROM GC_ISMANODOPERA(R.CODICEARTICOLO)) = 'F') THEN CAST(NULL AS VARCHAR(15))
     ELSE CAST(R.CODICEARTICOLO AS VARCHAR(15))
   END
  ,CASE
     WHEN ((SELECT * FROM GC_ISMANODOPERA(R.CODICEARTICOLO)) = 'F') THEN CAST(NULL AS VARCHAR(45))
     ELSE (SELECT * FROM GC_CODART_TO_OPERADESCRIZIONE(R.CODICEARTICOLO))
   END


  ,R.GUID
  ,R.GUID_REF
  ,R.GUID_ANCESTOR

  ,(SELECT * FROM GC_TRACK_DOC('Preventivo', R.GUID_REF)) AS TRACK_PREVENTIVO
  ,(SELECT * FROM GC_TRACK_DOC('Commessa', R.GUID_REF)) AS TRACK_COMMESSA
  ,(SELECT * FROM GC_TRACK_DOC('D.D.T.', R.GUID_REF)) AS TRACK_DDT
  ,(SELECT * FROM GC_TRACK_DOC('Fattura', R.GUID_REF)) AS TRACK_FATTURA
  ,(SELECT * FROM GC_TRACK_DOC('Estratto_conto', R.GUID_REF)) AS TRACK_ESTRATTO_CONTO
  ,(SELECT * FROM GC_TRACK_DOC('S.A.L.', R.GUID_REF)) AS TRACK_SAL
  ,(SELECT * FROM GC_TRACK_DOC('Bolla_entr', R.GUID_REF)) AS TRACK_BOLLA_ENTR
  ,(SELECT * FROM GC_TRACK_DOC('Fatt.acqui', R.GUID_REF)) AS TRACK_FATT_ACQUI
  ,(SELECT * FROM GC_TRACK_DOC('Ord.fornit', R.GUID_REF)) AS TRACK_ORD_FORN
/*
  ,CAST(NULL AS VARCHAR(50)) AS TRACK_PREVENTIVO
  ,CAST(NULL AS VARCHAR(50)) AS TRACK_COMMESSA
  ,CAST(NULL AS VARCHAR(50)) AS TRACK_DDT
  ,CAST(NULL AS VARCHAR(50)) AS TRACK_FATTURA
  ,CAST(NULL AS VARCHAR(50)) AS TRACK_ESTRATTO_CONTO
  ,CAST(NULL AS VARCHAR(50)) AS TRACK_SAL
  ,CAST(NULL AS VARCHAR(50)) AS TRACK_BOLLA_ENTR
  ,CAST(NULL AS VARCHAR(50)) AS TRACK_FATT_ACQUI
  ,CAST(NULL AS VARCHAR(50)) AS TRACK_ORD_FORN
*/



  ,R.SEGNOOPERAZIONECANTIERE
  ,R.MOVMAG AS SEGNOOPERAZIONE
  ,CAST(
     CASE
       WHEN ((R.SEGNOOPERAZIONECANTIERE='+') OR (R.SEGNOOPERAZIONECANTIERE='-')) THEN 'Giacenza'
       WHEN (R.SEGNOOPERAZIONECANTIERE='C') THEN 'Commessa'
       WHEN (R.SEGNOOPERAZIONECANTIERE='M') THEN 'Montato'
       WHEN (R.SEGNOOPERAZIONECANTIERE='F') THEN 'Fatturato'
       WHEN (R.SEGNOOPERAZIONECANTIERE='D') THEN 'D.D.T.'
       ELSE '- - -'
     END
   AS VARCHAR(20)) AS GC_SEZIONE
  ,T.STATODESCRIZIONE
  ,T.STATOFOREGROUND

  ,CAST(  SUBSTRING(  R.TipoDocumento || ' ' || R.NumOrdPrev || R.Registro || ' del ' || R.DataDocumento FROM 1 FOR 200) AS VARCHAR(200)) AS DOCUMENTO
  ,CAST(  SUBSTRING(  R.CodiceCliente || ' - ' || T.RagSocCli FROM 1 FOR 200) AS VARCHAR(200)) AS SOGGETTO

  ,R.CodiceMagazzino
  ,R.MovMag
  ,R.CODICEARTICOLO
  ,R.Descrizione
  ,R.PrezzoUnitario
  ,R.UnitaDiMisura
  ,R.Qta
  ,R.ScontoRigo
  ,R.ScontoRigo2
  ,R.ScontoRigo3
  ,R.ImportoRigo
  ,R.PREZZOACQUISTOARTICOLO
  ,CAST(R.PREZZOACQUISTOARTICOLO * R.QTA   AS NUMERIC(11,4)) AS IMPORTOACQUISTOARTICOLO
  ,CAST(R.NOTERIGO AS VARCHAR(1000))
  ,CAST(R.MARGINE AS DECIMAL(15,4))

  ,CASE
     WHEN (COALESCE(R.QTA,0) <> 0) THEN CAST(R.IMPORTORIGO / R.QTA AS NUMERIC(11,4))
     ELSE 0
   END AS PREZZOUNITARIONETTO

  ,R.CODICEIVA
  ,R.DESCRIZIONEIVA
  ,R.ALIQUOTAIVA

  ,COALESCE(R.SOTTOCANTIERE1, '') AS SOTTOCANTIERE1
  ,COALESCE(R.SOTTOCANTIERE2, '') AS SOTTOCANTIERE2
  ,COALESCE(R.SOTTOCANTIERE3, '') AS SOTTOCANTIERE3
  ,COALESCE(R.SOTTOCANTIERE4, '') AS SOTTOCANTIERE4
  ,COALESCE(R.SOTTOCANTIERE5, '') AS SOTTOCANTIERE5
  ,COALESCE(R.SOTTOCANTIERE6, '') AS SOTTOCANTIERE6

  ,COALESCE(P.CATEGCANT1, '') AS CATEGCANT1
  ,COALESCE(P.CATEGCANT2, '') AS CATEGCANT2
  ,COALESCE(P.CATEGCANT3, '') AS CATEGCANT3
  ,COALESCE(P.CATEGCANT4, '') AS CATEGCANT4
  ,COALESCE(P.CATEGCANT5, '') AS CATEGCANT5
  ,COALESCE(P.CATEGCANT6, '') AS CATEGCANT6

  ,R.S3RIF
  ,R.S3UBICAZIONE
  ,R.S3COMPONENTE
  ,R.S3MATERIALE
  ,R.S3QTA
  ,R.S3DIAMETRO
  ,R.S3LUNGHEZZA
  ,R.S3INSTALLAZIONE
  ,R.S3CERTIFICAZIONE
  ,R.S3VENTILAZIONE
  ,R.S3SCARICO
  ,R.S3TIPO
  ,R.S3PORTATATERMICA
  ,R.S3TIPOCOLLEGAMENTO
  ,R.S3INSTALLATOINSTALLABILE
  ,R.S3MODELLO



  /*
     ----- In caso il rigo sia un rigo principale di manodopera simula i campi necessari a far       -----
     -----  gestire correttamente il rigo nella Tipologia opportuna, praticamente lo fa assomigliare -----
     -----  ad un dettaglio di manodopera                                                            -----
  */
  ,CASE
     WHEN ((SELECT * FROM GC_ISMANODOPERA(R.CODICEARTICOLO)) = 'F') THEN CAST('Materiali / Apparecchi' AS VARCHAR(60))
     ELSE CAST('Manodopera' AS VARCHAR(60))
   END



  /* ---------- COSTO NETTO UNITARIO ---------- */
  ,COALESCE(R.GC_COSTONETTOUNITARIO_MOD, 'F')
  ,CASE
     WHEN (R.GC_COSTONETTOUNITARIO_MOD='T') THEN COALESCE(R.GC_COSTONETTOUNITARIO,0)
     ELSE COALESCE(R.PREZZOACQUISTOARTICOLO,0)
   END AS GC_COSTONETTOUNITARIO

  /* ---------- RICARICO ---------- */
  ,COALESCE(R.GC_RICARICO_MOD, 'F')
  ,CASE
     WHEN (R.GC_RICARICO_MOD='T') AND (R.SEGNOOPERAZIONECANTIERE <> 'F') AND (R.SEGNOOPERAZIONECANTIERE <> 'C')   THEN COALESCE(R.GC_RICARICO,0)
     WHEN (P.TIPORICARICO=0)      AND (R.SEGNOOPERAZIONECANTIERE <> 'F') AND (R.SEGNOOPERAZIONECANTIERE <> 'C')   THEN COALESCE(P.RICARICOPERC,0)
     WHEN (P.TIPORICARICO=1)      AND (R.SEGNOOPERAZIONECANTIERE <> 'F') AND (R.SEGNOOPERAZIONECANTIERE <> 'C')   THEN (SELECT * FROM GC_GET_RICARICO(R.CODICEARTICOLO,     (CASE WHEN (R.GC_COSTONETTOUNITARIO_MOD='T') THEN R.GC_COSTONETTOUNITARIO ELSE R.PREZZOACQUISTOARTICOLO END),     P.LISTINO))
     ELSE COALESCE(R.MARGINE,0)
   END AS GC_RICARICO

  /* ---------- QTA ---------- */
  ,COALESCE(R.GC_QTA_MOD, 'F')
  ,CASE
     WHEN (R.GC_QTA_MOD='T') THEN COALESCE(R.GC_QTA,0)
     ELSE COALESCE(R.QTA,0)
   END AS GC_QTA

  /* ---------- DESCRIZIONE ---------- */
  ,COALESCE(R.GC_DESCRIZIONE_MOD, 'F')
  ,CASE
     WHEN (R.GC_DESCRIZIONE_MOD='T') THEN COALESCE(R.GC_DESCRIZIONE,'')
     ELSE COALESCE(R.DESCRIZIONE,0)
   END AS GC_DESCRIZIONE



FROM RIGHIPRV R
LEFT JOIN PRVORDCL T ON (T.TipoDocumento = R.TipoDOcumento  AND T.Registro = R.Registro  AND T.NumOrdPrev = R.NumOrdPrev  AND T.DataDocumento = R.DataDocumento)
LEFT JOIN PRATICHE P ON (P.TIPO='P' AND P.CODICE=R.PRATICA AND P.DATAAPERTURA=R.DATAPRATICA1)

WHERE R.SEGNOOPERAZIONECANTIERE<>'=' AND R.SEGNOOPERAZIONECANTIERE IS NOT NULL AND R.SEGNOOPERAZIONECANTIERE<>''
AND COALESCE(R.CODICEIVA,1)<>-9   /* ATTENZIONE!!! lasciare questo coalesce perchè altrimenti non visualizza i righi aggiunti al volo sul GC */
AND ((SELECT * FROM GC_IS_RIGOPRV_DA_VISUALIZZARE(R.CODICEARTICOLO, R.TIPODOCUMENTO, R.NUMORDPREV, R.REGISTRO, R.DATADOCUMENTO, R.PROGRIGO, R.SEGNOOPERAZIONECANTIERE)) = 'T')
/* ================================================= */


UNION ALL


/* =================================================
   |   RAPGIORNRIGHI - MANODOPERA ORE              |
   =================================================
*/
SELECT

  CAST(ORE.TIPODOC AS VARCHAR(25)) AS TIPODOCUMENTO
 ,CAST(ORE.NUMDOC AS INTEGER) AS NUMORDPREV
 ,CAST(ORE.REGISTRO AS VARCHAR(5)) AS REGISTRO
 ,CAST(ORE.DATADOC AS TIMESTAMP) AS DATADOCUMENTO
 ,CAST(ORE.NUMRIGO AS INTEGER) AS PROGRIGO
 ,CAST(ORE.NUMRIGO2 AS INTEGER) AS PROGRIGO2
 ,CAST(NULL AS VARCHAR(40)) AS CAUSALE
 ,ORE.CODSOGGETTO AS CODICECLIENTE

 ,ORE.CODCANTIERE
 ,ORE.DATACANTIERE
 ,P.DATACHIUSURA
 ,P.STATODESCRIZIONE
 ,CAST(  SUBSTRING(  (CASE P.TIPO WHEN 'A' THEN P.COSTRUTTORE||' '||P.MODELLO ELSE P.DESCRIZIONE END) || '  (' || ORE.CODCANTIERE || ', ' || ORE.DATACANTIERE || ')' FROM 1 FOR 200) AS VARCHAR(200))
 ,P.CLIENTE AS CODSOGGPRAT
 ,COALESCE(P.PRZUNITOPERA1_1, 0)
 ,COALESCE(P.PRZUNITOPERA1_2, 0)
 ,COALESCE(P.PRZUNITOPERA1_3, 0)
 ,COALESCE(P.PRZUNITOPERA1_4, 0)
 ,COALESCE(P.PRZUNITOPERA1_5, 0)
 ,P.TIPORICARICO
 ,P.TIPORICARICOCOMEDACOMMESSA
 ,P.TIPOCOSTO
 ,P.RICARICOPERC
 ,P.LISTINO
 ,CAST(ORE.OPERAINDEX AS INTEGER) AS OPERAINDEX

 /* COdice manodopera */
 ,CASE OPERAINDEX
    WHEN 0 THEN (SELECT FIRST 1 CODICEOPERA   FROM PROGRESS)
    WHEN 1 THEN (SELECT FIRST 1 CODICEOPERA_2 FROM PROGRESS)
    WHEN 2 THEN (SELECT FIRST 1 CODICEOPERA_3 FROM PROGRESS)
    WHEN 3 THEN (SELECT FIRST 1 CODICEOPERA_4 FROM PROGRESS)
    WHEN 4 THEN (SELECT FIRST 1 CODICEOPERA_5 FROM PROGRESS)
    ELSE NULL
  END

 /* Descrizione manodopera */
 ,CASE OPERAINDEX
    WHEN 0 THEN (SELECT FIRST 1 DESCRIZIONEOPERA   FROM PROGRESS)
    WHEN 1 THEN (SELECT FIRST 1 DESCRIZIONEOPERA_2 FROM PROGRESS)
    WHEN 2 THEN (SELECT FIRST 1 DESCRIZIONEOPERA_3 FROM PROGRESS)
    WHEN 3 THEN (SELECT FIRST 1 DESCRIZIONEOPERA_4 FROM PROGRESS)
    WHEN 4 THEN (SELECT FIRST 1 DESCRIZIONEOPERA_5 FROM PROGRESS)
    ELSE NULL
  END

 ,ORE.GUID
 ,ORE.GUID_REF
 ,ORE.GUID_ANCESTOR
 ,CAST(NULL AS VARCHAR(50)) AS TRACK_PREVENTIVO
 ,CAST(NULL AS VARCHAR(50)) AS TRACK_COMMESSA
 ,CAST(NULL AS VARCHAR(50)) AS TRACK_DDT
 ,CAST(NULL AS VARCHAR(50)) AS TRACK_FATTURA
 ,CAST(NULL AS VARCHAR(50)) AS TRACK_ESTRATTO_CONTO
 ,CAST(NULL AS VARCHAR(50)) AS TRACK_SAL
 ,CAST(NULL AS VARCHAR(50)) AS TRACK_BOLLA_ENTR
 ,CAST(NULL AS VARCHAR(50)) AS TRACK_FATT_ACQUI
 ,CAST(NULL AS VARCHAR(50)) AS TRACK_ORD_FORN

 ,ORE.SEGNOOPERAZIONECANTIERE
 ,CAST(NULL AS VARCHAR(1)) AS SEGNOOPERAZIONE
 ,CAST(
    CASE
      WHEN ((ORE.SEGNOOPERAZIONECANTIERE='+') OR (ORE.SEGNOOPERAZIONECANTIERE='-')) THEN 'Giacenza'
      WHEN (ORE.SEGNOOPERAZIONECANTIERE='C') THEN 'Commessa'
      WHEN (ORE.SEGNOOPERAZIONECANTIERE='M') THEN 'Montato'
      WHEN (ORE.SEGNOOPERAZIONECANTIERE='F') THEN 'Fatturato'
      WHEN (ORE.SEGNOOPERAZIONECANTIERE='D') THEN 'D.D.T.'
      ELSE '- - -'
    END
  AS VARCHAR(20)) AS GC_SEZIONE
 ,T.STATODESCRIZIONE
 ,T.STATOFOREGROUND

 ,CAST(  SUBSTRING(  ORE.TIPODOC || ' ' || ORE.NUMDOC || ORE.REGISTRO || ' del ' || ORE.DATADOC FROM 1 FOR 200) AS VARCHAR(200)) AS DOCUMENTO
 ,CAST(  SUBSTRING(  ORE.DESCRIZSOGGETTO FROM 1 FOR 200) AS VARCHAR(200)) AS SOGGETTO

 ,CAST(CODDIPENDENTE AS SMALLINT) AS CODICEMAGAZZINO
 ,CAST(NULL AS VARCHAR(1)) AS MOVMAG
 ,CAST('Opera - ' || ORE.CODDIPENDENTE AS VARCHAR(25)) AS CODICEARTICOLO
 ,CAST(ORE.DESCRIZDIPENDENTE AS VARCHAR(1000)) AS DESCRIZIONE
 ,CAST(ORE.PRZVEND AS NUMERIC(11,4)) AS PREZZOUNITARIO
 ,CAST('H' AS VARCHAR(2)) AS UNITADIMISURA
 ,CAST(   COALESCE(ORE.QTA,0) + COALESCE(ORE.QTASTRAORDINARIO,0) + COALESCE(ORE.QTATRASFERTE,0)   AS NUMERIC(11,4)) AS QTA
 ,CAST(NULL AS NUMERIC(11,4)) AS SCONTORIGO
 ,CAST(NULL AS NUMERIC(11,4)) AS SCONTORIGO2
 ,CAST(NULL AS NUMERIC(11,4)) AS SCONTORIGO3
 ,CAST(ORE.IMPORTOVEND AS NUMERIC(11,4)) AS IMPORTORIGO
 ,CAST(   (COALESCE(ORE.IMPORTOCOSTOORARIO,0) + COALESCE(ORE.IMPORTOSTRAORDINARIO,0) + COALESCE(ORE.IMPORTOTRASFERTE,0)) / (COALESCE(ORE.QTA,0) + COALESCE(ORE.QTASTRAORDINARIO,0) + COALESCE(ORE.QTATRASFERTE,0))
    AS NUMERIC(11,4)) AS PREZZOACQUISTOARTICOLO
 ,CAST(   COALESCE(ORE.IMPORTOCOSTOORARIO,0) + COALESCE(ORE.IMPORTOSTRAORDINARIO,0) + COALESCE(ORE.IMPORTOTRASFERTE,0)   AS NUMERIC(11,4)) AS IMPORTOACQUISTOARTICOLO
 ,CAST(ORE.NOTE AS VARCHAR(1000))
 ,CAST(NULL AS DECIMAL(15,4))
 ,CAST(NULL AS NUMERIC(11,4)) AS PREZZOUNITARIONETTO
 ,CAST(NULL AS INTEGER)
 ,CAST(NULL AS VARCHAR(40))
 ,CAST(NULL AS DECIMAL(15,4))
 

 ,COALESCE(ORE.SOTTOCANTIERE1, '') AS SOTTOCANTIERE1
 ,COALESCE(ORE.SOTTOCANTIERE2, '') AS SOTTOCANTIERE2
 ,COALESCE(ORE.SOTTOCANTIERE3, '') AS SOTTOCANTIERE3
 ,CAST('' AS VARCHAR(20)) AS SOTTOCANTIERE4
 ,CAST('' AS VARCHAR(20)) AS SOTTOCANTIERE5
 ,CAST('' AS VARCHAR(20)) AS SOTTOCANTIERE6

 ,COALESCE(P.CATEGCANT1, '') AS CATEGCANT1
 ,COALESCE(P.CATEGCANT2, '') AS CATEGCANT2
 ,COALESCE(P.CATEGCANT3, '') AS CATEGCANT3
 ,COALESCE(P.CATEGCANT4, '') AS CATEGCANT4
 ,COALESCE(P.CATEGCANT5, '') AS CATEGCANT5
 ,COALESCE(P.CATEGCANT6, '') AS CATEGCANT6

 ,CAST(NULL AS VARCHAR(10)) AS S3RIF
 ,CAST(NULL AS VARCHAR(25)) AS S3UBICAZIONE
 ,CAST(NULL AS VARCHAR(30)) AS S3COMPONENTE
 ,CAST(NULL AS VARCHAR(20)) AS S3MATERIALE
 ,CAST(NULL AS NUMERIC(11,4)) AS S3QTA
 ,CAST(NULL AS VARCHAR(10)) AS S3DIAMETRO
 ,CAST(NULL AS NUMERIC(11,4)) AS S3LUNGHEZZA
 ,CAST(NULL AS VARCHAR(25)) AS S3INSTALLAZIONE
 ,CAST(NULL AS VARCHAR(25)) AS S3CERTIFICAZIONE
 ,CAST(NULL AS VARCHAR(10)) AS VENTILAZIONE
 ,CAST(NULL AS VARCHAR(25)) AS S3SCARICO
 ,CAST(NULL AS VARCHAR(10)) AS S3TIPO
 ,CAST(NULL AS NUMERIC(11,4)) AS S3PORTATATERMICA
 ,CAST(NULL AS VARCHAR(20)) AS S3TIPOCOLLEGAMENTO
 ,CAST(NULL AS VARCHAR(15)) AS S3INSTALATOINSTALLABILE
 ,CAST(NULL AS VARCHAR(25)) AS S3MODELLO

 ,CAST('Manodopera' AS VARCHAR(60)) AS TIPOLOGIA

 /* ---------- COSTO NETTO UNITARIO ---------- */
 ,COALESCE(ORE.GC_COSTONETTOUNITARIO_MOD, 'F')
 ,CASE
    WHEN (ORE.GC_COSTONETTOUNITARIO_MOD='T') THEN ORE.GC_COSTONETTOUNITARIO
    ELSE CAST(   (COALESCE(ORE.IMPORTOCOSTOORARIO,0) + COALESCE(ORE.IMPORTOSTRAORDINARIO,0) + COALESCE(ORE.IMPORTOTRASFERTE,0)) / (COALESCE(ORE.QTA,0) + COALESCE(ORE.QTASTRAORDINARIO,0) + COALESCE(ORE.QTATRASFERTE,0))
      AS NUMERIC(11,4))
  END AS GC_COSTONETTOUNITARIO

 /* ---------- RICARICO ---------- */
 ,COALESCE(ORE.GC_RICARICO_MOD, 'F')
 ,CASE
    WHEN (ORE.GC_RICARICO_MOD='T') THEN ORE.GC_RICARICO
    ELSE ORE.GC_RICARICO
  END AS GC_RICARICO

 /* ---------- QTA ---------- */
 ,COALESCE(ORE.GC_QTA_MOD, 'F')
 ,CASE
    WHEN (ORE.GC_QTA_MOD='T') THEN ORE.GC_QTA
    ELSE CAST(   COALESCE(ORE.QTA,0) + COALESCE(ORE.QTASTRAORDINARIO,0) + COALESCE(ORE.QTATRASFERTE,0)   AS NUMERIC(11,4))
  END AS GC_QTA

 /* ---------- DESCRIZIONE ---------- */
 ,COALESCE(ORE.GC_DESCRIZIONE_MOD, 'F')
 ,CASE
    WHEN (ORE.GC_DESCRIZIONE_MOD='T') THEN ORE.GC_DESCRIZIONE
    ELSE CAST(ORE.DESCRIZDIPENDENTE || '  (' || ORE.CODDIPENDENTE || ')' AS VARCHAR(5000))
  END AS GC_DESCRIZIONE

FROM RAPGIORNRIGHI ORE
LEFT JOIN RAPGIORN T ON (T.NUMDOC = ORE.NUMDOC AND T.DATADOC = ORE.DATADOC AND T.Registro = ORE.Registro)
LEFT JOIN PRATICHE P ON (P.TIPO='P' AND P.CODICE=ORE.CODCANTIERE AND P.DATAAPERTURA=ORE.DATACANTIERE)

/* ----- Non visualizza i dettagli manodopera di fatture e commesse perchè in questo caso usa i righi principali */
WHERE ORE.SEGNOOPERAZIONECANTIERE <> 'F' AND ORE.SEGNOOPERAZIONECANTIERE <> 'C'
/* ================================================= */



UNION ALL



/* =================================================
   |   RAPGIORNRIGHISPESE - ALTRE SPESE            |
   =================================================
*/
SELECT

  CAST(SPESE.TIPODOC AS VARCHAR(25)) AS TIPODOCUMENTO
 ,CAST(SPESE.NUMDOC AS INTEGER) AS NUMORDPREV
 ,CAST(SPESE.REGISTRO AS VARCHAR(5)) AS REGISTRO
 ,CAST(SPESE.DATADOC AS TIMESTAMP) AS DATADOCUMENTO
 ,CAST(SPESE.NUMRIGO AS INTEGER) AS PROGRIGO
 ,CAST(SPESE.NUMRIGO2 AS INTEGER) AS PROGRIGO2
 ,CAST(NULL AS VARCHAR(40)) AS CAUSALE
 ,SPESE.CODSOGGETTO AS CODICECLIENTE

 ,SPESE.CODCANTIERE
 ,SPESE.DATACANTIERE
 ,P.DATACHIUSURA
 ,P.STATODESCRIZIONE
 ,CAST(  SUBSTRING(  (CASE P.TIPO WHEN 'A' THEN P.COSTRUTTORE||' '||P.MODELLO ELSE P.DESCRIZIONE END) || '  (' || SPESE.CODCANTIERE || ', ' || SPESE.DATACANTIERE || ')' FROM 1 FOR 200) AS VARCHAR(200))
 ,P.CLIENTE AS CODSOGGPRAT
 ,COALESCE(P.PRZUNITOPERA1_1, 0)
 ,COALESCE(P.PRZUNITOPERA1_2, 0)
 ,COALESCE(P.PRZUNITOPERA1_3, 0)
 ,COALESCE(P.PRZUNITOPERA1_4, 0)
 ,COALESCE(P.PRZUNITOPERA1_5, 0)
 ,P.TIPORICARICO
 ,P.TIPORICARICOCOMEDACOMMESSA
 ,P.TIPOCOSTO
 ,P.RICARICOPERC
 ,P.LISTINO
 ,CAST(NULL AS INTEGER) AS OPERAINDEX
 ,CAST(NULL AS VARCHAR(15)) AS OPERACODICE
 ,CAST(NULL AS VARCHAR(45)) AS OPERADESCRIZIONE

 ,SPESE.GUID
 ,SPESE.GUID_REF
 ,SPESE.GUID_ANCESTOR
 ,CAST(NULL AS VARCHAR(50)) AS TRACK_PREVENTIVO
 ,CAST(NULL AS VARCHAR(50)) AS TRACK_COMMESSA
 ,CAST(NULL AS VARCHAR(50)) AS TRACK_DDT
 ,CAST(NULL AS VARCHAR(50)) AS TRACK_FATTURA
 ,CAST(NULL AS VARCHAR(50)) AS TRACK_ESTRATTO_CONTO
 ,CAST(NULL AS VARCHAR(50)) AS TRACK_SAL
 ,CAST(NULL AS VARCHAR(50)) AS TRACK_BOLLA_ENTR
 ,CAST(NULL AS VARCHAR(50)) AS TRACK_FATT_ACQUI
 ,CAST(NULL AS VARCHAR(50)) AS TRACK_ORD_FORN

 ,SPESE.SEGNOOPERAZIONECANTIERE
 ,CAST(NULL AS VARCHAR(1)) AS SEGNOOPERAZIONE
  ,CAST(
     CASE
       WHEN ((SPESE.SEGNOOPERAZIONECANTIERE='+') OR (SPESE.SEGNOOPERAZIONECANTIERE='-')) THEN 'Giacenza'
       WHEN (SPESE.SEGNOOPERAZIONECANTIERE='C') THEN 'Commessa'
       WHEN (SPESE.SEGNOOPERAZIONECANTIERE='M') THEN 'Montato'
       WHEN (SPESE.SEGNOOPERAZIONECANTIERE='F') THEN 'Fatturato'
       WHEN (SPESE.SEGNOOPERAZIONECANTIERE='D') THEN 'D.D.T.'
       ELSE '- - -'
     END
   AS VARCHAR(20)) AS GC_SEZIONE
 ,T.STATODESCRIZIONE
 ,T.STATOFOREGROUND

 ,CAST(  SUBSTRING(  SPESE.TIPODOC || ' ' || SPESE.NUMDOC || SPESE.REGISTRO || ' del ' || SPESE.DATADOC FROM 1 FOR 200) AS VARCHAR(200)) AS DOCUMENTO
 ,CAST(  SUBSTRING(  SPESE.DESCRIZSOGGETTO FROM 1 FOR 200)   AS VARCHAR(200)) AS SOGGETTO

 ,CAST(NULL AS SMALLINT) AS CODICEMAGAZZINO
 ,CAST(NULL AS VARCHAR(1)) AS MOVMAG
 ,CAST('Spese - ' || SPESE.CODDIPENDENTE AS VARCHAR(25)) AS CODICEARTICOLO
 ,CAST(SPESE.DESCRIZDIPENDENTE AS VARCHAR(5000)) AS DESCRIZIONE
 ,CAST(SPESE.IMPORTO AS NUMERIC(11,4)) AS PREZZOUNITARIO
 ,CAST(NULL AS VARCHAR(2)) AS UNITADIMISURA
 ,CAST(   1   AS NUMERIC(11,4)) AS QTA
 ,CAST(NULL AS NUMERIC(11,4)) AS SCONTORIGO
 ,CAST(NULL AS NUMERIC(11,4)) AS SCONTORIGO2
 ,CAST(NULL AS NUMERIC(11,4)) AS SCONTORIGO3
 ,CAST(SPESE.IMPORTO AS NUMERIC(11,4)) AS IMPORTORIGO
 ,CAST(   IMPORTO   AS NUMERIC(11,4)) AS PREZZOACQUISTOARTICOLO
 ,CAST(   IMPORTO   AS NUMERIC(11,4)) AS IMPORTOACQUISTOARTICOLO
 ,CAST(SPESE.NOTE AS VARCHAR(1000))
 ,CAST(NULL AS DECIMAL(15,4))
 ,CAST(NULL AS NUMERIC(11,4)) AS PREZZOUNITARIONETTO
 ,CAST(NULL AS INTEGER)
 ,CAST(NULL AS VARCHAR(40))
 ,CAST(NULL AS DECIMAL(15,4))

 ,COALESCE(SPESE.SOTTOCANTIERE1, '') AS SOTTOCANTIERE1
 ,COALESCE(SPESE.SOTTOCANTIERE2, '') AS SOTTOCANTIERE2
 ,COALESCE(SPESE.SOTTOCANTIERE3, '') AS SOTTOCANTIERE3
 ,CAST('' AS VARCHAR(20)) AS SOTTOCANTIERE4
 ,CAST('' AS VARCHAR(20)) AS SOTTOCANTIERE5
 ,CAST('' AS VARCHAR(20)) AS SOTTOCANTIERE6

 ,COALESCE(P.CATEGCANT1, '') AS CATEGCANT1
 ,COALESCE(P.CATEGCANT2, '') AS CATEGCANT2
 ,COALESCE(P.CATEGCANT3, '') AS CATEGCANT3
 ,COALESCE(P.CATEGCANT4, '') AS CATEGCANT4
 ,COALESCE(P.CATEGCANT5, '') AS CATEGCANT5
 ,COALESCE(P.CATEGCANT6, '') AS CATEGCANT6

 ,CAST(NULL AS VARCHAR(10)) AS S3RIF
 ,CAST(NULL AS VARCHAR(25)) AS S3UBICAZIONE
 ,CAST(NULL AS VARCHAR(30)) AS S3COMPONENTE
 ,CAST(NULL AS VARCHAR(20)) AS S3MATERIALE
 ,CAST(NULL AS NUMERIC(11,4)) AS S3QTA
 ,CAST(NULL AS VARCHAR(10)) AS S3DIAMETRO
 ,CAST(NULL AS NUMERIC(11,4)) AS S3LUNGHEZZA
 ,CAST(NULL AS VARCHAR(25)) AS S3INSTALLAZIONE
 ,CAST(NULL AS VARCHAR(25)) AS S3CERTIFICAZIONE
 ,CAST(NULL AS VARCHAR(10)) AS VENTILAZIONE
 ,CAST(NULL AS VARCHAR(25)) AS S3SCARICO
 ,CAST(NULL AS VARCHAR(10)) AS S3TIPO
 ,CAST(NULL AS NUMERIC(11,4)) AS S3PORTATATERMICA
 ,CAST(NULL AS VARCHAR(20)) AS S3TIPOCOLLEGAMENTO
 ,CAST(NULL AS VARCHAR(15)) AS S3INSTALATOINSTALLABILE
 ,CAST(NULL AS VARCHAR(25)) AS S3MODELLO

 ,CAST('Altre spese' AS VARCHAR(60)) AS TIPOLOGIA

 /* ---------- COSTO NETTO UNITARIO ---------- */
 ,COALESCE(SPESE.GC_COSTONETTOUNITARIO_MOD, 'F')
 ,CASE
    WHEN (SPESE.GC_COSTONETTOUNITARIO_MOD='T') THEN SPESE.GC_COSTONETTOUNITARIO
    ELSE SPESE.IMPORTO
  END AS GC_COSTONETTOUNITARIO

  /* ---------- RICARICO ---------- */
  ,COALESCE(SPESE.GC_RICARICO_MOD, 'F')
  ,CASE
     WHEN (SPESE.GC_RICARICO_MOD='T') THEN SPESE.GC_RICARICO
     WHEN (P.TIPORICARICO=0) THEN P.RICARICOPERC
     WHEN (P.TIPORICARICO=1) THEN (SELECT * FROM GC_GET_RICARICO('xxxzzzyyyuuupppwwweee',     (CASE WHEN (SPESE.GC_COSTONETTOUNITARIO_MOD='T') THEN SPESE.GC_COSTONETTOUNITARIO ELSE SPESE.IMPORTO END),     P.LISTINO))
     ELSE P.RICARICOPERC
   END AS GC_RICARICO

 /* ---------- QTA ---------- */
 ,COALESCE(SPESE.GC_QTA_MOD,'F')
 ,CASE
    WHEN (SPESE.GC_QTA_MOD='T') THEN SPESE.GC_QTA
    ELSE CAST(   1   AS NUMERIC(11,4))
  END AS GC_QTA

 /* ---------- DESCRIZIONE ---------- */
 ,COALESCE(SPESE.GC_DESCRIZIONE_MOD, 'F')
 ,CASE
    WHEN (SPESE.GC_DESCRIZIONE_MOD='T') THEN SPESE.GC_DESCRIZIONE
    ELSE SPESE.NOTE
  END AS GC_DESCRIZIONE


FROM RAPGIORNRIGHISPESE SPESE
LEFT JOIN RAPGIORN T ON (T.NUMDOC = SPESE.NUMDOC AND T.DATADOC = SPESE.DATADOC AND T.Registro = SPESE.Registro)
LEFT JOIN PRATICHE P ON (P.TIPO='P' AND P.CODICE=SPESE.CODCANTIERE AND P.DATAAPERTURA=SPESE.DATACANTIERE)
/* ================================================= */
