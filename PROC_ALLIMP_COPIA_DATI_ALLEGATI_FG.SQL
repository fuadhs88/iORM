SET TERM ^ ;

CREATE PROCEDURE ALLIMP_COPIA_DATI_ALLEGATI_FG (in_IdAllegatoDest INTEGER, in_IdApparecchio INTEGER)
AS
  declare B_LIBRETTOIMPIANTO CHAR(1);
  declare B_LIBRETTOIMPIANTO_NOTE VARCHAR(60);
  declare B_RAPPCONTRTECN10435 CHAR(1);
  declare B_RAPPCONTRTECN10435_NOTE VARCHAR(60);
  declare B_DICHCONFIMP CHAR(1);
  declare B_DICHCONFIMP_NOTE VARCHAR(60);
  declare B_LIBRUSOCALD CHAR(1);
  declare B_LIBRUSOCALD_NOTE VARCHAR(60);
  declare B_LIBRUSOBRUCIATORE CHAR(1);
  declare B_LIBRUSOBRUCIATORE_NOTE VARCHAR(60);
  declare B_PRATICAISPESL CHAR(1);
  declare B_PRATICAISPESL_NOTE VARCHAR(60);
  declare B_CERTPREVINCENDI CHAR(1);
  declare B_CERTPREVINCENDI_NOTE VARCHAR(60);
  declare B_CERTUNI8364 CHAR(1);
  declare B_CERTUNI8364_NOTE VARCHAR(60);
  declare B_SCHEMIFUNZIDRAUL CHAR(1);
  declare B_SCHEMIFUNZIDRAUL_NOTE VARCHAR(60);
  declare B_SCHEMIFUNZELETTR CHAR(1);
  declare B_SCHEMIFUNZELETTR_NOTE VARCHAR(60);
  declare C_IDONLOCALEINSTALLAZ CHAR(1);
  declare C_ADEGDIMENSVENTILAZ CHAR(1);
  declare C_APERTVENTILAZLIBERE CHAR(1);
  declare C_ESAMEVISIVOLINEEELETTRICHE CHAR(1);
  declare C_BRUCFUNZIONAMCORRETTO CHAR(1);
  declare D_PENDENZACORRETTA CHAR(1);
  declare D_SEZIONICORRETTE CHAR(1);
  declare D_CURVECORRETTE CHAR(1);
  declare D_LUNGHEZZACORRETTA CHAR(1);
  declare D_BUONOSTATOCONSERVAZ CHAR(1);
  declare E_SCARICOCAMINOSINGOLO CHAR(1);
  declare E_SCARICOCANNAFUMCOLLRAMIF CHAR(1);
  declare E_APPSCARICAAPARETE CHAR(1);
  declare E_NORIFLUSSIFUMILOCALE CHAR(1);
  declare E_NOPERDITECONDOTTISCARICO CHAR(1);
  declare F_UGELLIPULITI CHAR(1);
  declare F_SCAMBLATOFUMOPULITO CHAR(1);
  declare F_ACCENSFUNZAMREGOLARI CHAR(1);
  declare F_DISPCOMANDOREGOLAZFUNZCORR CHAR(1);
  declare F_ASSENZAPERDITEOSSIDAZRACC CHAR(1);
  declare F_DISPSICUREZZANONMANOMESSI CHAR(1);
  declare F_VASOESPANSIONECARICO CHAR(1);
  declare F_ORGSOGGSOLLECITAZTERMINTEGRI CHAR(1);
  declare F_DISPROMPITIRAGGIONODETERIOR CHAR(1);
  declare F_VALVOLASICUREZZASOVRAPRESS CHAR(1);
  declare F_CIRCUITOARIAPULITO CHAR(1);
  declare F_GUARNIZACCOPIAMINTEGRA CHAR(1);
  declare G_CONTROLLOASSENZAFUGHEGAS CHAR(1);
  declare G_ESAMEVISIVOCOIBENTAZIONI CHAR(1);
  declare G_ESAMEVISIVOCAMINO CHAR(1);

  declare B_LIBRETTOIMPIANTOCOMPILATO CHAR(1);
  declare C_EXTINST_GENERATOREIDONEO CHAR(1);
  declare F_SISTIREGOLAZTEMPFUNZIONANTE CHAR(1);
  declare G_ASSENZAPERDITECOMBLIQUIDO CHAR(1);
  declare G_RISCTRLUNI10389_1 CHAR(1);
  declare CHKLST_ADOZVALVTERMOST CHAR(1);
  declare CHKLST_ISOLAMRETEDISTRIB CHAR(1);
  declare CHKLST_SISTTRATTAMACQUA CHAR(1);
  declare CHKLST_SOSTSISTREGOLAZ CHAR(1);
  declare TH2O_DUREZZATOTALE DOUBLE PRECISION;
  declare TH2O_TRATTRISCALDAM VARCHAR(30);
  declare TH2O_TRATTACS VARCHAR(30);


/* ========================================================================================================== */
BEGIN

  /* Carica i dati dall'allegato precedente */
  SELECT FIRST 1
    AM.B_LIBRETTOIMPIANTO,
    AM.B_LIBRETTOIMPIANTO_NOTE,
    AM.B_RAPPCONTRTECN10435,
    AM.B_RAPPCONTRTECN10435_NOTE,
    AM.B_DICHCONFIMP,
    AM.B_DICHCONFIMP_NOTE,
    AM.B_LIBRUSOCALD,
    AM.B_LIBRUSOCALD_NOTE,
    AM.B_LIBRUSOBRUCIATORE,
    AM.B_LIBRUSOBRUCIATORE_NOTE,
    AM.B_PRATICAISPESL,
    AM.B_PRATICAISPESL_NOTE,
    AM.B_CERTPREVINCENDI,
    AM.B_CERTPREVINCENDI_NOTE,
    AM.B_CERTUNI8364,
    AM.B_CERTUNI8364_NOTE,
    AM.B_SCHEMIFUNZIDRAUL,
    AM.B_SCHEMIFUNZIDRAUL_NOTE,
    AM.B_SCHEMIFUNZELETTR,
    AM.B_SCHEMIFUNZELETTR_NOTE,
    AM.C_IDONLOCALEINSTALLAZ,
    AM.C_ADEGDIMENSVENTILAZ,
    AM.C_APERTVENTILAZLIBERE,
    AM.C_ESAMEVISIVOLINEEELETTRICHE,
    AM.C_BRUCFUNZIONAMCORRETTO,
    AM.D_PENDENZACORRETTA,
    AM.D_SEZIONICORRETTE,
    AM.D_CURVECORRETTE,
    AM.D_LUNGHEZZACORRETTA,
    AM.D_BUONOSTATOCONSERVAZ,
    AM.E_SCARICOCAMINOSINGOLO,
    AM.E_SCARICOCANNAFUMCOLLRAMIF,
    AM.E_APPSCARICAAPARETE,
    AM.E_NORIFLUSSIFUMILOCALE,
    AM.E_NOPERDITECONDOTTISCARICO,
    AM.F_UGELLIPULITI,
    AM.F_SCAMBLATOFUMOPULITO,
    AM.F_ACCENSFUNZAMREGOLARI,
    AM.F_DISPCOMANDOREGOLAZFUNZCORR,
    AM.F_ASSENZAPERDITEOSSIDAZRACC,
    AM.F_DISPSICUREZZANONMANOMESSI,
    AM.F_VASOESPANSIONECARICO,
    AM.F_ORGSOGGSOLLECITAZTERMINTEGRI,
    AM.F_DISPROMPITIRAGGIONODETERIOR,
    AM.F_VALVOLASICUREZZASOVRAPRESS,
    AM.F_CIRCUITOARIAPULITO,
    AM.F_GUARNIZACCOPIAMINTEGRA,
    AM.G_CONTROLLOASSENZAFUGHEGAS,
    AM.G_ESAMEVISIVOCOIBENTAZIONI,
    AM.G_ESAMEVISIVOCAMINO,

    AM.B_LIBRETTOIMPIANTOCOMPILATO,
    AM.C_EXTINST_GENERATOREIDONEO,
    AM.F_SISTIREGOLAZTEMPFUNZIONANTE,
    AM.G_ASSENZAPERDITECOMBLIQUIDO,
    AM.G_RISCTRLUNI10389_1,
    AM.CHKLST_ADOZVALVTERMOST,
    AM.CHKLST_ISOLAMRETEDISTRIB,
    AM.CHKLST_SISTTRATTAMACQUA,
    AM.CHKLST_SOSTSISTREGOLAZ,
    AM.TH2O_DUREZZATOTALE,
    AM.TH2O_TRATTRISCALDAM,
    AM.TH2O_TRATTACS

  FROM ALLEGATI_MANUT AM
  WHERE AM.ID = (SELECT MAX(AM2.ID) FROM ALLEGATI_MANUT AM2 WHERE AM2.GENCAL_ID = :in_IdApparecchio AND AM2.ID < :in_IdAllegatoDest AND AM2.STATOAVANZAMENTO >= 30)
  INTO
    :B_LIBRETTOIMPIANTO,
    :B_LIBRETTOIMPIANTO_NOTE,
    :B_RAPPCONTRTECN10435,
    :B_RAPPCONTRTECN10435_NOTE,
    :B_DICHCONFIMP,
    :B_DICHCONFIMP_NOTE,
    :B_LIBRUSOCALD,
    :B_LIBRUSOCALD_NOTE,
    :B_LIBRUSOBRUCIATORE,
    :B_LIBRUSOBRUCIATORE_NOTE,
    :B_PRATICAISPESL,
    :B_PRATICAISPESL_NOTE,
    :B_CERTPREVINCENDI,
    :B_CERTPREVINCENDI_NOTE,
    :B_CERTUNI8364,
    :B_CERTUNI8364_NOTE,
    :B_SCHEMIFUNZIDRAUL,
    :B_SCHEMIFUNZIDRAUL_NOTE,
    :B_SCHEMIFUNZELETTR,
    :B_SCHEMIFUNZELETTR_NOTE,
    :C_IDONLOCALEINSTALLAZ,
    :C_ADEGDIMENSVENTILAZ,
    :C_APERTVENTILAZLIBERE,
    :C_ESAMEVISIVOLINEEELETTRICHE,
    :C_BRUCFUNZIONAMCORRETTO,
    :D_PENDENZACORRETTA,
    :D_SEZIONICORRETTE,
    :D_CURVECORRETTE,
    :D_LUNGHEZZACORRETTA,
    :D_BUONOSTATOCONSERVAZ,
    :E_SCARICOCAMINOSINGOLO,
    :E_SCARICOCANNAFUMCOLLRAMIF,
    :E_APPSCARICAAPARETE,
    :E_NORIFLUSSIFUMILOCALE,
    :E_NOPERDITECONDOTTISCARICO,
    :F_UGELLIPULITI,
    :F_SCAMBLATOFUMOPULITO,
    :F_ACCENSFUNZAMREGOLARI,
    :F_DISPCOMANDOREGOLAZFUNZCORR,
    :F_ASSENZAPERDITEOSSIDAZRACC,
    :F_DISPSICUREZZANONMANOMESSI,
    :F_VASOESPANSIONECARICO,
    :F_ORGSOGGSOLLECITAZTERMINTEGRI,
    :F_DISPROMPITIRAGGIONODETERIOR,
    :F_VALVOLASICUREZZASOVRAPRESS,
    :F_CIRCUITOARIAPULITO,
    :F_GUARNIZACCOPIAMINTEGRA,
    :G_CONTROLLOASSENZAFUGHEGAS,
    :G_ESAMEVISIVOCOIBENTAZIONI,
    :G_ESAMEVISIVOCAMINO,

    :B_LIBRETTOIMPIANTOCOMPILATO,
    :C_EXTINST_GENERATOREIDONEO,
    :F_SISTIREGOLAZTEMPFUNZIONANTE,
    :G_ASSENZAPERDITECOMBLIQUIDO,
    :G_RISCTRLUNI10389_1,
    :CHKLST_ADOZVALVTERMOST,
    :CHKLST_ISOLAMRETEDISTRIB,
    :CHKLST_SISTTRATTAMACQUA,
    :CHKLST_SOSTSISTREGOLAZ,
    :TH2O_DUREZZATOTALE,
    :TH2O_TRATTRISCALDAM,
    :TH2O_TRATTACS;


  /* Se non ha trovato alcun allegato precedente esce subito */
  IF (ROW_COUNT = 0) THEN EXIT;
  
  /* Query che inserisce i dati nel nuovo allegato */
  UPDATE ALLEGATI_MANUT AM SET
    AM.B_LIBRETTOIMPIANTO = :B_LIBRETTOIMPIANTO,
    AM.B_LIBRETTOIMPIANTO_NOTE = :B_LIBRETTOIMPIANTO_NOTE,
    AM.B_RAPPCONTRTECN10435 = :B_RAPPCONTRTECN10435,
    AM.B_RAPPCONTRTECN10435_NOTE = :B_RAPPCONTRTECN10435_NOTE,
    AM.B_DICHCONFIMP = :B_DICHCONFIMP,
    AM.B_DICHCONFIMP_NOTE = :B_DICHCONFIMP_NOTE,
    AM.B_LIBRUSOCALD = :B_LIBRUSOCALD,
    AM.B_LIBRUSOCALD_NOTE = :B_LIBRUSOCALD_NOTE,
    AM.B_LIBRUSOBRUCIATORE = :B_LIBRUSOBRUCIATORE,
    AM.B_LIBRUSOBRUCIATORE_NOTE = :B_LIBRUSOBRUCIATORE_NOTE,
    AM.B_PRATICAISPESL = :B_PRATICAISPESL,
    AM.B_PRATICAISPESL_NOTE = :B_PRATICAISPESL_NOTE,
    AM.B_CERTPREVINCENDI = :B_CERTPREVINCENDI,
    AM.B_CERTPREVINCENDI_NOTE = :B_CERTPREVINCENDI_NOTE,
    AM.B_CERTUNI8364 = :B_CERTUNI8364,
    AM.B_CERTUNI8364_NOTE = :B_CERTUNI8364_NOTE,
    AM.B_SCHEMIFUNZIDRAUL = :B_SCHEMIFUNZIDRAUL,
    AM.B_SCHEMIFUNZIDRAUL_NOTE = :B_SCHEMIFUNZIDRAUL_NOTE,
    AM.B_SCHEMIFUNZELETTR = :B_SCHEMIFUNZELETTR,
    AM.B_SCHEMIFUNZELETTR_NOTE = :B_SCHEMIFUNZELETTR_NOTE,
    AM.C_IDONLOCALEINSTALLAZ = :C_IDONLOCALEINSTALLAZ,
    AM.C_ADEGDIMENSVENTILAZ = :C_ADEGDIMENSVENTILAZ,
    AM.C_APERTVENTILAZLIBERE = :C_APERTVENTILAZLIBERE,
    AM.C_ESAMEVISIVOLINEEELETTRICHE = :C_ESAMEVISIVOLINEEELETTRICHE,
    AM.C_BRUCFUNZIONAMCORRETTO = :C_BRUCFUNZIONAMCORRETTO,
    AM.D_PENDENZACORRETTA = :D_PENDENZACORRETTA,
    AM.D_SEZIONICORRETTE = :D_SEZIONICORRETTE,
    AM.D_CURVECORRETTE = :D_CURVECORRETTE,
    AM.D_LUNGHEZZACORRETTA = :D_LUNGHEZZACORRETTA,
    AM.D_BUONOSTATOCONSERVAZ = :D_BUONOSTATOCONSERVAZ,
    AM.E_SCARICOCAMINOSINGOLO = :E_SCARICOCAMINOSINGOLO,
    AM.E_SCARICOCANNAFUMCOLLRAMIF = :E_SCARICOCANNAFUMCOLLRAMIF,
    AM.E_APPSCARICAAPARETE = :E_APPSCARICAAPARETE,
    AM.E_NORIFLUSSIFUMILOCALE = :E_NORIFLUSSIFUMILOCALE,
    AM.E_NOPERDITECONDOTTISCARICO = :E_NOPERDITECONDOTTISCARICO,
    AM.F_UGELLIPULITI = :F_UGELLIPULITI,
    AM.F_SCAMBLATOFUMOPULITO = :F_SCAMBLATOFUMOPULITO,
    AM.F_ACCENSFUNZAMREGOLARI = :F_ACCENSFUNZAMREGOLARI,
    AM.F_DISPCOMANDOREGOLAZFUNZCORR = :F_DISPCOMANDOREGOLAZFUNZCORR,
    AM.F_ASSENZAPERDITEOSSIDAZRACC = :F_ASSENZAPERDITEOSSIDAZRACC,
    AM.F_DISPSICUREZZANONMANOMESSI = :F_DISPSICUREZZANONMANOMESSI,
    AM.F_VASOESPANSIONECARICO = :F_VASOESPANSIONECARICO,
    AM.F_ORGSOGGSOLLECITAZTERMINTEGRI = :F_ORGSOGGSOLLECITAZTERMINTEGRI,
    AM.F_DISPROMPITIRAGGIONODETERIOR = :F_DISPROMPITIRAGGIONODETERIOR,
    AM.F_VALVOLASICUREZZASOVRAPRESS = :F_VALVOLASICUREZZASOVRAPRESS,
    AM.F_CIRCUITOARIAPULITO = :F_CIRCUITOARIAPULITO,
    AM.F_GUARNIZACCOPIAMINTEGRA = :F_GUARNIZACCOPIAMINTEGRA,
    AM.G_CONTROLLOASSENZAFUGHEGAS = :G_CONTROLLOASSENZAFUGHEGAS,
    AM.G_ESAMEVISIVOCOIBENTAZIONI = :G_ESAMEVISIVOCOIBENTAZIONI,
    AM.G_ESAMEVISIVOCAMINO = :G_ESAMEVISIVOCAMINO,

    AM.B_LIBRETTOIMPIANTOCOMPILATO = :B_LIBRETTOIMPIANTOCOMPILATO,
    AM.C_EXTINST_GENERATOREIDONEO = :C_EXTINST_GENERATOREIDONEO,
    AM.F_SISTIREGOLAZTEMPFUNZIONANTE = :F_SISTIREGOLAZTEMPFUNZIONANTE,
    AM.G_ASSENZAPERDITECOMBLIQUIDO = :G_ASSENZAPERDITECOMBLIQUIDO,
    AM.G_RISCTRLUNI10389_1 = :G_RISCTRLUNI10389_1,
    AM.CHKLST_ADOZVALVTERMOST = :CHKLST_ADOZVALVTERMOST,
    AM.CHKLST_ISOLAMRETEDISTRIB = :CHKLST_ISOLAMRETEDISTRIB,
    AM.CHKLST_SISTTRATTAMACQUA = :CHKLST_SISTTRATTAMACQUA,
    AM.CHKLST_SOSTSISTREGOLAZ = :CHKLST_SOSTSISTREGOLAZ,
    AM.TH2O_DUREZZATOTALE = :TH2O_DUREZZATOTALE,
    AM.TH2O_TRATTRISCALDAM = :TH2O_TRATTRISCALDAM,
    AM.TH2O_TRATTACS = :TH2O_TRATTACS

  WHERE AM.ID = :in_IdAllegatoDest;

  /* Fine ed uscita */
  Exit;

END^

SET TERM ; ^

