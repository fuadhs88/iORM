/* 
   =================================================
   Vista che aggiunge alla vista dei righi base il calcolo del prezzo 
   di vendita.
   =================================================
*/

CREATE VIEW GC_BASE_PRZVEND
(
  /* ---------------------------------- */
  /* CAMPI PRESI DALLA VISTA PRECEDENTE */
  /* ---------------------------------- */
   TipoDocumento
  ,NumOrdPrev
  ,Registro
  ,DATADOCUMENTO
  ,PROGRIGO
  ,PROGRIGO2
  ,CAUSALE
  ,CODICECLIENTE

  ,PRATICA
  ,DATAPRATICA1
  ,DATACHIUSURAPRATICA1
  ,STATODESCRIZIONEPRATICA1
  ,RIFPRATICA
  ,CODSOGGPRAT
  ,PRAT_PRZUNITOPERA1_1
  ,PRAT_PRZUNITOPERA1_2
  ,PRAT_PRZUNITOPERA1_3
  ,PRAT_PRZUNITOPERA1_4
  ,PRAT_PRZUNITOPERA1_5
  ,PRAT_TIPORICARICO
  ,PRAT_TIPORICDACOMMESSA
  ,PRAT_RICARICOPERC
  ,PRAT_LISTINO
  ,OPERAINDEX
  ,OPERACODICE
  ,OPERADESCRIZIONE

  ,GUID
  ,GUID_REF
  ,GUID_ANCESTOR
  ,TRACK_PREVENTIVO
  ,TRACK_COMMESSA
  ,TRACK_DDT
  ,TRACK_FATTURA
  ,TRACK_ESTRATTO_CONTO
  ,TRACK_SAL
  ,TRACK_BOLLA_ENTR
  ,TRACK_FATT_ACQUI
  ,TRACK_ORD_FORN

  ,SEGNOOPERAZIONECANTIERE
  ,SEGNOOPERAZIONE
  ,GC_SEZIONE
  ,STATODESCRIZIONE
  ,STATOFOREGROUND

  ,DOCUMENTO
  ,SOGGETTO

  ,CodiceMagazzino
  ,MovMag
  ,CodiceArticolo
  ,Descrizione
  ,PrezzoUnitario
  ,UnitaDiMisura
  ,Qta
  ,ScontoRigo
  ,ScontoRigo2
  ,ScontoRigo3
  ,ImportoRigo
  ,PREZZOACQUISTOARTICOLO
  ,IMPORTOACQUISTOARTICOLO
  ,NOTERIGO
  ,MARGINE
  ,PREZZOUNITARIONETTO
  ,CodiceIVA
  ,DescrizioneIVA
  ,AliquotaIVA

  ,SOTTOCANTIERE1
  ,SOTTOCANTIERE2
  ,SOTTOCANTIERE3
  ,SOTTOCANTIERE4
  ,SOTTOCANTIERE5
  ,SOTTOCANTIERE6

  ,CATEGCANT1
  ,CATEGCANT2
  ,CATEGCANT3
  ,CATEGCANT4
  ,CATEGCANT5
  ,CATEGCANT6

  ,S3RIF
  ,S3UBICAZIONE
  ,S3COMPONENTE
  ,S3MATERIALE
  ,S3QTA
  ,S3DIAMETRO
  ,S3LUNGHEZZA
  ,S3INSTALLAZIONE
  ,S3CERTIFICAZIONE
  ,S3VENTILAZIONE
  ,S3SCARICO
  ,S3TIPO
  ,S3PORTATATERMICA
  ,S3TIPOCOLLEGAMENTO
  ,S3INSTALLATOINSTALLABILE
  ,S3MODELLO

  ,TIPOLOGIA

  ,GC_COSTONETTOUNITARIO_MOD
  ,GC_COSTONETTOUNITARIO

  ,GC_RICARICO_MOD
  ,GC_RICARICO

  ,GC_QTA_MOD
  ,GC_QTA

  ,GC_DESCRIZIONE_MOD
  ,GC_DESCRIZIONE

  /* ------------------------------ */
  /* CAMPI AGGIUNTI IN QUESTA VISTA */
  /* ------------------------------ */
  ,GC_PRZVEND
  ,GC_PRESENTEINCOMMESSA
  ,GC_PRZVENDDACOMMESSA
)

AS


/* =================================================
   |   VISTA BASE RIGHI                            |
   =================================================
*/
SELECT

  /* ---------------------------------- */
  /* CAMPI PRESI DALLA VISTA PRECEDENTE */
  /* ---------------------------------- */
   TipoDocumento
  ,NumOrdPrev
  ,Registro
  ,DATADOCUMENTO
  ,PROGRIGO
  ,PROGRIGO2
  ,CAUSALE
  ,CODICECLIENTE

  ,PRATICA
  ,DATAPRATICA1
  ,DATACHIUSURAPRATICA1
  ,STATODESCRIZIONEPRATICA1
  ,RIFPRATICA
  ,CODSOGGPRAT
  ,PRAT_PRZUNITOPERA1_1
  ,PRAT_PRZUNITOPERA1_2
  ,PRAT_PRZUNITOPERA1_3
  ,PRAT_PRZUNITOPERA1_4
  ,PRAT_PRZUNITOPERA1_5
  ,PRAT_TIPORICARICO
  ,PRAT_TIPORICDACOMMESSA
  ,PRAT_RICARICOPERC
  ,PRAT_LISTINO
  ,OPERAINDEX
  ,OPERACODICE
  ,OPERADESCRIZIONE

  ,GUID
  ,GUID_REF
  ,GUID_ANCESTOR
  ,TRACK_PREVENTIVO
  ,TRACK_COMMESSA
  ,TRACK_DDT
  ,TRACK_FATTURA
  ,TRACK_ESTRATTO_CONTO
  ,TRACK_SAL
  ,TRACK_BOLLA_ENTR
  ,TRACK_FATT_ACQUI
  ,TRACK_ORD_FORN

  ,SEGNOOPERAZIONECANTIERE
  ,SEGNOOPERAZIONE
  ,GC_SEZIONE
  ,STATODESCRIZIONE
  ,STATOFOREGROUND

  ,DOCUMENTO
  ,SOGGETTO

  ,CodiceMagazzino
  ,MovMag
  ,CodiceArticolo
  ,Descrizione
  ,PrezzoUnitario
  ,UnitaDiMisura
  ,Qta
  ,ScontoRigo
  ,ScontoRigo2
  ,ScontoRigo3
  ,ImportoRigo
  ,PREZZOACQUISTOARTICOLO
  ,IMPORTOACQUISTOARTICOLO
  ,NOTERIGO
  ,MARGINE
  ,PREZZOUNITARIONETTO
  ,CodiceIVA
  ,DescrizioneIVA
  ,AliquotaIVA

  ,SOTTOCANTIERE1
  ,SOTTOCANTIERE2
  ,SOTTOCANTIERE3
  ,SOTTOCANTIERE4
  ,SOTTOCANTIERE5
  ,SOTTOCANTIERE6

  ,CATEGCANT1
  ,CATEGCANT2
  ,CATEGCANT3
  ,CATEGCANT4
  ,CATEGCANT5
  ,CATEGCANT6

  ,S3RIF
  ,S3UBICAZIONE
  ,S3COMPONENTE
  ,S3MATERIALE
  ,S3QTA
  ,S3DIAMETRO
  ,S3LUNGHEZZA
  ,S3INSTALLAZIONE
  ,S3CERTIFICAZIONE
  ,S3VENTILAZIONE
  ,S3SCARICO
  ,S3TIPO
  ,S3PORTATATERMICA
  ,S3TIPOCOLLEGAMENTO
  ,S3INSTALLATOINSTALLABILE
  ,S3MODELLO

  ,TIPOLOGIA

  /* ------------------------------------------------------------------------------------------------------------------ */
  /* Se siamo al costo medio prende il costo medio altrimenti prende il dato grezzo dal rigo				*/
  /* ------------------------------------------------------------------------------------------------------------------ */
  ,GC_COSTONETTOUNITARIO_MOD
  ,GC_COSTONETTOUNITARIO 

  /* ------------------------------------------------------------------------------------------------------------------ */
  /* Se è una manodopera il prezzo di vendita è fisso e determinato dal cantiere e in questo caso ricalcola il ricarico */
  /* NB: Anche se si deve essere valutato alla vendita come da commessa.
  /* ------------------------------------------------------------------------------------------------------------------ */
  ,GC_RICARICO_MOD
  ,CASE 
     WHEN (TIPOLOGIA='Manodopera') AND ((SEGNOOPERAZIONECANTIERE = 'F') OR (SEGNOOPERAZIONECANTIERE = 'C')) THEN MARGINE
     WHEN (TIPOLOGIA='Manodopera' AND OPERAINDEX=0 AND GC_COSTONETTOUNITARIO<>0) THEN (PRAT_PRZUNITOPERA1_1 - GC_COSTONETTOUNITARIO) * 100 / GC_COSTONETTOUNITARIO 
     WHEN (TIPOLOGIA='Manodopera' AND OPERAINDEX=1 AND GC_COSTONETTOUNITARIO<>0) THEN (PRAT_PRZUNITOPERA1_2 - GC_COSTONETTOUNITARIO) * 100 / GC_COSTONETTOUNITARIO 
     WHEN (TIPOLOGIA='Manodopera' AND OPERAINDEX=2 AND GC_COSTONETTOUNITARIO<>0) THEN (PRAT_PRZUNITOPERA1_3 - GC_COSTONETTOUNITARIO) * 100 / GC_COSTONETTOUNITARIO 
     WHEN (TIPOLOGIA='Manodopera' AND OPERAINDEX=3 AND GC_COSTONETTOUNITARIO<>0) THEN (PRAT_PRZUNITOPERA1_4 - GC_COSTONETTOUNITARIO) * 100 / GC_COSTONETTOUNITARIO 
     WHEN (TIPOLOGIA='Manodopera' AND OPERAINDEX=4 AND GC_COSTONETTOUNITARIO<>0) THEN (PRAT_PRZUNITOPERA1_5 - GC_COSTONETTOUNITARIO) * 100 / GC_COSTONETTOUNITARIO 
     WHEN (TIPOLOGIA='Materiali / Apparecchi') AND (PRAT_TIPORICDACOMMESSA='T') AND (GC_RICARICO_MOD<>'T') AND (SEGNOOPERAZIONECANTIERE <> 'F') AND (SEGNOOPERAZIONECANTIERE <> 'C') AND ((SELECT * FROM GC_GET_PRZVEND_COMMESSA(CODICEARTICOLO, PRATICA, DATAPRATICA1)) IS NOT NULL) AND (GC_COSTONETTOUNITARIO<>0) THEN (((SELECT * FROM GC_GET_PRZVEND_COMMESSA(CODICEARTICOLO, PRATICA, DATAPRATICA1)) - GC_COSTONETTOUNITARIO) * 100 / GC_COSTONETTOUNITARIO)
     ELSE GC_RICARICO
   END

  ,GC_QTA_MOD
  ,GC_QTA

  ,GC_DESCRIZIONE_MOD
  ,GC_DESCRIZIONE

  /* ------------------------------ */
  /* CAMPI AGGIUNTI IN QUESTA VISTA */
  /* ------------------------------ */
  ,CASE 
     WHEN (TIPOLOGIA='Manodopera') AND ((SEGNOOPERAZIONECANTIERE = 'F') OR (SEGNOOPERAZIONECANTIERE = 'C')) THEN PREZZOUNITARIONETTO
     WHEN (TIPOLOGIA='Manodopera' AND OPERAINDEX=0) THEN PRAT_PRZUNITOPERA1_1
     WHEN (TIPOLOGIA='Manodopera' AND OPERAINDEX=1) THEN PRAT_PRZUNITOPERA1_2
     WHEN (TIPOLOGIA='Manodopera' AND OPERAINDEX=2) THEN PRAT_PRZUNITOPERA1_3
     WHEN (TIPOLOGIA='Manodopera' AND OPERAINDEX=3) THEN PRAT_PRZUNITOPERA1_4
     WHEN (TIPOLOGIA='Manodopera' AND OPERAINDEX=4) THEN PRAT_PRZUNITOPERA1_5
     WHEN (TIPOLOGIA='Materiali / Apparecchi') AND (PRAT_TIPORICDACOMMESSA='T') AND (GC_RICARICO_MOD<>'T') AND (SEGNOOPERAZIONECANTIERE <> 'F') AND (SEGNOOPERAZIONECANTIERE <> 'C') AND ((SELECT * FROM GC_GET_PRZVEND_COMMESSA(CODICEARTICOLO, PRATICA, DATAPRATICA1)) IS NOT NULL) THEN (SELECT * FROM GC_GET_PRZVEND_COMMESSA(CODICEARTICOLO, PRATICA, DATAPRATICA1))
     ELSE CAST(GC_COSTONETTOUNITARIO * (100 + GC_RICARICO) / 100 AS NUMERIC(11,4))
   END

  ,CASE
     WHEN (TIPOLOGIA='Materiali / Apparecchi') AND (SEGNOOPERAZIONECANTIERE <> 'F') AND (SEGNOOPERAZIONECANTIERE <> 'C') THEN (SELECT * FROM GC_GET_PRESENTEINCOMMESSA(CODICEARTICOLO, PRATICA, DATAPRATICA1))
     ELSE CAST('F' AS CHAR(1))
   END

  ,CASE
     WHEN (TIPOLOGIA='Materiali / Apparecchi') AND (PRAT_TIPORICDACOMMESSA='T') AND (GC_RICARICO_MOD<>'T') AND (SEGNOOPERAZIONECANTIERE <> 'F') AND (SEGNOOPERAZIONECANTIERE <> 'C') AND ((SELECT * FROM GC_GET_PRZVEND_COMMESSA(CODICEARTICOLO, PRATICA, DATAPRATICA1)) IS NOT NULL) THEN CAST('T' AS CHAR(1))
     ELSE CAST('F' AS CHAR(1))
   END


FROM GC_BASE_COSTOMEDIO
