CREATE VIEW COM_BASE_VIEW (
  ID
 ,RIF_ID
 ,RIF_TIPO
 ,RIF_DATO
 ,RIF_TIMEOFFSET_DAYS
 ,RIF_EXPIRATION_DAYS
 ,RIF_NOAPPUNTAMENTO
 ,RIF_DATAORASCADENZA
 ,RIF_TIME_THRESHOLD
 ,RIF_TIME_EXPIRED
 ,RIF_DESCRIZIONE
 ,MSG_TYPE_LETTER
 ,MSG_TYPE_EMAIL
 ,MSG_TYPE_SMS
 ,MSG_OGGETTO
 ,SOGG_CODICE
 ,SOGG_RAGSOC
 ,SOGG_INDIRIZZO
 ,SOGG_NUMCIVICO
 ,SOGG_COMUNE
 ,SOGG_PROVINCIA
 ,SOGG_CAP
 ,SOGG_CELLULARE
 ,SOGG_EMAIL
 ,SOGG_INQUALITADI
 ,SOGG_COM_SMS
 ,SOGG_COM_EMAIL
 ,SOGG_COM_LETTERA
 ,PRAT_CODICE
 ,PRAT_DATA
 ,PRAT_ID
 ,PRAT_DESCRIZIONE
 ,PRAT_COM_SMS
 ,PRAT_COM_EMAIL
 ,PRAT_COM_LETTERA

) AS

/*======================================================
IMPIANTI - DATA PROX VISITA
======================================================*/
SELECT
  CI.ID
 ,P.ID AS RIF_ID
 ,CAST('Impianti' AS VARCHAR(20)) AS RIF_TIPO
 ,CI.RIF_DATO
 ,CI.RIF_TIMEOFFSET_DAYS
 ,CI.RIF_EXPIRATION_DAYS
 ,CI.RIF_NOAPPUNTAMENTO
 ,P.PROXVISITAENTRO AS RIF_DATAORASCADENZA
 ,CAST(   P.PROXVISITAENTRO+CI.RIF_TIMEOFFSET_DAYS   AS TIMESTAMP) AS RIF_TIME_THRESHOLD
 ,CAST(   P.PROXVISITAENTRO+CI.RIF_TIMEOFFSET_DAYS+CI.RIF_EXPIRATION_DAYS   AS TIMESTAMP) AS RIF_TIME_EXPIRED
 ,CAST(P.DESCRIZIONE AS VARCHAR(250)) AS RIF_DESCRIZIONE
 ,CI.MSGTYPE_LETTER AS MSG_TYPE_LETTER 
 ,CI.MSGTYPE_EMAIL AS MSG_TYPE_EMAIL
 ,CI.MSGTYPE_SMS AS MSG_TYPE_SMS
 ,CI.MSG_OGGETTO
 ,P.CLIENTE AS SOGG_CODICE
 ,P.RAGSOCRESPIMP AS SOGG_RAGSOC
 ,P.INDIRIZZORESPIMP AS SOGG_INDIRIZZO
 ,P.NUMCIVICORESPIMP AS SOGG_NUMCIVICO
 ,P.CITTARESPIMP AS SOGG_COMUNE
 ,P.PROVINCIARESPIMP AS SOGG_PROVINCIA
 ,P.CAPRESPIMP AS SOGG_CAP
 ,P.CELLULARERESPIMP AS SOGG_CELLULARE
 ,CLI.EMAIL AS SOGG_EMAIL
 ,P.INQUALITADIRESPIMP AS SOGG_INQUALITADI
 ,CLI.COM_SMS AS SOGG_COM_SMS
 ,CLI.COM_EMAIL AS SOGG_COM_EMAIL
 ,CLI.COM_LETTERA AS SOGG_COM_LETTERA
 ,P.CODICE AS PRAT_CODICE
 ,P.DATAAPERTURA AS PRAT_DATA
 ,P.ID AS PRAT_ID
 ,P.DESCRIZIONE AS PRAT_DESCRIZIONE
 ,P.COM_SMS AS PRAT_COM_SMS
 ,P.COM_EMAIL AS PRAT_COM_EMAIL
 ,P.COM_LETTERA AS PRAT_COM_LETTERA
FROM COM_IMPOSTAZIONI CI
JOIN PRATICHE P ON (P.TIPO='A' AND P.PROXVISITAENTRO IS NOT NULL)
LEFT JOIN CLIENTI CLI ON (CLI.CODICE=P.CLIENTE)
WHERE CI.RIF_DATO = 'Impianti: Data prox visita'
/*======================================================*/

UNION ALL

/*======================================================
APPUNTAMENTI - DATA APPUNTAMENTO
======================================================*/
SELECT
  CI.ID
 ,I.MASTER_ID AS RIF_ID
 ,CAST('Appuntamenti' AS VARCHAR(20)) AS RIF_TIPO
 ,CI.RIF_DATO
 ,CI.RIF_TIMEOFFSET_DAYS
 ,CI.RIF_EXPIRATION_DAYS
 ,CI.RIF_NOAPPUNTAMENTO
 ,I.START_EVENT AS RIF_DATAORASCADENZA
 ,CAST(   I.START_EVENT+CI.RIF_TIMEOFFSET_DAYS   AS TIMESTAMP) AS RIF_TIME_THRESHOLD
 ,CAST(   I.START_EVENT+CI.RIF_TIMEOFFSET_DAYS+CI.RIF_EXPIRATION_DAYS   AS TIMESTAMP) AS RIF_TIME_EXPIRED
 ,CAST(     'Appuntamento del ' || substring(100+extract(day from I.START_EVENT) from 2 for 2) || '/' || substring(100+extract(month from I.START_EVENT) from 2 for 2) || '/' || extract(year from I.START_EVENT) || ' ore ' || extract(hour from I.START_EVENT) || '.' || substring(100+extract(minute from I.START_EVENT) from 2 for 2)      AS VARCHAR(250)) AS RIF_DESCRIZIONE
 ,CI.MSGTYPE_LETTER AS MSG_TYPE_LETTER 
 ,CI.MSGTYPE_EMAIL AS MSG_TYPE_EMAIL
 ,CI.MSGTYPE_SMS AS MSG_TYPE_SMS
 ,CI.MSG_OGGETTO
 ,I.CLIENTE AS SOGG_CODICE
 ,CLI.RAGIONESOCIALE AS SOGG_RAGSOC
 ,CLI.INDIRIZZO AS SOGG_INDIRIZZO
 ,CLI.NUMCIVICO AS SOGG_NUMCIVICO
 ,CLI.CITTA AS SOGG_COMUNE
 ,CLI.PROVINCIA AS SOGG_PROVINCIA
 ,CLI.CAP AS SOGG_CAP
 ,CLI.CELLULARE AS SOGG_CELLULARE
 ,CLI.EMAIL AS SOGG_EMAIL
 ,CAST('' AS VARCHAR(20)) AS SOGG_INQUALITADI
 ,CLI.COM_SMS AS SOGG_COM_SMS
 ,CLI.COM_EMAIL AS SOGG_COM_EMAIL
 ,CLI.COM_LETTERA AS SOGG_COM_LETTERA
 ,I.PRATICA AS PRAT_CODICE
 ,I.DATAPRATICA1 AS PRAT_DATA
 ,I.IDPRATICA AS PRAT_ID
 ,P.DESCRIZIONE AS PRAT_DESCRIZIONE
 ,P.COM_SMS AS PRAT_COM_SMS
 ,P.COM_EMAIL AS PRAT_COM_EMAIL
 ,P.COM_LETTERA AS PRAT_COM_LETTERA
FROM COM_IMPOSTAZIONI CI
JOIN IMPEGNI I ON (I.TIPOIMPEGNO='Appuntamento' AND I.START_EVENT IS NOT NULL)
LEFT JOIN PRATICHE P ON (P.ID=I.IDPRATICA)
LEFT JOIN CLIENTI CLI ON (CLI.CODICE=I.CLIENTE)
WHERE CI.RIF_DATO = 'Appuntamenti: Data appuntamento'
/*======================================================*/

UNION ALL

/*======================================================
INTERVENTI - DATA INTERVENTO
======================================================*/
SELECT
  CI.ID
 ,I.MASTER_ID AS RIF_ID
 ,CAST('Interventi' AS VARCHAR(20)) AS RIF_TIPO
 ,CI.RIF_DATO
 ,CI.RIF_TIMEOFFSET_DAYS
 ,CI.RIF_EXPIRATION_DAYS
 ,CI.RIF_NOAPPUNTAMENTO
 ,I.DATAORAINTERVENTO AS RIF_DATAORASCADENZA
 ,CAST(   I.DATAORAINTERVENTO+CI.RIF_TIMEOFFSET_DAYS   AS TIMESTAMP) AS RIF_TIME_THRESHOLD
 ,CAST(   I.DATAORAINTERVENTO+CI.RIF_TIMEOFFSET_DAYS+CI.RIF_EXPIRATION_DAYS   AS TIMESTAMP) AS RIF_TIME_EXPIRED
 ,CAST(     'Intervento del ' || substring(100+extract(day from I.DATAORAINTERVENTO) from 2 for 2) || '/' || substring(100+extract(month from I.DATAORAINTERVENTO) from 2 for 2) || '/' || extract(year from I.DATAORAINTERVENTO) || ' ore ' || extract(hour from I.DATAORAINTERVENTO) || '.' || substring(100+extract(minute from DATAORAINTERVENTO) from 2 for 2)      AS VARCHAR(250)) AS RIF_DESCRIZIONE
 ,CI.MSGTYPE_LETTER AS MSG_TYPE_LETTER 
 ,CI.MSGTYPE_EMAIL AS MSG_TYPE_EMAIL
 ,CI.MSGTYPE_SMS AS MSG_TYPE_SMS
 ,CI.MSG_OGGETTO
 ,I.CLIENTE AS SOGG_CODICE
 ,CLI.RAGIONESOCIALE AS SOGG_RAGSOC
 ,CLI.INDIRIZZO AS SOGG_INDIRIZZO
 ,CLI.NUMCIVICO AS SOGG_NUMCIVICO
 ,CLI.CITTA AS SOGG_COMUNE
 ,CLI.PROVINCIA AS SOGG_PROVINCIA
 ,CLI.CAP AS SOGG_CAP
 ,CLI.CELLULARE AS SOGG_CELLULARE
 ,CLI.EMAIL AS SOGG_EMAIL
 ,CAST('' AS VARCHAR(20)) AS SOGG_INQUALITADI
 ,CLI.COM_SMS AS SOGG_COM_SMS
 ,CLI.COM_EMAIL AS SOGG_COM_EMAIL
 ,CLI.COM_LETTERA AS SOGG_COM_LETTERA
 ,I.PRATICA AS PRAT_CODICE
 ,I.DATAPRATICA1 AS PRAT_DATA
 ,I.IDPRATICA AS PRAT_ID
 ,P.DESCRIZIONE AS PRAT_DESCRIZIONE
 ,P.COM_SMS AS PRAT_COM_SMS
 ,P.COM_EMAIL AS PRAT_COM_EMAIL
 ,P.COM_LETTERA AS PRAT_COM_LETTERA
FROM COM_IMPOSTAZIONI CI
JOIN IMPEGNI I ON (I.TIPOIMPEGNO='Intervento' AND I.DATAORAINTERVENTO IS NOT NULL)
LEFT JOIN PRATICHE P ON (P.ID=I.IDPRATICA)
LEFT JOIN CLIENTI CLI ON (CLI.CODICE=I.CLIENTE)
WHERE CI.RIF_DATO = 'Intervento: Data intervento'
/*======================================================*/

UNION ALL

/*======================================================
SCADENZE - DATA SCADENZA
======================================================*/
SELECT
  CI.ID
 ,S.ID AS RIF_ID
 ,CAST('Scadenza' AS VARCHAR(20)) AS RIF_TIPO
 ,CI.RIF_DATO
 ,CI.RIF_TIMEOFFSET_DAYS
 ,CI.RIF_EXPIRATION_DAYS
 ,CI.RIF_NOAPPUNTAMENTO
 ,S.DATASCADENZA AS RIF_DATAORASCADENZA
 ,CAST(   S.DATASCADENZA+CI.RIF_TIMEOFFSET_DAYS AS TIMESTAMP) AS RIF_TIME_THRESHOLD
 ,CAST(   S.DATASCADENZA+CI.RIF_TIMEOFFSET_DAYS+CI.RIF_EXPIRATION_DAYS AS TIMESTAMP) AS RIF_TIME_EXPIRED
 ,CAST(   'Scadenza del ' || substring(100+extract(day from s.DATASCADENZA) from 2 for 2) || '/' || substring(100+extract(month from S.DATASCADENZA) from 2 for 2) || '/' || extract(year from S.DATASCADENZA) || ' EUR ' || S.IMPORTO || ' (' || S.TIPODOC || ' ' || S.NUMDOC || S.REGISTRO || ' del ' || S.DATADOC || ')'    AS VARCHAR(250)) AS RIF_DESCRIZIONE
 ,CI.MSGTYPE_LETTER AS MSG_TYPE_LETTER 
 ,CI.MSGTYPE_EMAIL AS MSG_TYPE_EMAIL
 ,CI.MSGTYPE_SMS AS MSG_TYPE_SMS
 ,CI.MSG_OGGETTO
 ,S.CLIENTE AS SOGG_CODICE
 ,CLI.RAGIONESOCIALE AS SOGG_RAGSOC
 ,CLI.INDIRIZZO AS SOGG_INDIRIZZO
 ,CLI.NUMCIVICO AS SOGG_NUMCIVICO
 ,CLI.CITTA AS SOGG_COMUNE
 ,CLI.PROVINCIA AS SOGG_PROVINCIA
 ,CLI.CAP AS SOGG_CAP
 ,CLI.CELLULARE AS SOGG_CELLULARE
 ,CLI.EMAIL AS SOGG_EMAIL
 ,CAST('' AS VARCHAR(20)) AS SOGG_INQUALITADI
 ,CLI.COM_SMS AS SOGG_COM_SMS
 ,CLI.COM_EMAIL AS SOGG_COM_EMAIL
 ,CLI.COM_LETTERA AS SOGG_COM_LETTERA
 ,S.PRATICA AS PRAT_CODICE
 ,S.DATAPRATICA1 AS PRAT_DATA
 ,P.ID AS PRAT_ID
 ,P.DESCRIZIONE AS PRAT_DESCRIZIONE
 ,P.COM_SMS AS PRAT_COM_SMS
 ,P.COM_EMAIL AS PRAT_COM_EMAIL
 ,P.COM_LETTERA AS PRAT_COM_LETTERA
FROM COM_IMPOSTAZIONI CI
JOIN SCADENZ S ON (S.TIPO='Scad.attiv')
LEFT JOIN PRATICHE P ON (P.CODICE=S.PRATICA AND P.DATAAPERTURA=S.DATAPRATICA1)
LEFT JOIN CLIENTI CLI ON (CLI.CODICE=S.CLIENTE)
WHERE CI.RIF_DATO = 'Scadenze: Data scadenza'
  AND S.IMPORTO <> 0
  AND S.IMPORTOPAGATO <> S.IMPORTO
/*======================================================*/

UNION ALL

/*======================================================
CORRISPETTIVO NON PAGATO - DATA
======================================================*/
SELECT
  CI.ID
 ,VSL.ID AS RIF_ID
 ,CAST('Corrisp. non pagato' AS VARCHAR(20)) AS RIF_TIPO
 ,CI.RIF_DATO
 ,CI.RIF_TIMEOFFSET_DAYS
 ,CI.RIF_EXPIRATION_DAYS
 ,CI.RIF_NOAPPUNTAMENTO
 ,VSL.DATADOC AS RIF_DATAORASCADENZA
 ,CAST(   VSL.DATADOC+CI.RIF_TIMEOFFSET_DAYS AS TIMESTAMP) AS RIF_TIME_THRESHOLD
 ,CAST(   VSL.DATADOC+CI.RIF_TIMEOFFSET_DAYS+CI.RIF_EXPIRATION_DAYS AS TIMESTAMP) AS RIF_TIME_EXPIRED
 ,CAST(   'Corrispettivo non pagato ' || '  (' || VSL.TIPODOC || ' ' || VSL.NUMDOC || VSL.REGISTRO || ' del ' || VSL.DATADOC || ')'    AS VARCHAR(250)) AS RIF_DESCRIZIONE
 ,CI.MSGTYPE_LETTER AS MSG_TYPE_LETTER 
 ,CI.MSGTYPE_EMAIL AS MSG_TYPE_EMAIL
 ,CI.MSGTYPE_SMS AS MSG_TYPE_SMS
 ,CI.MSG_OGGETTO
 ,VSL.CLIENTE AS SOGG_CODICE
 ,CLI.RAGIONESOCIALE AS SOGG_RAGSOC
 ,CLI.INDIRIZZO AS SOGG_INDIRIZZO
 ,CLI.NUMCIVICO AS SOGG_NUMCIVICO
 ,CLI.CITTA AS SOGG_COMUNE
 ,CLI.PROVINCIA AS SOGG_PROVINCIA
 ,CLI.CAP AS SOGG_CAP
 ,CLI.CELLULARE AS SOGG_CELLULARE
 ,CLI.EMAIL AS SOGG_EMAIL
 ,CAST('' AS VARCHAR(20)) AS SOGG_INQUALITADI
 ,CLI.COM_SMS AS SOGG_COM_SMS
 ,CLI.COM_EMAIL AS SOGG_COM_EMAIL
 ,CLI.COM_LETTERA AS SOGG_COM_LETTERA
 ,VSL.PRATICA AS PRAT_CODICE
 ,VSL.DATAPRATICA1 AS PRAT_DATA
 ,P.ID AS PRAT_ID
 ,P.DESCRIZIONE AS PRAT_DESCRIZIONE
 ,P.COM_SMS AS PRAT_COM_SMS
 ,P.COM_EMAIL AS PRAT_COM_EMAIL
 ,P.COM_LETTERA AS PRAT_COM_LETTERA
FROM COM_IMPOSTAZIONI CI
JOIN SCAD_LIST_VIEW VSL ON (VSL.TIPOLOGIA='Corrispettivi non pagati')
LEFT JOIN PRATICHE P ON (P.CODICE=VSL.PRATICA AND P.DATAAPERTURA=VSL.DATAPRATICA1)
LEFT JOIN CLIENTI CLI ON (CLI.CODICE=VSL.CLIENTE)
WHERE CI.RIF_DATO = 'Corrisp. non pagati: Data documento'
/*======================================================*/
;