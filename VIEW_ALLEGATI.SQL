
/* View: ALLEGATI_VIEW, Owner: 1DR0GAT3 */

CREATE VIEW ALLEGATI_VIEW (

  NUMPROT,
  REVPROT,
  ANNOPROT,
  FULLPROT,

  TIPODOC,
  NUMDOC,
  REGDOC,
  DATADOC,
  ALL_DOCUMENTO,

  CODSOGG,
  ALL_SOGGETTO,

  CODICEARTICOLO,
  ALL_ARTICOLO,

  CODPRAT,
  DATAPRAT,
  ALL_RIFPRATICA,

  NOTE,
  FILE_EXT,
  FILE_NAME,
  FILE_BLOB_PRESENT,

  CREAZ_OPERATORE,
  CREAZ_DATAORA,
  TRACK_CREAZIONE,

  ULTMOD_OPERATORE,
  ULTMOD_DATAORA,
  TRACK_ULTIMAMODIFICA,

  DOC_CODSOGG,
  DOC_SOGGETTO,

  DOC_CODPRAT,
  DOC_DATAPRAT,
  DOC_RIFPRATICA,
  
  ALARM_DATAORA,
  ALARM_FATTO,

  PA_ALLEGA

) AS

SELECT A.NUMPROT
      ,A.REVPROT
      ,A.ANNOPROT
      ,CAST(A.ANNOPROT || '.' || A.NUMPROT || '.' || A.REVPROT AS VARCHAR(30)) AS FULLPROT
      
      ,A.TIPODOC
      ,A.NUMDOC
      ,A.REGDOC
      ,A.DATADOC
      ,CAST(A.TIPODOC || COALESCE(A.NUMDOC || ' ','') || COALESCE(A.REGDOC || ' ','') || COALESCE('del ' || A.DATADOC || ' ','') AS VARCHAR(200)) AS ALL_DOCUMENTO

      ,A.CODSOGG
      ,CAST(C.RAGIONESOCIALE || '  (' || A.CODSOGG || ')' AS VARCHAR(100)) AS ALL_SOGGETTO

      ,ART.CODICEARTICOLO
      ,CAST(ART.CODICEARTICOLO || ' - ' || SUBSTRING(ART.DESCRIZIONE FROM 1 FOR 60) AS VARCHAR(100)) AS ALL_ARTICOLO

      ,A.CODPRAT
      ,A.DATAPRAT
      ,CAST((SELECT FIRST 1 P.DESCRIZIONE FROM Pratiche P WHERE P.Codice=A.CODPRAT AND P.DataApertura=A.DATAPRAT)||'  ('||A.CODPRAT|| ', '||A.DATAPRAT||')' AS VARCHAR(200)) AS ALL_RIFPRATICA

      ,A.NOTE
      ,A.FILE_EXT
      ,A.FILE_NAME
      ,CAST(   (CASE WHEN (A.FILE_BLOB IS NULL) THEN 'F' ELSE 'T' END)   AS CHAR(1))


      ,A.CREAZ_OPERATORE
      ,A.CREAZ_DATAORA
      ,CAST(COALESCE(A.CREAZ_OPERATORE || ' il ','') || EXTRACT(DAY FROM A.CREAZ_DATAORA)||'/'||EXTRACT(MONTH FROM A.CREAZ_DATAORA)||'/'||EXTRACT(YEAR FROM A.CREAZ_DATAORA)||' ore '||EXTRACT(HOUR FROM A.CREAZ_DATAORA)||'.'||EXTRACT(MINUTE FROM A.CREAZ_DATAORA)    AS VARCHAR (40)) AS TRACK_CREAZIONE

      ,A.ULTMOD_OPERATORE
      ,A.ULTMOD_DATAORA
      ,CAST(COALESCE(A.ULTMOD_OPERATORE || ' il ','') || EXTRACT(DAY FROM A.ULTMOD_DATAORA)||'/'||EXTRACT(MONTH FROM A.ULTMOD_DATAORA)||'/'||EXTRACT(YEAR FROM A.ULTMOD_DATAORA)||' ore '||EXTRACT(HOUR FROM A.ULTMOD_DATAORA)||'.'||EXTRACT(MINUTE FROM A.ULTMOD_DATAORA)    AS VARCHAR (40)) AS TRACK_ULTIMAMODIFICA

      ,DOC.CODICECLIENTE
      ,CAST(DOC.RAGSOCCLI || '  (' || DOC.CODICECLIENTE || ')' AS VARCHAR(100)) AS DOC_SOGGETTO

      ,DOC.PRATICA
      ,DOC.DATAPRATICA1
      ,CAST((SELECT FIRST 1 (CASE P.TIPO WHEN 'A' THEN P.COSTRUTTORE||' '||P.MODELLO ELSE P.DESCRIZIONE END) FROM Pratiche P WHERE P.Codice=DOC.PRATICA AND P.DataApertura=DOC.DATAPRATICA1)||'  ('||DOC.PRATICA|| ', '||DOC.DATAPRATICA1||')' AS VARCHAR(200)) AS DOC_RIFPRATICA

      ,A.ALARM_DATAORA
      ,A.ALARM_FATTO

      ,A.PA_ALLEGA

FROM ALLEGATI A
LEFT OUTER JOIN CLIENTI C ON (C.CODICE=A.CODSOGG)
LEFT OUTER JOIN PRVORDCL DOC ON (DOC.TIPODOCUMENTO=A.TIPODOC AND DOC.REGISTRO=A.REGDOC AND DOC.NUMORDPREV=A.NUMDOC AND DOC.DATADOCUMENTO=A.DATADOC)
LEFT OUTER JOIN ARTICOLI ART ON (ART.CODICEARTICOLO=A.CODICEARTICOLO)
;