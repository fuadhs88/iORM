/* View: ALLEGATI_MANUT_EXPORT_LIST_VIEW, Owner: 1DR0GAT3 */

CREATE VIEW ALLEGATI_MANUT_EXPORT_LIST_VIEW (

   ID
  ,TIPO
  ,STATOAVANZAMENTO
  ,DATACONTROLLO
  ,FULLINDIRIZZOIMM
  ,FULLRESPIMP
  ,FULLPROP
  ,GENCAL_FULLRIF
  ,FULLPRATICA
  ,ENTE_ID
  ,ENTE_FULL
  ,ENTE_TRACCIATO

) AS

SELECT

   A.ID
  ,A.TIPO
  ,A.STATOAVANZAMENTO
  ,A.DATACONTROLLO
  ,CAST(   A.COMUNEIMM || ' ' || A.ZONAIMM || ' ' || A.INDIRIZZOIMM || ' ' || A.NUMCIVICOIMM || ' (' || A.PROVINCIAIMM || ')'    AS VARCHAR(250)) AS FULLINDIRIZZOIMM
  ,CAST(   A.RAGSOCRESPIMP || '   (' || A.INQUALITADIRESPIMP || ')   ' || A.CODICERESPIMP   AS VARCHAR(150)) AS FULLRESPIMP
  ,CAST(   A.PROPDENOMINAZIONE || '   ' || A.PROPCODICE   AS VARCHAR(80)) AS FULLPROP
  ,CAST(   A.GENCAL_COSTRUTTORE || ' ' || A.GENCAL_MODELLO || ' (' || A.GENCAL_MATRICOLA || ') ' || A.GENCAL_UBICAZIONE   AS VARCHAR(200)) AS GENCAL_FULLRIF
  ,CAST(   P.DESCRIZIONE || '   ' || P.ID   AS VARCHAR(80)) AS FULLPRATICA
  ,P.ENTE_ID
  ,CAST(E.NOME || '   ' || E.ID  AS VARCHAR(60)) AS ENTE_FULL
  ,CAST
   (
     CASE
       WHEN (A.TIPO = 'F - impianti termici') THEN E.IMP_TERM_ALL_F_EXPORT_TRACCIATO
       WHEN (A.TIPO = 'G - impianti termici') THEN E.IMP_TERM_ALL_G_EXPORT_TRACCIATO
       ELSE ''
     END
     AS VARCHAR(50)
   ) AS ENTE_TRACCIATO


FROM ALLEGATI_MANUT A
LEFT JOIN IMPEGNI I ON (I.MASTER_ID=A.IDIMPEGNO)
LEFT JOIN PRATICHE P ON (P.ID=I.IDPRATICA)
LEFT JOIN ENTI_X_ALLEGATI_MANUT E ON (E.ID=P.ENTE_ID)

WHERE A.STATOAVANZAMENTO = 30
;
