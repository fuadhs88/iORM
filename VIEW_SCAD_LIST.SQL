CREATE VIEW SCAD_LIST_VIEW (
  CODICE
 ,DATASCADENZA
 ,DARE_IMPORTO
 ,DARE_RESIDUO
 ,AVERE_IMPORTO
 ,AVERE_RESIDUO
 ,RITACC
 ,RITACCPERC
 ,IMPORTO
 ,IMPORTOPAGATO
 ,TOTALEIMPONIBILE
 ,RICEVUTABANCARIA
 ,PRESENTATA
 ,PRESENTATABANCA
 ,DOCUMENTO
 ,SOGGETTO
 ,TIPO
 ,BANCA
 ,ABI
 ,CAB
 ,RAGIONESOCIALE
 ,INDIRIZZO
 ,CAP
 ,CITTA
 ,PROVINCIA
 ,PartitaIVA
 ,CLIENTE
 ,PRATICA
 ,DATAPRATICA1
 ,TIPODOC
 ,NUMDOC
 ,REGISTRO
 ,DATADOC
 ,NOTE
 ,INSOLUTO
 ,RIFPRATICA
 ,AGENTE
 ,AGENTE2
 ,AGENTE3
 ,AGENTE4
 ,DATAPAGAMENTO
 ,STATODESCRIZIONE
 ,TIPOLOGIA
 ,ID 
) AS

/*======================================================
SEZIONE SCADENZE: SCADENZ
======================================================*/
SELECT 

  S.CODICE
 ,S.DATASCADENZA

/* Dare */ 
 ,CAST((   CASE WHEN(S.TIPO='Scad.attiv') THEN COALESCE(S.IMPORTO,0) ELSE 0 END   ) AS NUMERIC(15,4)) AS DARE_IMPORTO
 ,CAST((   CASE WHEN(S.TIPO='Scad.attiv') THEN COALESCE(S.IMPORTO,0)-COALESCE(S.IMPORTOPAGATO,0)+COALESCE(S.SPESEPROTESTO,0) ELSE 0 END   ) AS NUMERIC(15,4)) AS DARE_RESIDUO

/* Avere */ 
 ,CAST((   CASE WHEN(S.TIPO='Scad.passi') THEN COALESCE(S.IMPORTO,0) ELSE 0 END   ) AS NUMERIC(15,4)) AS AVERE_IMPORTO
 ,CAST((   CASE WHEN(S.TIPO='Scad.passi') THEN COALESCE(S.IMPORTO,0)-COALESCE(S.IMPORTOPAGATO,0)+COALESCE(S.SPESEPROTESTO,0) ELSE 0 END   ) AS NUMERIC(15,4)) AS AVERE_RESIDUO

/* Ritenuta di acconto */ 
 ,CAST((   CASE WHEN(S.TIPO='Scad.attiv') THEN (0-COALESCE(DOC.RITACC,0)) ELSE COALESCE(DOC.RITACC,0) END   ) AS NUMERIC(15,4)) AS RITACC
 ,COALESCE(DOC.RITACCPERC,0) AS RITACCPERC

/* Importo e Importo pagato */ 
 ,S.IMPORTO
 ,CAST((   CASE WHEN(S.TIPO='Scad.attiv') THEN COALESCE(S.IMPORTOPAGATO,0) ELSE (0-COALESCE(S.IMPORTOPAGATO,0)) END   ) AS NUMERIC(15,4)) AS IMPORTOPAGATO

/* Totale imponibile */ 
 ,COALESCE(DOC.TOTALEIMPONIBILE,0) AS TOTALEIMPONIBILE

 ,S.RICEVUTABANCARIA
 ,S.PRESENTATA
 ,S.PRESENTATABANCA
 ,CAST(  SUBSTRING(   COALESCE(S.TIPODOC || ' ','') || COALESCE('N. ' || S.NUMDOC || ' ','') || COALESCE(S.REGISTRO || ' ','') || COALESCE('del ' || S.DATADOC || ' ','') || COALESCE(': ' || S.NOTE,'')   FROM 1 FOR 200) AS VARCHAR(200)) AS DOCUMENTO
 ,CAST(  SUBSTRING(   C.RAGIONESOCIALE || '  (' || S.CLIENTE || ')'   FROM 1 FOR 100) AS VARCHAR(100)) AS SOGGETTO
 ,S.TIPO
 ,B.BANCA
 ,S.ABI
 ,S.CAB
 ,C.RAGIONESOCIALE
 ,C.INDIRIZZO
 ,C.CAP
 ,C.CITTA
 ,C.PROVINCIA
 ,C.PartitaIVA
 ,S.CLIENTE
 ,S.PRATICA
 ,S.DATAPRATICA1
 ,S.TIPODOC
 ,S.NUMDOC
 ,S.REGISTRO
 ,S.DATADOC
 ,S.NOTE
 ,S.INSOLUTO
 ,CAST(  SUBSTRING(   (SELECT P.DESCRIZIONE FROM Pratiche P WHERE P.Codice=S.Pratica AND P.DataApertura=S.DataPratica1)||'  ('||S.PRATICA|| ', '||S.DATAPRATICA1||')'   FROM 1 FOR 200) AS VARCHAR(200)) AS RIFPRATICA
 ,S.AGENTE
 ,S.AGENTE2
 ,S.AGENTE3
 ,S.AGENTE4
 ,S.DATAPAGAMENTO
 ,S.STATODESCRIZIONE
 ,CAST('Scadenze' AS VARCHAR(30)) AS TIPOLOGIA
 ,S.ID

FROM SCADENZ S
LEFT JOIN CLIENTI C ON (C.CODICE = S.CLIENTE)
LEFT JOIN BANCHE B ON (B.ABI = S.ABI AND B.CAB = S.CAB)
LEFT JOIN PRVORDCL DOC ON (DOC.TIPODOCUMENTO=S.TIPODOC AND DOC.NUMORDPREV=S.NUMDOC AND DOC.REGISTRO=S.REGISTRO AND DOC.DATADOCUMENTO=S.DATADOC)

/* ================================================== */



UNION ALL



/*======================================================
SEZIONE INTERVENTI CON RIF. A RIC.FISC. CON CORRISP. NON PAGATO
======================================================*/
SELECT 

  CAST(NULL AS INTEGER) AS CODICE
 ,COALESCE(T.RIFDOC_DATA,T.DATADOCUMENTO) AS DATASCADENZA

/* Dare */ 
 ,CAST(COALESCE(T.TOTALEDAPAGARE,0) AS NUMERIC(15,4)) AS DARE_IMPORTO
 ,CAST(COALESCE(T.TOTALEDAPAGARE,0) AS NUMERIC(15,4)) AS DARE_RESIDUO

/* Avere */ 
 ,CAST(0 AS NUMERIC(15,4)) AS AVERE_IMPORTO
 ,CAST(0 AS NUMERIC(15,4)) AS AVERE_RESIDUO

/* Ritenuta di acconto */ 
 ,CAST(0 AS NUMERIC(15,4)) AS RITACC
 ,CAST(0 AS NUMERIC(15,4)) AS RITACCPERC

/* Importo e Importo pagato */ 
 ,CAST(COALESCE(T.TOTALEDAPAGARE,0) AS NUMERIC(15,4)) AS IMPORTO
 ,CAST(0 AS NUMERIC(15,4)) AS IMPORTOPAGATO

/* Totale imponibile */ 
 ,COALESCE(T.TOTALEIMPONIBILE,0) AS TOTALEIMPONIBILE

 ,'F' AS RICEVUTABANCARIA
 ,'F' AS PRESENTATA
 ,CAST(NULL AS VARCHAR(20)) AS PRESENTATABANCA
 ,CAST(  SUBSTRING(   COALESCE(  T.RIFDOC_TIPO,T.TIPODOCUMENTO) || ' N. ' || COALESCE(T.RIFDOC_NUM,T.NUMORDPREV) || COALESCE(T.RIFDOC_REG,T.REGISTRO) || ' del ' || COALESCE(T.RIFDOC_DATA,T.DATADOCUMENTO) || '; ' || COALESCE(T.NOTE,'')  FROM 1 FOR 200) AS VARCHAR(200)) AS DOCUMENTO
 ,CAST(  SUBSTRING(   C.RAGIONESOCIALE || '  (' || T.CODICECLIENTE || ')'   FROM 1 FOR 100) AS VARCHAR(100)) AS SOGGETTO
 ,CAST('Corr.NoPag' AS VARCHAR(10)) AS TIPO
 ,NULL AS BANCA
 ,NULL AS ABI
 ,NULL AS CAB
 ,C.RAGIONESOCIALE
 ,C.INDIRIZZO
 ,C.CAP
 ,C.CITTA
 ,C.PROVINCIA
 ,C.PartitaIVA
 ,T.CODICECLIENTE
 ,T.PRATICA
 ,T.DATAPRATICA1
 ,COALESCE(T.RIFDOC_TIPO,T.TIPODOCUMENTO) AS TIPODOC
 ,COALESCE(T.RIFDOC_NUM,T.NUMORDPREV) AS NUMDOC
 ,COALESCE(T.RIFDOC_REG,T.REGISTRO) AS REGISTRO
 ,COALESCE(T.RIFDOC_DATA,T.DATADOCUMENTO) AS DATADOC
 ,NULL AS NOTE
 ,'/' AS INSOLUTO
 ,CAST(  SUBSTRING(   (SELECT P.DESCRIZIONE FROM Pratiche P WHERE P.Codice=T.Pratica AND P.DataApertura=T.DataPratica1)||'  ('||T.PRATICA|| ', '||T.DATAPRATICA1||')'   FROM 1 FOR 200) AS VARCHAR(200)) AS RIFPRATICA
 ,T.AGENTE
 ,T.AGENTE2
 ,T.AGENTE3
 ,T.AGENTE4
 ,NULL AS DATAPAGAMENTO
 ,T.STATODESCRIZIONE
 ,CAST('Corrispettivi non pagati' AS VARCHAR(30)) AS TIPOLOGIA
 ,T.NUMORDPREV AS ID /* Finchè non ci sarà un vero campo ID in PrvOrdCL restituisto il NumOrdPrev perchè tanto per gli interventi è univoco */

FROM PRVORDCL T
LEFT JOIN CLIENTI C ON (C.CODICE = T.CODICECLIENTE)

WHERE T.RifDoc_CorrispNoPag = 'T'
/* ================================================== */
;



