SET TERM ^ ;

/* SP che ritorna l'elenco da usare per la selezione dell'ente e del tracciato da esportare per l'invio telematico degli allegati F/G */

CREATE PROCEDURE ALLIMP_EXPORT_SEL_ENTI
RETURNS
(  ENTE_ID_TRACCIATO VARCHAR(250)
  ,ENTE_NOME_TRACCIATO VARCHAR(250))
AS
  DECLARE ENTE_ID INTEGER;
  DECLARE ENTE_NOME VARCHAR(60);
  DECLARE IMP_TERM_ALL_F_EXPORT_TRACCIATO VARCHAR(50);
  DECLARE IMP_TERM_ALL_G_EXPORT_TRACCIATO VARCHAR(50);
  DECLARE PREC_TRACCIATO VARCHAR(50);
BEGIN

  /* Query che preleva i dati dalla tabella degli enti */
  FOR SELECT ID, NOME, COALESCE(IMP_TERM_ALL_F_EXPORT_TRACCIATO,''), COALESCE(IMP_TERM_ALL_G_EXPORT_TRACCIATO,'')
  FROM ENTI_X_ALLEGATI_MANUT
  WHERE COALESCE(IMP_TERM_ALL_F_EXPORT_TRACCIATO,'') <> ''
     OR COALESCE(IMP_TERM_ALL_G_EXPORT_TRACCIATO,'') <> ''
  INTO :ENTE_ID, :ENTE_NOME, :IMP_TERM_ALL_F_EXPORT_TRACCIATO, :IMP_TERM_ALL_G_EXPORT_TRACCIATO
  DO
  BEGIN


    /* Se il tracciato <> '' ritorna il record */
    IF (:IMP_TERM_ALL_F_EXPORT_TRACCIATO <> '') THEN BEGIN
      ENTE_ID_TRACCIATO = :ENTE_ID || ',' || :IMP_TERM_ALL_F_EXPORT_TRACCIATO;
      ENTE_NOME_TRACCIATO = :ENTE_NOME || '   {' || :IMP_TERM_ALL_F_EXPORT_TRACCIATO || '}';
      PREC_TRACCIATO = :IMP_TERM_ALL_F_EXPORT_TRACCIATO;
      SUSPEND;
    END


    /* Se il tracciato <> '' ritorna il record */
    IF (:IMP_TERM_ALL_G_EXPORT_TRACCIATO<>'' AND :IMP_TERM_ALL_G_EXPORT_TRACCIATO<>:PREC_TRACCIATO) THEN BEGIN
      ENTE_ID_TRACCIATO = :ENTE_ID || ',' || :IMP_TERM_ALL_G_EXPORT_TRACCIATO;
      ENTE_NOME_TRACCIATO = :ENTE_NOME || '   {' || :IMP_TERM_ALL_G_EXPORT_TRACCIATO || '}';
      PREC_TRACCIATO = :IMP_TERM_ALL_G_EXPORT_TRACCIATO;
      SUSPEND;
    END

  END

  EXIT;

END^

SET TERM ; ^
