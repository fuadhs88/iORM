/* 
   =================================================
   Vista che aggiunge alla vista dei righi base il calcolo 
   del costo medio se abilitato.
   =================================================
*/

CREATE VIEW GC_BASE_COSTOMEDIO
(
  /* ---------------------------------- */
  /* CAMPI PRESI DALLA VISTA PRECEDENTE */
  /* ---------------------------------- */
   TipoDocumento
  ,NumOrdPrev
  ,Registro
  ,DATADOCUMENTO
  ,PROGRIGO
  ,PROGRIGO2
  ,CAUSALE
  ,CODICECLIENTE

  ,PRATICA
  ,DATAPRATICA1
  ,DATACHIUSURAPRATICA1
  ,STATODESCRIZIONEPRATICA1
  ,RIFPRATICA
  ,CODSOGGPRAT
  ,PRAT_PRZUNITOPERA1_1
  ,PRAT_PRZUNITOPERA1_2
  ,PRAT_PRZUNITOPERA1_3
  ,PRAT_PRZUNITOPERA1_4
  ,PRAT_PRZUNITOPERA1_5
  ,PRAT_TIPORICARICO
  ,PRAT_TIPORICDACOMMESSA
  ,PRAT_TIPOCOSTO
  ,PRAT_RICARICOPERC
  ,PRAT_LISTINO
  ,OPERAINDEX
  ,OPERACODICE
  ,OPERADESCRIZIONE

  ,GUID
  ,GUID_REF
  ,GUID_ANCESTOR
  ,TRACK_PREVENTIVO
  ,TRACK_COMMESSA
  ,TRACK_DDT
  ,TRACK_FATTURA
  ,TRACK_ESTRATTO_CONTO
  ,TRACK_SAL
  ,TRACK_BOLLA_ENTR
  ,TRACK_FATT_ACQUI
  ,TRACK_ORD_FORN

  ,SEGNOOPERAZIONECANTIERE
  ,SEGNOOPERAZIONE
  ,GC_SEZIONE
  ,STATODESCRIZIONE
  ,STATOFOREGROUND

  ,DOCUMENTO
  ,SOGGETTO

  ,CodiceMagazzino
  ,MovMag
  ,CodiceArticolo
  ,Descrizione
  ,PrezzoUnitario
  ,UnitaDiMisura
  ,Qta
  ,ScontoRigo
  ,ScontoRigo2
  ,ScontoRigo3
  ,ImportoRigo
  ,PREZZOACQUISTOARTICOLO
  ,IMPORTOACQUISTOARTICOLO
  ,NOTERIGO
  ,MARGINE
  ,PREZZOUNITARIONETTO
  ,CodiceIVA
  ,DescrizioneIVA
  ,AliquotaIVA

  ,SOTTOCANTIERE1
  ,SOTTOCANTIERE2
  ,SOTTOCANTIERE3
  ,SOTTOCANTIERE4
  ,SOTTOCANTIERE5
  ,SOTTOCANTIERE6

  ,CATEGCANT1
  ,CATEGCANT2
  ,CATEGCANT3
  ,CATEGCANT4
  ,CATEGCANT5
  ,CATEGCANT6

  ,S3RIF
  ,S3UBICAZIONE
  ,S3COMPONENTE
  ,S3MATERIALE
  ,S3QTA
  ,S3DIAMETRO
  ,S3LUNGHEZZA
  ,S3INSTALLAZIONE
  ,S3CERTIFICAZIONE
  ,S3VENTILAZIONE
  ,S3SCARICO
  ,S3TIPO
  ,S3PORTATATERMICA
  ,S3TIPOCOLLEGAMENTO
  ,S3INSTALLATOINSTALLABILE
  ,S3MODELLO

  ,TIPOLOGIA

  ,GC_COSTONETTOUNITARIO_MOD
  ,GC_COSTONETTOUNITARIO

  ,GC_RICARICO_MOD
  ,GC_RICARICO

  ,GC_QTA_MOD
  ,GC_QTA

  ,GC_DESCRIZIONE_MOD
  ,GC_DESCRIZIONE
)

AS


/* =================================================
   |   VISTA BASE RIGHI                            |
   =================================================
*/
SELECT

  /* ---------------------------------- */
  /* CAMPI PRESI DALLA VISTA PRECEDENTE */
  /* ---------------------------------- */
   TipoDocumento
  ,NumOrdPrev
  ,Registro
  ,DATADOCUMENTO
  ,PROGRIGO
  ,PROGRIGO2
  ,CAUSALE
  ,CODICECLIENTE

  ,PRATICA
  ,DATAPRATICA1
  ,DATACHIUSURAPRATICA1
  ,STATODESCRIZIONEPRATICA1
  ,RIFPRATICA
  ,CODSOGGPRAT
  ,PRAT_PRZUNITOPERA1_1
  ,PRAT_PRZUNITOPERA1_2
  ,PRAT_PRZUNITOPERA1_3
  ,PRAT_PRZUNITOPERA1_4
  ,PRAT_PRZUNITOPERA1_5
  ,PRAT_TIPORICARICO
  ,PRAT_TIPORICDACOMMESSA
  ,PRAT_TIPOCOSTO
  ,PRAT_RICARICOPERC
  ,PRAT_LISTINO
  ,OPERAINDEX
  ,OPERACODICE
  ,OPERADESCRIZIONE

  ,GUID
  ,GUID_REF
  ,GUID_ANCESTOR
  ,TRACK_PREVENTIVO
  ,TRACK_COMMESSA
  ,TRACK_DDT
  ,TRACK_FATTURA
  ,TRACK_ESTRATTO_CONTO
  ,TRACK_SAL
  ,TRACK_BOLLA_ENTR
  ,TRACK_FATT_ACQUI
  ,TRACK_ORD_FORN

  ,SEGNOOPERAZIONECANTIERE
  ,SEGNOOPERAZIONE
  ,GC_SEZIONE
  ,STATODESCRIZIONE
  ,STATOFOREGROUND

  ,DOCUMENTO
  ,SOGGETTO

  ,CodiceMagazzino
  ,MovMag
  ,CodiceArticolo
  ,Descrizione
  ,PrezzoUnitario
  ,UnitaDiMisura
  ,Qta
  ,ScontoRigo
  ,ScontoRigo2
  ,ScontoRigo3
  ,ImportoRigo
  ,PREZZOACQUISTOARTICOLO
  ,IMPORTOACQUISTOARTICOLO
  ,NOTERIGO
  ,MARGINE
  ,PREZZOUNITARIONETTO
  ,CodiceIVA
  ,DescrizioneIVA
  ,AliquotaIVA

  ,SOTTOCANTIERE1
  ,SOTTOCANTIERE2
  ,SOTTOCANTIERE3
  ,SOTTOCANTIERE4
  ,SOTTOCANTIERE5
  ,SOTTOCANTIERE6

  ,CATEGCANT1
  ,CATEGCANT2
  ,CATEGCANT3
  ,CATEGCANT4
  ,CATEGCANT5
  ,CATEGCANT6

  ,S3RIF
  ,S3UBICAZIONE
  ,S3COMPONENTE
  ,S3MATERIALE
  ,S3QTA
  ,S3DIAMETRO
  ,S3LUNGHEZZA
  ,S3INSTALLAZIONE
  ,S3CERTIFICAZIONE
  ,S3VENTILAZIONE
  ,S3SCARICO
  ,S3TIPO
  ,S3PORTATATERMICA
  ,S3TIPOCOLLEGAMENTO
  ,S3INSTALLATOINSTALLABILE
  ,S3MODELLO

  ,TIPOLOGIA

  /* ------------------------------------------------------------------------------------------------------------------ */
  /* Se siamo al costo medio prende il costo medio altrimenti prende il dato grezzo dal rigo				*/
  /* ------------------------------------------------------------------------------------------------------------------ */
  ,GC_COSTONETTOUNITARIO_MOD
  ,CASE 
     WHEN (PRAT_TIPOCOSTO=1) AND (TIPOLOGIA='Materiali / Apparecchi') AND (GC_COSTONETTOUNITARIO_MOD<>'T')  AND (SEGNOOPERAZIONECANTIERE <> 'F') AND (SEGNOOPERAZIONECANTIERE <> 'C') AND (CODICEARTICOLO IS NOT NULL) AND (CODICEARTICOLO <> '') THEN (SELECT * FROM GC_GET_COSTO_MEDIO_ARTICOLO(CODICEARTICOLO, PRATICA, DATAPRATICA1))
     ELSE GC_COSTONETTOUNITARIO 
   END

  ,GC_RICARICO_MOD
  ,GC_RICARICO

  ,GC_QTA_MOD
  ,CASE
     WHEN (SEGNOOPERAZIONECANTIERE = '-') THEN 0 - GC_QTA
     ELSE GC_QTA
   END

  ,GC_DESCRIZIONE_MOD
  ,GC_DESCRIZIONE

FROM GC_BASE_RIGHI
