SET TERM ^ ;

CREATE PROCEDURE COM_GET_RIF_INFO (IN_MSG_sOGGETTO_ID INTEGER, IN_MSG_PRATICA_ID INTEGER, IN_MSG_RIF_ID INTEGER, IN_MSG_RIF_TIPO VARCHAR(25))
RETURNS
( GEN_DATA_ATTUALE VARCHAR(10)
 ,GEN_ORA_ATTUALE VARCHAR(5)

 ,MSG_SOGGETTO_ID VARCHAR(10)
 ,MSG_SOGGETTO_NOME VARCHAR(60)
 ,MSG_SOGGETTO_COGNOME VARCHAR(60)
 ,MSG_SOGGETTO_RAGIONESOCIALE VARCHAR(60)
 ,MSG_SOGGETTO_INDIRIZZO VARCHAR(80)
 ,MSG_SOGGETTO_NUMCIVICO VARCHAR(10)
 ,MSG_SOGGETTO_CAP VARCHAR(5)
 ,MSG_SOGGETTO_COMUNE VARCHAR(60)
 ,MSG_SOGGETTO_PROVINCIA VARCHAR(3)
 ,MSG_SOGGETTO_PARTITAIVA VARCHAR(16)
 ,MSG_SOGGETTO_CODICEFISCALE VARCHAR(16)

 ,MSG_PRATICA_ID VARCHAR(10)
 ,MSG_PRATICA_CODICE VARCHAR(10)
 ,MSG_PRATICA_DATAAPERTURA VARCHAR(10)
 ,MSG_PRATICA_DESCRIZIONE VARCHAR(60)
 ,MSG_PRATICA_TIPOIMPIANTO VARCHAR(20)
 ,MSG_PRATICA_PROXVISITAENTRO VARCHAR(10)
 ,MSG_PRATICA_CONTRATTO_DATA_FINE VARCHAR(10)
 ,MSG_PRATICA_CONTRATTO_IMPORTO DECIMAL(12,4)
 ,MSG_PRATICA_CONTRATTO_IMPORTOIC DECIMAL(12,4) 

 ,DATIAZIE_RAGIONESOCIALE VARCHAR(50)
 ,DATIAZIE_INDIRIZZO VARCHAR(50)
 ,DATIAZIE_NUMCIVICO VARCHAR(10)
 ,DATIAZIE_CITTA VARCHAR(50)
 ,DATIAZIE_PROVINCIA VARCHAR(50)
 ,DATIAZIE_CAP VARCHAR(5)
 ,DATIAZIE_TELEFONO VARCHAR(50)
 ,DATIAZIE_CELLULARE VARCHAR(50)
 ,DATIAZIE_FAX VARCHAR(50)
 ,DATIAZIE_EMAIL VARCHAR(50)

 ,RIF_TIPO VARCHAR(25)
 ,RIF_NUMERO VARCHAR(10)
 ,RIF_REGISTRO VARCHAR(5)
 ,RIF_DATA VARCHAR(10)
 ,RIF_ORA VARCHAR(5) 
 ,RIF_DESCRIZIONE VARCHAR(100)
 ,RIF_SCADENZA_DATA VARCHAR(10)
 ,RIF_RIFERIMENTO VARCHAR(100)
 ,RIF_IMPORTO DECIMAL(12,4)
 ,RIF_MOTIVO_DELLA_CHIAMATA VARCHAR(255)
 ,RIF_RICHIEDENTE VARCHAR(30)
 ,RIF_RDA VARCHAR(20)
 ,RIF_DA_EFFETTUARE_ID VARCHAR(1000)
 ,RIF_SOGGETTO_ID VARCHAR(10)
 ,RIF_SOGGETTO_NOME VARCHAR(60)
 ,RIF_PRATICA_ID VARCHAR(10)
 ,RIF_PRATICA_CODICE VARCHAR(10)
 ,RIF_PRATICA_DATAAPERTURA VARCHAR(10)
 ,RIF_PRATICA_DESCRIZIONE VARCHAR(60)
 ,RIF_PRATICA_TIPOIMPIANTO VARCHAR(20)
 ,RIF_PRATICA_PROXVISITAENTRO VARCHAR(10)
 ,RIF_PRATICA_CONTRATTO_DATA_FINE VARCHAR(10)
 ,RIF_PRATICA_CONTRATTO_IMPORTO DECIMAL(12,4)
 ,RIF_PRATICA_CONTRATTO_IMPORTOIC DECIMAL(12,4) 
 ,RIF_PRATICA_APP_TIPOIMPIANTO VARCHAR(20)
 ,RIF_PRATICA_APP_TIPOAPPARECCHIO VARCHAR(30)
 ,RIF_PRATICA_APP_COSTRUTTORE VARCHAR(45)
 ,RIF_PRATICA_APP_MODELLO VARCHAR(30)
 ,RIF_PRATICA_APP_MATRICOLA VARCHAR(30)
)

AS
  DECLARE VARIABLE loc_TmpStr VARCHAR(250);
BEGIN

  /* Inizializzazione e defaultizzazione */
  IN_MSG_sOGGETTO_ID = COALESCE(IN_MSG_sOGGETTO_ID, 0);
  IN_MSG_PRATICA_ID = COALESCE(IN_MSG_PRATICA_ID, 0);
  IN_MSG_RIF_ID = COALESCE(IN_MSG_RIF_ID, 0);


  /* Dati generali */
  GEN_DATA_ATTUALE = substring(100+extract(day from CURRENT_TIMESTAMP) from 2 for 2) || '/' || substring(100+extract(month from CURRENT_TIMESTAMP) from 2 for 2) || '/' || extract(year from CURRENT_TIMESTAMP);
  GEN_ORA_ATTUALE = extract(hour from CURRENT_TIMESTAMP) || '.' || substring(100+extract(minute from CURRENT_TIMESTAMP) from 2 for 2);


  /* Dati del soggetto del messaggio */
  IF (IN_MSG_sOGGETTO_ID <> 0) THEN BEGIN
    SELECT CLI.CODICE, CLI.NOME, CLI.COGNOME, CLI.RAGIONESOCIALE, CLI.INDIRIZZO, CLI.NUMCIVICO, CLI.CAP, CLI.CITTA, CLI.PROVINCIA, CLI.PARTITAIVA, CLI.CODICEFISCALE
    FROM CLIENTI CLI WHERE CLI.CODICE = :IN_MSG_sOGGETTO_ID
    INTO :MSG_SOGGETTO_ID, :MSG_SOGGETTO_NOME, :MSG_SOGGETTO_COGNOME, :MSG_SOGGETTO_RAGIONESOCIALE, :MSG_SOGGETTO_INDIRIZZO, :MSG_SOGGETTO_NUMCIVICO, :MSG_SOGGETTO_CAP,
      :MSG_SOGGETTO_COMUNE, :MSG_SOGGETTO_PROVINCIA, :MSG_SOGGETTO_PARTITAIVA, :MSG_SOGGETTO_CODICEFISCALE;
  END


  /* Dati della pratica del messaggio */
  IF (IN_MSG_PRATICA_ID <> 0) THEN BEGIN
    SELECT 
       P.ID
      ,P.CODICE
      ,substring(100+extract(day from P.DATAAPERTURA) from 2 for 2) || '/' || substring(100+extract(month from P.DATAAPERTURA) from 2 for 2) || '/' || extract(year from P.DATAAPERTURA) AS MSG_PRATICA_DATAAPERTURA
      ,P.DESCRIZIONE
      ,P.TIPOIMPIANTO
      ,substring(100+extract(day from P.PROXVISITAENTRO) from 2 for 2) || '/' || substring(100+extract(month from P.PROXVISITAENTRO) from 2 for 2) || '/' || extract(year from P.PROXVISITAENTRO) AS MSG_PRATICA_PROXVISITAENTRO
      ,substring(100+extract(day from P.CONTRATTO_VALIDITA_FINE) from 2 for 2) || '/' || substring(100+extract(month from P.CONTRATTO_VALIDITA_FINE) from 2 for 2) || '/' || extract(year from P.CONTRATTO_VALIDITA_FINE) AS MSG_PRATICA_CONTRATTO_DATA_FINE
      ,P.CONTRATTO_IMPORTONETTO
      ,P.CONTRATTO_IMPORTONETTOIVACOMP
    FROM PRATICHE P
    WHERE P.ID = :IN_MSG_PRATICA_ID
    INTO 
       :MSG_PRATICA_ID
      ,:MSG_PRATICA_CODICE
      ,:MSG_PRATICA_DATAAPERTURA
      ,:MSG_PRATICA_DESCRIZIONE
      ,:MSG_PRATICA_TIPOIMPIANTO
      ,:MSG_PRATICA_PROXVISITAENTRO
      ,:MSG_PRATICA_CONTRATTO_DATA_FINE
      ,:MSG_PRATICA_CONTRATTO_IMPORTO
      ,:MSG_PRATICA_CONTRATTO_IMPORTOIC;
  END 


  /* Dati dell'azienda */
  SELECT FIRST 1
     DA.RAGIONESOCIALE
    ,DA.INDIRIZZO
    ,DA.NUMCIVICO
    ,DA.CITTA
    ,DA.PROVINCIA
    ,DA.CAP
    ,DA.TELEFONO
    ,DA.CELLULARE
    ,DA.FAX
    ,DA.EMAIL
  FROM DATIAZIE DA
  INTO 
     :DATIAZIE_RAGIONESOCIALE 
    ,:DATIAZIE_INDIRIZZO
    ,:DATIAZIE_NUMCIVICO
    ,:DATIAZIE_CITTA
    ,:DATIAZIE_PROVINCIA
    ,:DATIAZIE_CAP
    ,:DATIAZIE_TELEFONO
    ,:DATIAZIE_CELLULARE
    ,:DATIAZIE_FAX
    ,:DATIAZIE_EMAIL;


  /* ============================================================================= */
  /* Costuirce l'elenco delle OP da fare nel caso di chiamata/appuntamento/intervento
  /* ============================================================================= */
  RIF_DA_EFFETTUARE_ID = '';
  IF (UPPER(IN_MSG_RIF_TIPO) = 'APPUNTAMENTO' OR UPPER(IN_MSG_RIF_TIPO) = 'APPUNTAMENTI' OR UPPER(IN_MSG_RIF_TIPO) = 'INTERVENTO' OR UPPER(IN_MSG_RIF_TIPO) = 'INTERVENTI') THEN BEGIN
    FOR SELECT DISTINCT(OPI.IDOP)
      FROM IMPEGNI I
      JOIN OPIMPEGNO OPI ON (OPI.IDIMPEGNO = I.ID)
      WHERE I.MASTER_ID = :IN_MSG_RIF_ID AND COALESCE(OPI.DAEFFETTUARE,'F') = 'T'
    INTO :loc_TmpStr 
    DO BEGIN
      IF (CHAR_LENGTH(RIF_DA_EFFETTUARE_ID) > 0) THEN
        RIF_DA_EFFETTUARE_ID = RIF_DA_EFFETTUARE_ID || ', ';
      RIF_DA_EFFETTUARE_ID = RIF_DA_EFFETTUARE_ID || :loc_TmpStr;
    END
  END
  /* ============================================================================= */


  /* =======================================================================
     INIZIO: PARTE RELATIVA AI DATI DEL DATO DI RIFERIMENTO
     ----------------------------------------------------------------------- */

     /* Impianto */
     IF (UPPER(IN_MSG_RIF_TIPO) = 'IMPIANTO' OR UPPER(IN_MSG_RIF_TIPO) = 'IMPIANTI') THEN BEGIN
       SELECT FIRST 1
         'impianto' AS RIF_TIPO
        ,P.CODICE AS RIF_NUMERO
        ,NULL AS RIF_REGISTRO
	,substring(100+extract(day from P.DATAAPERTURA) from 2 for 2) || '/' || substring(100+extract(month from P.DATAAPERTURA) from 2 for 2) || '/' || extract(year from P.DATAAPERTURA) AS RIF_DATA
	,extract(hour from P.DATAAPERTURA) || '.' || substring(100+extract(minute from P.DATAAPERTURA) from 2 for 2) AS RIF_ORA
        ,P.DESCRIZIONE AS RIF_DESCRIZIONE
	,substring(100+extract(day from P.PROXVISITAENTRO) from 2 for 2) || '/' || substring(100+extract(month from P.PROXVISITAENTRO) from 2 for 2) || '/' || extract(year from P.PROXVISITAENTRO) AS RIF_SCADENZA_DATA
	,P.DESCRIZIONE AS RIF_RIFERIMENTO
        ,NULL AS RIF_IMPORTO
        ,'' AS RIF_MOTIVO_DELLA_CHIAMATA
        ,'' AS RIF_RICHIEDENTE
        ,'' AS RDA
	,P.CLIENTE AS RIF_SOGGETTO_ID
	,C.RAGIONESOCIALE AS RIF_SOGGETTO_NOME
        ,P.ID AS RIF_PRATICA_ID
        ,P.CODICE AS RIF_PRATICA_CODICE
	,substring(100+extract(day from P.DATAAPERTURA) from 2 for 2) || '/' || substring(100+extract(month from P.DATAAPERTURA) from 2 for 2) || '/' || extract(year from P.DATAAPERTURA) AS RIF_PRATICA_DATAAPERTURA
        ,P.DESCRIZIONE AS RIF_PRATICA_DESCRIZIONE
        ,P.TIPOIMPIANTO AS RIF_PRATICA_TIPOIMPIANTO
	,substring(100+extract(day from P.PROXVISITAENTRO) from 2 for 2) || '/' || substring(100+extract(month from P.PROXVISITAENTRO) from 2 for 2) || '/' || extract(year from P.PROXVISITAENTRO) AS RIF_PRATICA_PROXVISITAENTRO
	,substring(100+extract(day from P.CONTRATTO_VALIDITA_FINE) from 2 for 2) || '/' || substring(100+extract(month from P.CONTRATTO_VALIDITA_FINE) from 2 for 2) || '/' || extract(year from P.CONTRATTO_VALIDITA_FINE) AS RIF_PRATICA_CONTRATTO_DATA_FINE
        ,P.CONTRATTO_IMPORTONETTO AS RIF_PRATICA_IMPORTO
        ,P.CONTRATTO_IMPORTONETTOIVACOMP AS RIF_PRATICA_IMPORTOIC
        ,APP.TIPOIMPIANTO
        ,APP.TIPOAPPARECCHIO
        ,APP.COSTRUTTORE
        ,APP.MODELLO
        ,APP.MATRICOLA
       FROM PRATICHE P
       LEFT OUTER JOIN CLIENTI C ON (C.CODICE = P.CLIENTE)
       LEFT OUTER JOIN PRATAPPARECCHI APP ON (APP.IDPRATICA = P.ID)
       WHERE P.ID = :IN_MSG_RIF_ID
         AND COALESCE(APP.DISMESSO,'F') <> 'T'
       INTO
	 :RIF_TIPO
 	,:RIF_NUMERO
 	,:RIF_REGISTRO
 	,:RIF_DATA
 	,:RIF_ORA
 	,:RIF_DESCRIZIONE
 	,:RIF_SCADENZA_DATA
 	,:RIF_RIFERIMENTO
        ,:RIF_IMPORTO
        ,:RIF_MOTIVO_DELLA_CHIAMATA
        ,:RIF_RICHIEDENTE
        ,:RIF_RDA
 	,:RIF_SOGGETTO_ID
 	,:RIF_SOGGETTO_NOME
 	,:RIF_PRATICA_ID
 	,:RIF_PRATICA_CODICE
 	,:RIF_PRATICA_DATAAPERTURA
 	,:RIF_PRATICA_DESCRIZIONE
 	,:RIF_PRATICA_TIPOIMPIANTO
 	,:RIF_PRATICA_PROXVISITAENTRO
 	,:RIF_PRATICA_CONTRATTO_DATA_FINE
        ,:RIF_PRATICA_CONTRATTO_IMPORTO
        ,:RIF_PRATICA_CONTRATTO_IMPORTOIC
        ,:RIF_PRATICA_APP_TIPOIMPIANTO
        ,:RIF_PRATICA_APP_TIPOAPPARECCHIO
        ,:RIF_PRATICA_APP_COSTRUTTORE
        ,:RIF_PRATICA_APP_MODELLO
        ,:RIF_PRATICA_APP_MATRICOLA;
     END

     /* ------------------------------ */

     /* Appuntamento */
     IF (UPPER(IN_MSG_RIF_TIPO) = 'APPUNTAMENTO' OR UPPER(IN_MSG_RIF_TIPO) = 'APPUNTAMENTI') THEN BEGIN
       SELECT FIRST 1 
         'appuntamento' AS RIF_TIPO
        ,I.ID AS RIF_NUMERO
        ,I.REGISTRO AS RIF_REGISTRO
	,substring(100+extract(day from I.START_EVENT) from 2 for 2) || '/' || substring(100+extract(month from I.START_EVENT) from 2 for 2) || '/' || extract(year from I.START_EVENT) AS RIF_DATA
	,extract(hour from I.START_EVENT) || '.' || substring(100+extract(minute from I.START_EVENT) from 2 for 2) AS RIF_ORA
        ,'appuntamento del ' || substring(100+extract(day from I.START_EVENT) from 2 for 2) || '/' || substring(100+extract(month from I.START_EVENT) from 2 for 2) || '/' || extract(year from I.START_EVENT) || ' ore ' || extract(hour from I.START_EVENT) || '.' || substring(100+extract(minute from I.START_EVENT) from 2 for 2) AS RIF_DESCRIZIONE
	,substring(100+extract(day from I.START_EVENT) from 2 for 2) || '/' || substring(100+extract(month from I.START_EVENT) from 2 for 2) || '/' || extract(year from I.START_EVENT) AS RIF_SCADENZA_DATA
        ,'appuntamento del ' || substring(100+extract(day from I.START_EVENT) from 2 for 2) || '/' || substring(100+extract(month from I.START_EVENT) from 2 for 2) || '/' || extract(year from I.START_EVENT) || ' ore ' || extract(hour from I.START_EVENT) || '.' || substring(100+extract(minute from I.START_EVENT) from 2 for 2) AS RIF_RIFERIMENTO
        ,NULL AS RIF_IMPORTO
        ,I.EVENTMESSAGE AS RIF_MOTIVO_DELLA_CHIAMATA
        ,I.RICHIEDENTE AS RIF_RICHIEDENTE
        ,I.RDA AS RIF_RDA
	,I.CLIENTE AS RIF_SOGETTO_ID
	,C.RAGIONESOCIALE AS RIF_SOGETTO_NOME
        ,P.ID AS RIF_PRATICA_ID
        ,P.CODICE AS RIF_PRATICA_CODICE
	,substring(100+extract(day from P.DATAAPERTURA) from 2 for 2) || '/' || substring(100+extract(month from P.DATAAPERTURA) from 2 for 2) || '/' || extract(year from P.DATAAPERTURA) AS RIF_PRATICA_DATAAPERTURA
        ,P.DESCRIZIONE AS RIF_PRATICA_DESCRIZIONE
        ,P.TIPOIMPIANTO AS RIF_PRATICA_TIPOIMPIANTO
	,substring(100+extract(day from P.PROXVISITAENTRO) from 2 for 2) || '/' || substring(100+extract(month from P.PROXVISITAENTRO) from 2 for 2) || '/' || extract(year from P.PROXVISITAENTRO) AS RIF_PRATICA_PROXVISITAENTRO
	,substring(100+extract(day from P.CONTRATTO_VALIDITA_FINE) from 2 for 2) || '/' || substring(100+extract(month from P.CONTRATTO_VALIDITA_FINE) from 2 for 2) || '/' || extract(year from P.CONTRATTO_VALIDITA_FINE) AS RIF_PRATICA_CONTRATTO_DATA_FINE
        ,P.CONTRATTO_IMPORTONETTO AS RIF_PRATICA_IMPORTO
        ,P.CONTRATTO_IMPORTONETTOIVACOMP AS RIF_PRATICA_IMPORTOIC
        ,APP.TIPOIMPIANTO
        ,APP.TIPOAPPARECCHIO
        ,APP.COSTRUTTORE
        ,APP.MODELLO
        ,APP.MATRICOLA
       FROM IMPEGNI I
       LEFT OUTER JOIN CLIENTI C ON (C.CODICE = I.CLIENTE)
       LEFT OUTER JOIN PRATICHE P ON (P.ID = I.IDPRATICA)
       LEFT OUTER JOIN PRATAPPARECCHI APP ON (APP.IDPRATICA = P.ID)
       WHERE I.MASTER_ID = :IN_MSG_RIF_ID
         AND COALESCE(APP.DISMESSO,'F') <> 'T'
       INTO
	 :RIF_TIPO
 	,:RIF_NUMERO
 	,:RIF_REGISTRO
 	,:RIF_DATA
 	,:RIF_ORA
 	,:RIF_DESCRIZIONE
 	,:RIF_SCADENZA_DATA
 	,:RIF_RIFERIMENTO
        ,:RIF_IMPORTO
        ,:RIF_MOTIVO_DELLA_CHIAMATA
        ,:RIF_RICHIEDENTE
        ,:RIF_RDA
 	,:RIF_SOGGETTO_ID
 	,:RIF_SOGGETTO_NOME
 	,:RIF_PRATICA_ID
 	,:RIF_PRATICA_CODICE
 	,:RIF_PRATICA_DATAAPERTURA
 	,:RIF_PRATICA_DESCRIZIONE
 	,:RIF_PRATICA_TIPOIMPIANTO
 	,:RIF_PRATICA_PROXVISITAENTRO
 	,:RIF_PRATICA_CONTRATTO_DATA_FINE
        ,:RIF_PRATICA_CONTRATTO_IMPORTO
        ,:RIF_PRATICA_CONTRATTO_IMPORTOIC
        ,:RIF_PRATICA_APP_TIPOIMPIANTO
        ,:RIF_PRATICA_APP_TIPOAPPARECCHIO
        ,:RIF_PRATICA_APP_COSTRUTTORE
        ,:RIF_PRATICA_APP_MODELLO
        ,:RIF_PRATICA_APP_MATRICOLA;
     END

     /* ------------------------------ */

     /* Intervento */
     IF (UPPER(IN_MSG_RIF_TIPO) = 'INTERVENTO' OR UPPER(IN_MSG_RIF_TIPO) = 'INTERVENTI') THEN BEGIN
       SELECT FIRST 1 
         'intervento' AS RIF_TIPO
        ,I.ID AS RIF_NUMERO
        ,I.REGISTRO AS RIF_REGISTRO
	,substring(100+extract(day from I.DATAORAINTERVENTO) from 2 for 2) || '/' || substring(100+extract(month from I.DATAORAINTERVENTO) from 2 for 2) || '/' || extract(year from I.DATAORAINTERVENTO) AS RIF_DATA
	,extract(hour from I.DATAORAINTERVENTO) || '.' || substring(100+extract(minute from DATAORAINTERVENTO) from 2 for 2) AS RIF_ORA
        ,'intervento del ' || substring(100+extract(day from I.DATAORAINTERVENTO) from 2 for 2) || '/' || substring(100+extract(month from I.DATAORAINTERVENTO) from 2 for 2) || '/' || extract(year from I.DATAORAINTERVENTO) || ' ore ' || extract(hour from I.DATAORAINTERVENTO) || '.' || substring(100+extract(minute from DATAORAINTERVENTO) from 2 for 2) AS RIF_DESCRIZIONE
	,substring(100+extract(day from I.DATAORAINTERVENTO) from 2 for 2) || '/' || substring(100+extract(month from I.DATAORAINTERVENTO) from 2 for 2) || '/' || extract(year from I.DATAORAINTERVENTO) AS RIF_SCADENZA_DATA
        ,'intervento del ' || substring(100+extract(day from I.DATAORAINTERVENTO) from 2 for 2) || '/' || substring(100+extract(month from I.DATAORAINTERVENTO) from 2 for 2) || '/' || extract(year from I.DATAORAINTERVENTO) || ' ore ' || extract(hour from I.DATAORAINTERVENTO) || '.' || substring(100+extract(minute from DATAORAINTERVENTO) from 2 for 2) AS RIF_RIFERIMENTO
        ,NULL AS RIF_IMPORTO
        ,I.EVENTMESSAGE AS RIF_MOTIVO_DELLA_CHIAMATA
        ,I.RICHIEDENTE AS RIF_RICHIEDENTE
        ,I.RDA AS RIF_RDA
	,I.CLIENTE AS RIF_SOGGETTO_ID
	,C.RAGIONESOCIALE AS RIF_SOGGETTO_NOME
        ,P.ID AS RIF_PRATICA_ID
        ,P.CODICE AS RIF_PRATICA_CODICE
	,substring(100+extract(day from P.DATAAPERTURA) from 2 for 2) || '/' || substring(100+extract(month from P.DATAAPERTURA) from 2 for 2) || '/' || extract(year from P.DATAAPERTURA) AS RIF_PRATICA_DATAAPERTURA
        ,P.DESCRIZIONE AS RIF_PRATICA_DESCRIZIONE
        ,P.TIPOIMPIANTO AS RIF_PRATICA_TIPOIMPIANTO
	,substring(100+extract(day from P.PROXVISITAENTRO) from 2 for 2) || '/' || substring(100+extract(month from P.PROXVISITAENTRO) from 2 for 2) || '/' || extract(year from P.PROXVISITAENTRO) AS RIF_PRATICA_PROXVISITAENTRO
	,substring(100+extract(day from P.CONTRATTO_VALIDITA_FINE) from 2 for 2) || '/' || substring(100+extract(month from P.CONTRATTO_VALIDITA_FINE) from 2 for 2) || '/' || extract(year from P.CONTRATTO_VALIDITA_FINE) AS RIF_PRATICA_CONTRATTO_DATA_FINE
        ,P.CONTRATTO_IMPORTONETTO AS RIF_PRATICA_IMPORTO
        ,P.CONTRATTO_IMPORTONETTOIVACOMP AS RIF_PRATICA_IMPORTOIC
        ,APP.TIPOIMPIANTO
        ,APP.TIPOAPPARECCHIO
        ,APP.COSTRUTTORE
        ,APP.MODELLO
        ,APP.MATRICOLA
       FROM IMPEGNI I
       LEFT OUTER JOIN CLIENTI C ON (C.CODICE = I.CLIENTE)
       LEFT OUTER JOIN PRATICHE P ON (P.ID = I.IDPRATICA)
       LEFT OUTER JOIN PRATAPPARECCHI APP ON (APP.IDPRATICA = P.ID)
       WHERE I.MASTER_ID = :IN_MSG_RIF_ID
         AND COALESCE(APP.DISMESSO,'F') <> 'T'
       INTO
	 :RIF_TIPO
 	,:RIF_NUMERO
 	,:RIF_REGISTRO
 	,:RIF_DATA
 	,:RIF_ORA
 	,:RIF_DESCRIZIONE
 	,:RIF_SCADENZA_DATA
 	,:RIF_RIFERIMENTO
        ,:RIF_IMPORTO
        ,:RIF_MOTIVO_DELLA_CHIAMATA
        ,:RIF_RICHIEDENTE
        ,:RIF_RDA
 	,:RIF_SOGGETTO_ID
 	,:RIF_SOGGETTO_NOME
 	,:RIF_PRATICA_ID
 	,:RIF_PRATICA_CODICE
 	,:RIF_PRATICA_DATAAPERTURA
 	,:RIF_PRATICA_DESCRIZIONE
 	,:RIF_PRATICA_TIPOIMPIANTO
 	,:RIF_PRATICA_PROXVISITAENTRO
 	,:RIF_PRATICA_CONTRATTO_DATA_FINE
        ,:RIF_PRATICA_CONTRATTO_IMPORTO
        ,:RIF_PRATICA_CONTRATTO_IMPORTOIC
        ,:RIF_PRATICA_APP_TIPOIMPIANTO
        ,:RIF_PRATICA_APP_TIPOAPPARECCHIO
        ,:RIF_PRATICA_APP_COSTRUTTORE
        ,:RIF_PRATICA_APP_MODELLO
        ,:RIF_PRATICA_APP_MATRICOLA;
     END

     /* ------------------------------ */

     /* Scadenze */
     IF (UPPER(IN_MSG_RIF_TIPO) = 'SCADENZA' OR UPPER(IN_MSG_RIF_TIPO) = 'SCADENZE') THEN BEGIN
       SELECT FIRST 1 
         'scadenza' AS RIF_TIPO
        ,S.CODICE AS RIF_NUMERO
        ,NULL AS RIF_REGISTRO
	,substring(100+extract(day from S.DATASCADENZA) from 2 for 2) || '/' || substring(100+extract(month from S.DATASCADENZA) from 2 for 2) || '/' || extract(year from S.DATASCADENZA) AS RIF_DATA
        ,NULL AS RIF_ORA
        ,'scadenza del ' || substring(100+extract(day from S.DATASCADENZA) from 2 for 2) || '/' || substring(100+extract(month from S.DATASCADENZA) from 2 for 2) || '/' || extract(year from S.DATASCADENZA) AS RIF_DESCRIZIONE
	,substring(100+extract(day from S.DATASCADENZA) from 2 for 2) || '/' || substring(100+extract(month from S.DATASCADENZA) from 2 for 2) || '/' || extract(year from S.DATASCADENZA) AS RIF_SCADENZA_DATA
        ,S.TIPODOC || ' n. ' || S.NUMDOC || S.REGISTRO || ' del ' || substring(100+extract(day from S.DATADOC) from 2 for 2) || '/' || substring(100+extract(month from S.DATADOC) from 2 for 2) || '/' || extract(year from S.DATADOC) AS RIF_RIFERIMENTO
        ,(S.IMPORTO - S.IMPORTOPAGATO) AS RIF_IMPORTO
        ,NULL AS RIF_MOTIVO_DELLA_CHIAMATA
        ,NULL AS RIF_RICHIEDENTE
        ,NULL AS RIF_RDA
	,S.CLIENTE AS RIF_SOGGETTO_ID
	,C.RAGIONESOCIALE AS RIF_SOGGETTO_NOME
        ,P.ID AS RIF_PRATICA_ID
        ,P.CODICE AS RIF_PRATICA_CODICE
	,substring(100+extract(day from P.DATAAPERTURA) from 2 for 2) || '/' || substring(100+extract(month from P.DATAAPERTURA) from 2 for 2) || '/' || extract(year from P.DATAAPERTURA) AS RIF_PRATICA_DATAAPERTURA
        ,P.DESCRIZIONE AS RIF_PRATICA_DESCRIZIONE
        ,P.TIPOIMPIANTO AS RIF_PRATICA_TIPOIMPIANTO
	,substring(100+extract(day from P.PROXVISITAENTRO) from 2 for 2) || '/' || substring(100+extract(month from P.PROXVISITAENTRO) from 2 for 2) || '/' || extract(year from P.PROXVISITAENTRO) AS RIF_PRATICA_PROXVISITAENTRO
	,substring(100+extract(day from P.CONTRATTO_VALIDITA_FINE) from 2 for 2) || '/' || substring(100+extract(month from P.CONTRATTO_VALIDITA_FINE) from 2 for 2) || '/' || extract(year from P.CONTRATTO_VALIDITA_FINE) AS RIF_PRATICA_CONTRATTO_DATA_FINE
        ,P.CONTRATTO_IMPORTONETTO AS RIF_PRATICA_IMPORTO
        ,P.CONTRATTO_IMPORTONETTOIVACOMP AS RIF_PRATICA_IMPORTOIC
        ,APP.TIPOIMPIANTO
        ,APP.TIPOAPPARECCHIO
        ,APP.COSTRUTTORE
        ,APP.MODELLO
        ,APP.MATRICOLA
       FROM SCADENZ S
       LEFT OUTER JOIN CLIENTI C ON (C.CODICE = S.CLIENTE)
       LEFT OUTER JOIN PRATICHE P ON (P.CODICE=S.PRATICA AND P.DATAAPERTURA=S.DATAPRATICA1)
       LEFT OUTER JOIN PRATAPPARECCHI APP ON (APP.IDPRATICA = P.ID)
       WHERE S.ID = :IN_MSG_RIF_ID
         AND COALESCE(APP.DISMESSO,'F') <> 'T'
       INTO
	 :RIF_TIPO
 	,:RIF_NUMERO
 	,:RIF_REGISTRO
 	,:RIF_DATA
 	,:RIF_ORA
 	,:RIF_DESCRIZIONE
 	,:RIF_SCADENZA_DATA
 	,:RIF_RIFERIMENTO
        ,:RIF_IMPORTO
        ,:RIF_MOTIVO_DELLA_CHIAMATA
        ,:RIF_RICHIEDENTE
        ,:RIF_RDA
 	,:RIF_SOGGETTO_ID
 	,:RIF_SOGGETTO_NOME
 	,:RIF_PRATICA_ID
 	,:RIF_PRATICA_CODICE
 	,:RIF_PRATICA_DATAAPERTURA
 	,:RIF_PRATICA_DESCRIZIONE
 	,:RIF_PRATICA_TIPOIMPIANTO
 	,:RIF_PRATICA_PROXVISITAENTRO
 	,:RIF_PRATICA_CONTRATTO_DATA_FINE
        ,:RIF_PRATICA_CONTRATTO_IMPORTO
        ,:RIF_PRATICA_CONTRATTO_IMPORTOIC
        ,:RIF_PRATICA_APP_TIPOIMPIANTO
        ,:RIF_PRATICA_APP_TIPOAPPARECCHIO
        ,:RIF_PRATICA_APP_COSTRUTTORE
        ,:RIF_PRATICA_APP_MODELLO
        ,:RIF_PRATICA_APP_MATRICOLA;
     END

     /* ------------------------------ */

     /* Corrisettivi non pagati */
     IF (UPPER(IN_MSG_RIF_TIPO) = 'CORRISP. NON PAGATO' OR UPPER(IN_MSG_RIF_TIPO) = 'CORRISP. NON PAGATI') THEN BEGIN
       SELECT FIRST 1 
         VSL.TIPODOC AS RIF_TIPO
        ,VSL.NUMDOC AS RIF_NUMERO
        ,VSL.REGISTRO AS RIF_REGISTRO
	,substring(100+extract(day from VSL.DATADOC) from 2 for 2) || '/' || substring(100+extract(month from VSL.DATADOC) from 2 for 2) || '/' || extract(year from VSL.DATADOC) AS RIF_DATA
        ,NULL AS RIF_ORA
        ,'corrisp. non pagato del ' || substring(100+extract(day from VSL.DATADOC) from 2 for 2) || '/' || substring(100+extract(month from VSL.DATADOC) from 2 for 2) || '/' || extract(year from VSL.DATADOC) AS RIF_DESCRIZIONE
	,substring(100+extract(day from VSL.DATADOC) from 2 for 2) || '/' || substring(100+extract(month from VSL.DATADOC) from 2 for 2) || '/' || extract(year from VSL.DATADOC) AS RIF_SCADENZA_DATA
        ,VSL.TIPODOC || ' n. ' || VSL.NUMDOC || VSL.REGISTRO || ' del ' || substring(100+extract(day from VSL.DATADOC) from 2 for 2) || '/' || substring(100+extract(month from VSL.DATADOC) from 2 for 2) || '/' || extract(year from VSL.DATADOC) AS RIF_RIFERIMENTO
        ,VSL.IMPORTO AS RIF_IMPORTO
        ,NULL AS RIF_MOTIVO_DELLA_CHIAMATA
        ,NULL AS RIF_RICHIEDENTE
        ,NULL AS RIF_RDA
	,VSL.CLIENTE AS RIF_SOGGETTO_ID
	,C.RAGIONESOCIALE AS RIF_SOGGETTO_NOME
        ,P.ID AS RIF_PRATICA_ID
        ,P.CODICE AS RIF_PRATICA_CODICE
	,substring(100+extract(day from P.DATAAPERTURA) from 2 for 2) || '/' || substring(100+extract(month from P.DATAAPERTURA) from 2 for 2) || '/' || extract(year from P.DATAAPERTURA) AS RIF_PRATICA_DATAAPERTURA
        ,P.DESCRIZIONE AS RIF_PRATICA_DESCRIZIONE
        ,P.TIPOIMPIANTO AS RIF_PRATICA_TIPOIMPIANTO
	,substring(100+extract(day from P.PROXVISITAENTRO) from 2 for 2) || '/' || substring(100+extract(month from P.PROXVISITAENTRO) from 2 for 2) || '/' || extract(year from P.PROXVISITAENTRO) AS RIF_PRATICA_PROXVISITAENTRO
	,substring(100+extract(day from P.CONTRATTO_VALIDITA_FINE) from 2 for 2) || '/' || substring(100+extract(month from P.CONTRATTO_VALIDITA_FINE) from 2 for 2) || '/' || extract(year from P.CONTRATTO_VALIDITA_FINE) AS RIF_PRATICA_CONTRATTO_DATA_FINE
        ,P.CONTRATTO_IMPORTONETTO AS RIF_PRATICA_IMPORTO
        ,P.CONTRATTO_IMPORTONETTOIVACOMP AS RIF_PRATICA_IMPORTOIC
        ,APP.TIPOIMPIANTO
        ,APP.TIPOAPPARECCHIO
        ,APP.COSTRUTTORE
        ,APP.MODELLO
        ,APP.MATRICOLA
       FROM SCAD_LIST_VIEW VSL
       LEFT OUTER JOIN CLIENTI C ON (C.CODICE = VSL.CLIENTE)
       LEFT OUTER JOIN PRATICHE P ON (P.CODICE=VSL.PRATICA AND P.DATAAPERTURA=VSL.DATAPRATICA1)
       LEFT OUTER JOIN PRATAPPARECCHI APP ON (APP.IDPRATICA = P.ID)
       WHERE VSL.ID = :IN_MSG_RIF_ID
         AND COALESCE(APP.DISMESSO,'F') <> 'T'
       INTO
	 :RIF_TIPO
 	,:RIF_NUMERO
 	,:RIF_REGISTRO
 	,:RIF_DATA
 	,:RIF_ORA
 	,:RIF_DESCRIZIONE
 	,:RIF_SCADENZA_DATA
 	,:RIF_RIFERIMENTO
        ,:RIF_IMPORTO
        ,:RIF_MOTIVO_DELLA_CHIAMATA
        ,:RIF_RICHIEDENTE
        ,:RIF_RDA
 	,:RIF_SOGGETTO_ID
 	,:RIF_SOGGETTO_NOME
 	,:RIF_PRATICA_ID
 	,:RIF_PRATICA_CODICE
 	,:RIF_PRATICA_DATAAPERTURA
 	,:RIF_PRATICA_DESCRIZIONE
 	,:RIF_PRATICA_TIPOIMPIANTO
 	,:RIF_PRATICA_PROXVISITAENTRO
 	,:RIF_PRATICA_CONTRATTO_DATA_FINE
        ,:RIF_PRATICA_CONTRATTO_IMPORTO
        ,:RIF_PRATICA_CONTRATTO_IMPORTOIC
        ,:RIF_PRATICA_APP_TIPOIMPIANTO
        ,:RIF_PRATICA_APP_TIPOAPPARECCHIO
        ,:RIF_PRATICA_APP_COSTRUTTORE
        ,:RIF_PRATICA_APP_MODELLO
        ,:RIF_PRATICA_APP_MATRICOLA;
     END

  /* -----------------------------------------------------------------------
     FINE: PARTE RELATIVA AI DATI DEL DATO DI RIFERIMENTO
     ======================================================================= */


  /* Finale */
  SUSPEND;
  EXIT;

END^

SET TERM ^ ;

