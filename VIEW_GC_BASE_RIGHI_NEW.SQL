/* 
   =================================================
   Vista che fornisce il primo step di dati per il GC
   ed esattamente i dati grezzi dei righi con già i ricarichi
   e i campi personalizzabili (deroghe) in base alla scelta
   del ricarico voluto sul cantiere (ricarico fisso, ricarico
   come da listino 1..4 eventualmente anche con i ricarichi
   per fasce di prezzo.
   =================================================
*/

CREATE VIEW GC_BASE_RIGHI_NEW
(
   TipoDocumento
  ,NumOrdPrev
  ,Registro
  ,DATADOCUMENTO
  ,PROGRIGO
  ,PROGRIGO2
  ,CAUSALE
  ,CODICECLIENTE

  ,PRAT_TIPO
  ,PRATICA
  ,DATAPRATICA1
  ,DATACHIUSURAPRATICA1
  ,COSTRUTTOREPRATICA
  ,MODELLOPRATICA
  ,DESCRIZIONEPRATICA
  ,STATODESCRIZIONEPRATICA1
  ,CODSOGGPRAT
  ,RIFSOGGPRAT
  ,PRAT_PRZUNITOPERA1_1
  ,PRAT_PRZUNITOPERA1_2
  ,PRAT_PRZUNITOPERA1_3
  ,PRAT_PRZUNITOPERA1_4
  ,PRAT_PRZUNITOPERA1_5
  ,PRAT_COSTOUNITOPERA1_1
  ,PRAT_COSTOUNITOPERA1_2
  ,PRAT_COSTOUNITOPERA1_3
  ,PRAT_COSTOUNITOPERA1_4
  ,PRAT_COSTOUNITOPERA1_5
  ,PRAT_TIPORICARICO
  ,PRAT_TIPORICDACOMMESSA
  ,PRAT_TIPOCOSTO
  ,PRAT_RICARICOPERC
  ,PRAT_LISTINO
  ,OPERAINDEX
  ,IMMOBLOCALITA
  ,IMMOBINDIRIZZO
  ,IMMOBNUMCIVICO
  ,IMMOBPROVINCIA
  ,IMMOBCAP

  ,GUID
  ,GUID_REF
  ,GUID_ANCESTOR

  ,SEGNOOPERAZIONECANTIERE
  ,SEGNOOPERAZIONE
  ,STATODESCRIZIONE
  ,STATOFOREGROUND

  ,RAGSOCCLI

  ,CodiceMagazzino
  ,CodiceArticolo
  ,CodiceArticoloStm
  ,Descrizione
  ,PrezzoUnitario
  ,UnitaDiMisura
  ,Qta
  ,ScontoRigo
  ,ScontoRigo2
  ,ScontoRigo3
  ,ImportoRigo
  ,PREZZOACQUISTOARTICOLO
  ,NOTERIGO
  ,MARGINE
  ,CodiceIVA
  ,DescrizioneIVA
  ,AliquotaIVA

  ,AGENTE
  ,AGENTE2
  ,AGENTE3
  ,AGENTE4

  ,TIPO1
  ,TIPO2
  ,TIPO3
  ,TIPO4
  ,TIPO5
  ,TIPO6

  ,SOTTOCANTIERE1
  ,SOTTOCANTIERE2
  ,SOTTOCANTIERE3
  ,SOTTOCANTIERE4
  ,SOTTOCANTIERE5
  ,SOTTOCANTIERE6

  ,CATEGCANT1
  ,CATEGCANT2
  ,CATEGCANT3
  ,CATEGCANT4
  ,CATEGCANT5
  ,CATEGCANT6

  ,TIPOLOGIA

  ,GC_COSTONETTOUNITARIO_MOD
  ,GC_COSTONETTOUNITARIO

  ,GC_RICARICO_MOD
  ,GC_RICARICO

  ,GC_QTA_MOD
  ,GC_QTA

  ,GC_DESCRIZIONE_MOD
  ,GC_DESCRIZIONE

  ,RDA
)

AS


/* =================================================
   |   INTERVENTI: RELAZIONE INTERVENTO            |
   =================================================
*/
SELECT
   I.TipoImpegno as Tipodocumento
  ,I.ID as NumOrdPrev
  ,I.Registro
  ,T.DataDocumento
  ,CAST(0 AS Integer) as ProgRigo
  ,CAST(-1 AS Integer) as PROGRIGO2
  ,T.CAUSALE
  ,I.CLIENTE

  ,P.TIPO AS PRAT_TIPO
  ,I.PRATICA
  ,I.DATAPRATICA1
  ,P.DATACHIUSURA
  ,P.COSTRUTTORE
  ,P.MODELLO
  ,P.DESCRIZIONE
  ,P.STATODESCRIZIONE
  ,P.CLIENTE
  ,CAST(  SUBSTRING(  P.RAGSOCCLI || ' (' || P.CLIENTE || ')'  FROM 1 FOR 100) AS VARCHAR(100)) AS RIFSOGGPRAT

  ,COALESCE(P.PRZUNITOPERA1_1, 0) AS PRAT_PRZUNITOPERA1_1
  ,COALESCE(P.PRZUNITOPERA1_2, 0) AS PRAT_PRZUNITOPERA1_2
  ,COALESCE(P.PRZUNITOPERA1_3, 0) AS PRAT_PRZUNITOPERA1_3
  ,COALESCE(P.PRZUNITOPERA1_4, 0) AS PRAT_PRZUNITOPERA1_4
  ,COALESCE(P.PRZUNITOPERA1_5, 0) AS PRAT_PRZUNITOPERA1_5
  ,COALESCE(P.COSTOUNITOPERA1_1, 0) AS PRAT_COSTOUNITOPERA1_1
  ,COALESCE(P.COSTOUNITOPERA1_2, 0) AS PRAT_COSTOUNITOPERA1_2
  ,COALESCE(P.COSTOUNITOPERA1_3, 0) AS PRAT_COSTOUNITOPERA1_3
  ,COALESCE(P.COSTOUNITOPERA1_4, 0) AS PRAT_COSTOUNITOPERA1_4
  ,COALESCE(P.COSTOUNITOPERA1_5, 0) AS PRAT_COSTOUNITOPERA1_5
  ,P.TIPORICARICO
  ,P.TIPORICARICOCOMEDACOMMESSA
  ,P.TIPOCOSTO
  ,COALESCE(P.RICARICOPERC,0)
  ,P.LISTINO
  ,CAST(NULL AS INTEGER) AS OPERAINDEX
  ,P.IMMOBLOCALITA
  ,P.IMMOBINDIRIZZO
  ,P.IMMOBNUMCIVICO
  ,P.IMMOBPROVINCIA
  ,P.IMMOBCAP

  ,CAST('' AS VARCHAR(40)) AS GUID
  ,CAST('' AS VARCHAR(40)) AS GUID_REF
  ,CAST('' AS VARCHAR(40)) AS GUID_ANCESTOR

  ,T.SEGNOOPERAZIONECANTIERE
  ,CAST(NULL AS VARCHAR(1)) AS SEGNOOPERAZIONE
  ,T.STATODESCRIZIONE
  ,T.STATOFOREGROUND

  ,I.RagSocCli

  ,CAST(NULL AS SMALLINT) AS CODICEMAGAZZINO
  ,CAST(NULL AS VARCHAR(25)) AS CODICEARTICOLO
  ,CAST(NULL AS VARCHAR(25)) AS CODICEARTICOLOSTM
  ,CAST(COALESCE(I.RelazioneIntervento,'') AS VARCHAR(5000)) as Descrizione
  ,CAST(0 AS DECIMAL(12,4)) AS PrezzoUnitario
  ,CAST(NULL AS VARCHAR(2)) AS UnitaDiMisura
  ,CAST(NULL AS NUMERIC(11,4)) AS QTA
  ,CAST(0 AS NUMERIC(11,4)) AS SCONTORIGO
  ,CAST(0 AS NUMERIC(11,4)) AS SCONTORIGO2
  ,CAST(0 AS NUMERIC(11,4)) AS SCONTORIGO3
  ,CAST(0 AS DECIMAL(12,4)) AS ImportoRigo
  ,CAST(0 AS DECIMAL(12,4)) AS PREZZOACQUISTOARTICOLO
  ,CAST(NULL AS VARCHAR(1000)) AS NOTERIGO
  ,CAST(0 AS DECIMAL(15,4)) AS MARGINE
  ,CAST(NULL AS INTEGER)	AS CODICEIVA
  ,CAST(NULL AS VARCHAR(40)) AS DESCRIZIONEIVA
  ,CAST(0 AS DECIMAL(15,4)) AS ALIQUOTAIVA

  ,COALESCE(T.AGENTE, '')  AS AGENTE
  ,COALESCE(T.AGENTE2, '') AS AGENTE2
  ,COALESCE(T.AGENTE3, '') AS AGENTE3
  ,COALESCE(T.AGENTE4, '') AS AGENTE4

  ,CAST(NULL AS VARCHAR(20)) AS TIPO1
  ,CAST(NULL AS VARCHAR(20)) AS TIPO2
  ,CAST(NULL AS VARCHAR(20)) AS TIPO3
  ,CAST(NULL AS VARCHAR(20)) AS TIPO4
  ,CAST(NULL AS VARCHAR(20)) AS TIPO5
  ,CAST(NULL AS VARCHAR(20)) AS TIPO6

  ,CAST(NULL AS VARCHAR(20)) AS SOTTOCANTIERE1
  ,CAST(NULL AS VARCHAR(20)) AS SOTTOCANTIERE2
  ,CAST(NULL AS VARCHAR(20)) AS SOTTOCANTIERE3
  ,CAST(NULL AS VARCHAR(20)) AS SOTTOCANTIERE4
  ,CAST(NULL AS VARCHAR(20)) AS SOTTOCANTIERE5
  ,CAST(NULL AS VARCHAR(20)) AS SOTTOCANTIERE6

  ,COALESCE(P.CATEGCANT1, '') AS CATEGCANT1
  ,COALESCE(P.CATEGCANT2, '') AS CATEGCANT2
  ,COALESCE(P.CATEGCANT3, '') AS CATEGCANT3
  ,COALESCE(P.CATEGCANT4, '') AS CATEGCANT4
  ,COALESCE(P.CATEGCANT5, '') AS CATEGCANT5
  ,COALESCE(P.CATEGCANT6, '') AS CATEGCANT6

  /* ---------- TIPOLOGIA ------- */
  ,CAST('Relazione Intervento' AS VARCHAR(60)) AS TIPOLOGIA

  /* ---------- COSTO NETTO UNITARIO ---------- */
  ,CAST('F' AS CHAR(1)) AS GC_COSTONETTOUNITARIO_MOD
  ,CAST(NULL AS DECIMAL(12,4)) AS GC_COSTONETTOUNITARIO

  /* ---------- RICARICO ---------- */
  ,CAST('F' AS CHAR(1)) AS GC_RICARICO_MOD
  ,CAST(NULL AS NUMERIC(11,4)) AS GC_RICARICO

  /* ---------- QTA ---------- */
  ,CAST('F' AS CHAR(1)) AS GC_QTA_MOD
  ,CAST(NULL AS NUMERIC(11,4)) AS GC_QTA

  /* ---------- DESCRIZIONE ---------- */
  ,CAST('F' AS CHAR(1)) AS GC_DESCRIZIONE_MOD
  ,CAST(NULL AS VARCHAR(5000)) AS GC_DESCRIZIONE

  ,I.RDA AS RDA

FROM IMPEGNI I
LEFT JOIN PRVORDCL T ON (T.TipoDocumento = I.TipoImpegno  AND T.Registro = I.Registro  AND T.NumOrdPrev = I.ID)
LEFT JOIN PRATICHE P ON (P.CODICE=I.PRATICA AND P.DATAAPERTURA=I.DATAPRATICA1)

WHERE I.TipoImpegno = 'Intervento' AND COALESCE(I.RelazioneIntervento,'') <> ''
AND I.PRATICA IS NOT NULL AND I.PRATICA <> 0   /* NB: RIGA AGGIUNTA, PRIMA NON C'ERA */
AND T.SEGNOOPERAZIONECANTIERE<>'=' AND T.SEGNOOPERAZIONECANTIERE IS NOT NULL AND T.SEGNOOPERAZIONECANTIERE<>''
/* ================================================= */


UNION ALL

/* =================================================
   |   RIGHI DOCUMENTI - MATERIALI/APPARECCHI      |
   =================================================
*/
SELECT
   R.TipoDocumento
  ,R.NumOrdPrev
  ,R.Registro
  ,R.DATADOCUMENTO
  ,R.PROGRIGO
  ,R.PROGRIGO2
  ,T.CAUSALE
  ,R.CODICECLIENTE

  ,P.TIPO AS PRAT_TIPO
  ,R.PRATICA
  ,R.DATAPRATICA1
  ,P.DATACHIUSURA
  ,P.COSTRUTTORE
  ,P.MODELLO
  ,P.DESCRIZIONE
  ,P.STATODESCRIZIONE
  ,P.CLIENTE
  ,CAST(  SUBSTRING(  P.RAGSOCCLI || ' (' || P.CLIENTE || ')'   FROM 1 FOR 100) AS VARCHAR(100)) AS RIFSOGGPRAT

  ,COALESCE(P.PRZUNITOPERA1_1, 0)
  ,COALESCE(P.PRZUNITOPERA1_2, 0)
  ,COALESCE(P.PRZUNITOPERA1_3, 0)
  ,COALESCE(P.PRZUNITOPERA1_4, 0)
  ,COALESCE(P.PRZUNITOPERA1_5, 0)
  ,COALESCE(P.COSTOUNITOPERA1_1, 0)
  ,COALESCE(P.COSTOUNITOPERA1_2, 0)
  ,COALESCE(P.COSTOUNITOPERA1_3, 0)
  ,COALESCE(P.COSTOUNITOPERA1_4, 0)
  ,COALESCE(P.COSTOUNITOPERA1_5, 0)
  ,P.TIPORICARICO
  ,P.TIPORICARICOCOMEDACOMMESSA
  ,P.TIPOCOSTO
  ,COALESCE(P.RICARICOPERC,0)
  ,P.LISTINO
  ,CAST(NULL AS INTEGER) AS OPERAINDEX
  ,P.IMMOBLOCALITA
  ,P.IMMOBINDIRIZZO
  ,P.IMMOBNUMCIVICO
  ,P.IMMOBPROVINCIA
  ,P.IMMOBCAP

  ,R.GUID
  ,R.GUID_REF
  ,R.GUID_ANCESTOR

  ,R.SEGNOOPERAZIONECANTIERE
  ,R.MOVMAG AS SEGNOOPERAZIONE
  ,T.STATODESCRIZIONE
  ,T.STATOFOREGROUND

  ,T.RagSocCli

  ,R.CodiceMagazzino
  ,R.CODICEARTICOLO
  ,R.CODICEARTICOLOSTM
  ,COALESCE(R.Descrizione,'')
  ,COALESCE(R.PrezzoUnitario,0)
  ,R.UnitaDiMisura
  ,COALESCE(R.Qta,0)
  ,COALESCE(R.ScontoRigo,0)
  ,COALESCE(R.ScontoRigo2,0)
  ,COALESCE(R.ScontoRigo3,0)
  ,COALESCE(R.ImportoRigo,0)
  ,COALESCE(R.PREZZOACQUISTOARTICOLO,0)
  ,CAST(R.NOTERIGO AS VARCHAR(1000))
  ,CAST(COALESCE(R.MARGINE,0) AS DECIMAL(15,4))

  ,R.CODICEIVA
  ,R.DESCRIZIONEIVA
  ,COALESCE(R.ALIQUOTAIVA,0)

  ,COALESCE(T.AGENTE, '')  AS AGENTE
  ,COALESCE(T.AGENTE2, '') AS AGENTE2
  ,COALESCE(T.AGENTE3, '') AS AGENTE3
  ,COALESCE(T.AGENTE4, '') AS AGENTE4

  ,COALESCE(R.TIPO1, '') AS TIPO1
  ,COALESCE(R.TIPO2, '') AS TIPO2
  ,COALESCE(R.TIPO3, '') AS TIPO3
  ,COALESCE(R.TIPO4, '') AS TIPO4
  ,COALESCE(R.TIPO5, '') AS TIPO5
  ,COALESCE(R.TIPO6, '') AS TIPO6

  ,COALESCE(R.SOTTOCANTIERE1, '') AS SOTTOCANTIERE1
  ,COALESCE(R.SOTTOCANTIERE2, '') AS SOTTOCANTIERE2
  ,COALESCE(R.SOTTOCANTIERE3, '') AS SOTTOCANTIERE3
  ,COALESCE(R.SOTTOCANTIERE4, '') AS SOTTOCANTIERE4
  ,COALESCE(R.SOTTOCANTIERE5, '') AS SOTTOCANTIERE5
  ,COALESCE(R.SOTTOCANTIERE6, '') AS SOTTOCANTIERE6

  ,COALESCE(P.CATEGCANT1, '') AS CATEGCANT1
  ,COALESCE(P.CATEGCANT2, '') AS CATEGCANT2
  ,COALESCE(P.CATEGCANT3, '') AS CATEGCANT3
  ,COALESCE(P.CATEGCANT4, '') AS CATEGCANT4
  ,COALESCE(P.CATEGCANT5, '') AS CATEGCANT5
  ,COALESCE(P.CATEGCANT6, '') AS CATEGCANT6

  /* ---------- TIPOLOGIA ------- */
  ,CAST('Materiali / Apparecchi' AS VARCHAR(60))

  /* ---------- COSTO NETTO UNITARIO ---------- */
  ,COALESCE(R.GC_COSTONETTOUNITARIO_MOD, 'F')
  ,COALESCE(R.GC_COSTONETTOUNITARIO,0)

  /* ---------- RICARICO ---------- */
  ,COALESCE(R.GC_RICARICO_MOD, 'F')
  ,COALESCE(R.GC_RICARICO,0)

  /* ---------- QTA ---------- */
  ,COALESCE(R.GC_QTA_MOD, 'F')
  ,COALESCE(R.GC_QTA,0)

  /* ---------- DESCRIZIONE ---------- */
  ,COALESCE(R.GC_DESCRIZIONE_MOD, 'F')
  ,COALESCE(R.GC_DESCRIZIONE,'')

  ,CAST(I.RDA AS VARCHAR(20))

FROM RIGHIPRV R
LEFT JOIN PRVORDCL T ON (T.TipoDocumento = R.TipoDOcumento  AND T.Registro = R.Registro  AND T.NumOrdPrev = R.NumOrdPrev  AND T.DataDocumento = R.DataDocumento)
LEFT JOIN PRATICHE P ON (P.CODICE=R.PRATICA AND P.DATAAPERTURA=R.DATAPRATICA1)
LEFT JOIN IMPEGNI I ON (R.TIPODOCUMENTO='Intervento' AND I.ID=R.NUMORDPREV)

WHERE R.PRATICA IS NOT NULL AND R.PRATICA <> 0   /* NB: RIGA AGGIUNTA, PRIMA NON C'ERA */
AND R.SEGNOOPERAZIONECANTIERE<>'=' AND R.SEGNOOPERAZIONECANTIERE IS NOT NULL AND R.SEGNOOPERAZIONECANTIERE<>''
AND COALESCE(R.CODICEIVA,1)<>-9   /* ATTENZIONE!!! lasciare questo coalesce perchè altrimenti non visualizza i righi aggiunti al volo sul GC */
AND R.PROGRIGO2 = -1   /* In questo modo non fà vedere i sottorighi degli articoli composti */
AND (   COALESCE(R.ROWTYPE,'') = '' OR SUBSTRING(COALESCE(R.ROWTYPE,'') FROM CHAR_LENGTH(COALESCE(R.ROWTYPE,''))) <> '_'   ) /* In questo modo non fà vedere i righi che non vengono considerati nel calcolo dei totali del documento */
AND ((SELECT * FROM GC_IS_RIGOPRV_DA_VISUALIZZARE(R.CODICEARTICOLO, R.TIPODOCUMENTO, R.NUMORDPREV, R.REGISTRO, R.DATADOCUMENTO, R.PROGRIGO, R.SEGNOOPERAZIONECANTIERE)) = 'T')
/* ================================================= */


UNION ALL


/* =================================================
   |   RAPGIORNRIGHI - MANODOPERA ORE              |
   =================================================
*/
SELECT

  CAST(ORE.TIPODOC AS VARCHAR(25)) AS TIPODOCUMENTO
 ,CAST(ORE.NUMDOC AS INTEGER) AS NUMORDPREV
 ,CAST(ORE.REGISTRO AS VARCHAR(5)) AS REGISTRO
 ,CAST(ORE.DATADOC AS TIMESTAMP) AS DATADOCUMENTO
 ,CAST(ORE.NUMRIGO AS INTEGER) AS PROGRIGO
 ,CAST(ORE.NUMRIGO2 AS INTEGER) AS PROGRIGO2
 ,CAST(NULL AS VARCHAR(40)) AS CAUSALE
 ,ORE.CODSOGGETTO AS CODICECLIENTE

 ,P.TIPO AS PRAT_TIPO
 ,ORE.CODCANTIERE
 ,ORE.DATACANTIERE
 ,P.DATACHIUSURA
 ,P.COSTRUTTORE
 ,P.MODELLO
 ,P.DESCRIZIONE
 ,P.STATODESCRIZIONE
 ,P.CLIENTE AS CODSOGGPRAT
 ,CAST(  SUBSTRING(  P.RAGSOCCLI || ' (' || P.CLIENTE || ')'   FROM 1 FOR 100) AS VARCHAR(100)) AS RIFSOGGPRAT
 ,COALESCE(P.PRZUNITOPERA1_1, 0)
 ,COALESCE(P.PRZUNITOPERA1_2, 0)
 ,COALESCE(P.PRZUNITOPERA1_3, 0)
 ,COALESCE(P.PRZUNITOPERA1_4, 0)
 ,COALESCE(P.PRZUNITOPERA1_5, 0)
 ,COALESCE(P.COSTOUNITOPERA1_1, 0)
 ,COALESCE(P.COSTOUNITOPERA1_2, 0)
 ,COALESCE(P.COSTOUNITOPERA1_3, 0)
 ,COALESCE(P.COSTOUNITOPERA1_4, 0)
 ,COALESCE(P.COSTOUNITOPERA1_5, 0)
 ,P.TIPORICARICO
 ,P.TIPORICARICOCOMEDACOMMESSA
 ,P.TIPOCOSTO
 ,COALESCE(P.RICARICOPERC,0)
 ,P.LISTINO
 ,CAST(ORE.OPERAINDEX AS INTEGER) AS OPERAINDEX
 ,P.IMMOBLOCALITA
 ,P.IMMOBINDIRIZZO
 ,P.IMMOBNUMCIVICO
 ,P.IMMOBPROVINCIA
 ,P.IMMOBCAP

 ,ORE.GUID
 ,ORE.GUID_REF
 ,ORE.GUID_ANCESTOR

 ,ORE.SEGNOOPERAZIONECANTIERE
 ,CAST(NULL AS VARCHAR(1)) AS SEGNOOPERAZIONE

 ,CASE WHEN (ORE.TIPODOC = 'Rapp.Giorn.') THEN T.STATODESCRIZIONE ELSE PRV.STATODESCRIZIONE END
 ,CASE WHEN (ORE.TIPODOC = 'Rapp.Giorn.') THEN T.STATOFOREGROUND ELSE PRV.STATOFOREGROUND END

 ,ORE.DESCRIZSOGGETTO

 ,CAST(CODDIPENDENTE AS SMALLINT) AS CODICEMAGAZZINO
 ,CAST('Opera - ' || ORE.CODDIPENDENTE AS VARCHAR(25)) AS CODICEARTICOLO
 ,CAST('Opera - ' || ORE.CODDIPENDENTE AS VARCHAR(25)) AS CODICEARTICOLOSTM
 ,CAST(COALESCE(ORE.DESCRIZDIPENDENTE,'') AS VARCHAR(5000)) AS DESCRIZIONE
 ,CAST(COALESCE(ORE.PRZVEND,0) AS NUMERIC(11,4)) AS PREZZOUNITARIO
 ,CAST('H' AS VARCHAR(2)) AS UNITADIMISURA
 ,CAST(   COALESCE(ORE.QTA,0) + COALESCE(ORE.QTASTRAORDINARIO,0) + COALESCE(ORE.QTATRASFERTE,0)   AS NUMERIC(11,4)) AS QTA
 ,CAST(0 AS NUMERIC(11,4)) AS SCONTORIGO
 ,CAST(0 AS NUMERIC(11,4)) AS SCONTORIGO2
 ,CAST(0 AS NUMERIC(11,4)) AS SCONTORIGO3
 ,CAST(COALESCE(ORE.IMPORTOVEND,0) AS NUMERIC(11,4)) AS IMPORTORIGO

 ,CAST(
    CASE WHEN (COALESCE(ORE.QTA,0) + COALESCE(ORE.QTASTRAORDINARIO,0) + COALESCE(ORE.QTATRASFERTE,0) = 0) THEN 0 ELSE
      (COALESCE(ORE.IMPORTOCOSTOORARIO,0) + COALESCE(ORE.IMPORTOSTRAORDINARIO,0) + COALESCE(ORE.IMPORTOTRASFERTE,0)) / (COALESCE(ORE.QTA,0) + COALESCE(ORE.QTASTRAORDINARIO,0) + COALESCE(ORE.QTATRASFERTE,0))
    END
  AS NUMERIC(11,4)) AS PREZZOACQUISTOARTICOLO

 ,CAST(ORE.NOTE AS VARCHAR(1000))
 ,CAST(NULL AS DECIMAL(15,4)) AS MARGINE
 ,CAST(NULL AS INTEGER) AS CODICEIVA
 ,CAST(NULL AS VARCHAR(40)) AS DESCRIZIONEIVA
 ,CAST(0 AS DECIMAL(15,4)) AS ALIQUOTAIVA
 
 ,COALESCE(T.AGENTE, '')  AS AGENTE
 ,COALESCE(T.AGENTE2, '') AS AGENTE2
 ,COALESCE(T.AGENTE3, '') AS AGENTE3
 ,COALESCE(T.AGENTE4, '') AS AGENTE4

 ,COALESCE(ORE.TIPO1, '') AS TIPO1
 ,COALESCE(ORE.TIPO2, '') AS TIPO2
 ,COALESCE(ORE.TIPO3, '') AS TIPO3
 ,COALESCE(ORE.TIPO4, '') AS TIPO4
 ,COALESCE(ORE.TIPO5, '') AS TIPO5
 ,COALESCE(ORE.TIPO6, '') AS TIPO6

 ,COALESCE(ORE.SOTTOCANTIERE1, '') AS SOTTOCANTIERE1
 ,COALESCE(ORE.SOTTOCANTIERE2, '') AS SOTTOCANTIERE2
 ,COALESCE(ORE.SOTTOCANTIERE3, '') AS SOTTOCANTIERE3
 ,CAST('' AS VARCHAR(20)) AS SOTTOCANTIERE4
 ,CAST('' AS VARCHAR(20)) AS SOTTOCANTIERE5
 ,CAST('' AS VARCHAR(20)) AS SOTTOCANTIERE6

 ,COALESCE(P.CATEGCANT1, '') AS CATEGCANT1
 ,COALESCE(P.CATEGCANT2, '') AS CATEGCANT2
 ,COALESCE(P.CATEGCANT3, '') AS CATEGCANT3
 ,COALESCE(P.CATEGCANT4, '') AS CATEGCANT4
 ,COALESCE(P.CATEGCANT5, '') AS CATEGCANT5
 ,COALESCE(P.CATEGCANT6, '') AS CATEGCANT6

 ,CAST('Manodopera' AS VARCHAR(60)) AS TIPOLOGIA

 /* ---------- COSTO NETTO UNITARIO ---------- */
 ,COALESCE(ORE.GC_COSTONETTOUNITARIO_MOD, 'F')
 ,COALESCE(ORE.GC_COSTONETTOUNITARIO,0)

 /* ---------- RICARICO ---------- */
 ,COALESCE(ORE.GC_RICARICO_MOD, 'F')
 ,COALESCE(ORE.GC_RICARICO,0)

 /* ---------- QTA ---------- */
 ,COALESCE(ORE.GC_QTA_MOD, 'F')
 ,COALESCE(ORE.GC_QTA,0)

 /* ---------- DESCRIZIONE ---------- */
 ,COALESCE(ORE.GC_DESCRIZIONE_MOD, 'F')
 ,COALESCE(ORE.GC_DESCRIZIONE,'')

 ,CAST(NULL AS VARCHAR(20))

FROM RAPGIORNRIGHI ORE
LEFT JOIN RAPGIORN T ON (T.NUMDOC = ORE.NUMDOC AND T.DATADOC = ORE.DATADOC AND T.Registro = ORE.Registro)
LEFT JOIN PRVORDCL PRV ON (PRV.TIPODOCUMENTO = ORE.TIPODOC AND PRV.REGISTRO = ORE.REGISTRO AND PRV.NUMORDPREV = ORE.NUMDOC AND PRV.DATADOCUMENTO = ORE.DATADOC)
LEFT JOIN PRATICHE P ON (P.CODICE=ORE.CODCANTIERE AND P.DATAAPERTURA=ORE.DATACANTIERE)

/* ----- Non visualizza i dettagli manodopera di fatture e commesse perchè in questo caso usa i righi principali */
WHERE ORE.CODCANTIERE IS NOT NULL AND ORE.CODCANTIERE <> 0   /* NB: RIGA AGGIUNTA, PRIMA NON C'ERA */
  AND ORE.SEGNOOPERAZIONECANTIERE <> 'F' AND ORE.SEGNOOPERAZIONECANTIERE <> 'C'
/* ================================================= */



UNION ALL



/* =================================================
   |   RAPGIORNRIGHISPESE - ALTRE SPESE            |
   =================================================
*/
SELECT

  CAST(SPESE.TIPODOC AS VARCHAR(25)) AS TIPODOCUMENTO
 ,CAST(SPESE.NUMDOC AS INTEGER) AS NUMORDPREV
 ,CAST(SPESE.REGISTRO AS VARCHAR(5)) AS REGISTRO
 ,CAST(SPESE.DATADOC AS TIMESTAMP) AS DATADOCUMENTO
 ,CAST(SPESE.NUMRIGO AS INTEGER) AS PROGRIGO
 ,CAST(SPESE.NUMRIGO2 AS INTEGER) AS PROGRIGO2
 ,CAST(NULL AS VARCHAR(40)) AS CAUSALE
 ,SPESE.CODSOGGETTO AS CODICECLIENTE

 ,P.TIPO AS PRAT_TIPO
 ,SPESE.CODCANTIERE
 ,SPESE.DATACANTIERE
 ,P.DATACHIUSURA
 ,P.COSTRUTTORE
 ,P.MODELLO
 ,P.DESCRIZIONE
 ,P.STATODESCRIZIONE
 ,P.CLIENTE AS CODSOGGPRAT
 ,CAST(  SUBSTRING(  P.RAGSOCCLI || ' (' || P.CLIENTE || ')'   FROM 1 FOR 100) AS VARCHAR(100)) AS RIFSOGGPRAT
 ,COALESCE(P.PRZUNITOPERA1_1, 0)
 ,COALESCE(P.PRZUNITOPERA1_2, 0)
 ,COALESCE(P.PRZUNITOPERA1_3, 0)
 ,COALESCE(P.PRZUNITOPERA1_4, 0)
 ,COALESCE(P.PRZUNITOPERA1_5, 0)
 ,COALESCE(P.COSTOUNITOPERA1_1, 0)
 ,COALESCE(P.COSTOUNITOPERA1_2, 0)
 ,COALESCE(P.COSTOUNITOPERA1_3, 0)
 ,COALESCE(P.COSTOUNITOPERA1_4, 0)
 ,COALESCE(P.COSTOUNITOPERA1_5, 0)
 ,P.TIPORICARICO
 ,P.TIPORICARICOCOMEDACOMMESSA
 ,P.TIPOCOSTO
 ,COALESCE(P.RICARICOPERC,0)
 ,P.LISTINO
 ,CAST(NULL AS INTEGER) AS OPERAINDEX
 ,P.IMMOBLOCALITA
 ,P.IMMOBINDIRIZZO
 ,P.IMMOBNUMCIVICO
 ,P.IMMOBPROVINCIA
 ,P.IMMOBCAP

 ,SPESE.GUID
 ,SPESE.GUID_REF
 ,SPESE.GUID_ANCESTOR

 ,SPESE.SEGNOOPERAZIONECANTIERE
 ,CAST(NULL AS VARCHAR(1)) AS SEGNOOPERAZIONE
 ,T.STATODESCRIZIONE
 ,T.STATOFOREGROUND

 ,SPESE.DESCRIZSOGGETTO AS RAGSOCCLI

 ,CAST(CODDIPENDENTE AS SMALLINT) AS CODICEMAGAZZINO
 ,CAST('Spese - ' || SPESE.CODDIPENDENTE AS VARCHAR(25)) AS CODICEARTICOLO
 ,CAST('Spese - ' || SPESE.CODDIPENDENTE AS VARCHAR(25)) AS CODICEARTICOLOSTM
 ,CAST(COALESCE(SPESE.DESCRIZDIPENDENTE,'') AS VARCHAR(5000)) AS DESCRIZIONE
 ,CAST(COALESCE(SPESE.IMPORTO,0) AS NUMERIC(11,4)) AS PREZZOUNITARIO
 ,CAST(NULL AS VARCHAR(2)) AS UNITADIMISURA
 ,CAST(   1   AS NUMERIC(11,4)) AS QTA
 ,CAST(0 AS NUMERIC(11,4)) AS SCONTORIGO
 ,CAST(0 AS NUMERIC(11,4)) AS SCONTORIGO2
 ,CAST(0 AS NUMERIC(11,4)) AS SCONTORIGO3
 ,CAST(COALESCE(SPESE.IMPORTO,0) AS NUMERIC(11,4)) AS IMPORTORIGO
 ,CAST(COALESCE(SPESE.IMPORTO,0) AS NUMERIC(11,4)) AS PREZZOACQUISTOARTICOLO
 ,CAST(SPESE.NOTE AS VARCHAR(1000))
 ,CAST(0 AS DECIMAL(15,4)) AS MARGINE
 ,CAST(NULL AS INTEGER)	AS CODICEIVA
 ,CAST(NULL AS VARCHAR(40)) AS DESCRIZIONEIVA
 ,CAST(0 AS DECIMAL(15,4)) AS ALIQUOTAIVA
 
 ,COALESCE(T.AGENTE, '')  AS AGENTE
 ,COALESCE(T.AGENTE2, '') AS AGENTE2
 ,COALESCE(T.AGENTE3, '') AS AGENTE3
 ,COALESCE(T.AGENTE4, '') AS AGENTE4

 ,COALESCE(SPESE.TIPO1, '') AS TIPO1
 ,COALESCE(SPESE.TIPO2, '') AS TIPO2
 ,COALESCE(SPESE.TIPO3, '') AS TIPO3
 ,COALESCE(SPESE.TIPO4, '') AS TIPO4
 ,COALESCE(SPESE.TIPO5, '') AS TIPO5
 ,COALESCE(SPESE.TIPO6, '') AS TIPO6

 ,COALESCE(SPESE.SOTTOCANTIERE1, '') AS SOTTOCANTIERE1
 ,COALESCE(SPESE.SOTTOCANTIERE2, '') AS SOTTOCANTIERE2
 ,COALESCE(SPESE.SOTTOCANTIERE3, '') AS SOTTOCANTIERE3
 ,CAST('' AS VARCHAR(20)) AS SOTTOCANTIERE4
 ,CAST('' AS VARCHAR(20)) AS SOTTOCANTIERE5
 ,CAST('' AS VARCHAR(20)) AS SOTTOCANTIERE6

 ,COALESCE(P.CATEGCANT1, '') AS CATEGCANT1
 ,COALESCE(P.CATEGCANT2, '') AS CATEGCANT2
 ,COALESCE(P.CATEGCANT3, '') AS CATEGCANT3
 ,COALESCE(P.CATEGCANT4, '') AS CATEGCANT4
 ,COALESCE(P.CATEGCANT5, '') AS CATEGCANT5
 ,COALESCE(P.CATEGCANT6, '') AS CATEGCANT6

 ,CAST('Altre spese' AS VARCHAR(60)) AS TIPOLOGIA

 /* ---------- COSTO NETTO UNITARIO ---------- */
 ,COALESCE(SPESE.GC_COSTONETTOUNITARIO_MOD, 'F')
 ,COALESCE(SPESE.GC_COSTONETTOUNITARIO,0)

 /* ---------- RICARICO ---------- */
 ,COALESCE(SPESE.GC_RICARICO_MOD, 'F')
 ,COALESCE(GC_RICARICO,0)

 /* ---------- QTA ---------- */
 ,COALESCE(SPESE.GC_QTA_MOD, 'F')
 ,COALESCE(SPESE.GC_QTA,0)

 /* ---------- DESCRIZIONE ---------- */
 ,COALESCE(SPESE.GC_DESCRIZIONE_MOD, 'F')
 ,COALESCE(SPESE.GC_DESCRIZIONE,'')

 ,CAST(NULL AS VARCHAR(20))


FROM RAPGIORNRIGHISPESE SPESE
LEFT JOIN RAPGIORN T ON (T.NUMDOC = SPESE.NUMDOC AND T.DATADOC = SPESE.DATADOC AND T.Registro = SPESE.Registro)
LEFT JOIN PRATICHE P ON (P.CODICE=SPESE.CODCANTIERE AND P.DATAAPERTURA=SPESE.DATACANTIERE)

WHERE SPESE.CODCANTIERE IS NOT NULL AND SPESE.CODCANTIERE <> 0   /* NB: RIGA AGGIUNTA, PRIMA NON C'ERA */
/* ================================================= */
