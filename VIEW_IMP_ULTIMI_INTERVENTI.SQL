
/* View: IMP_ULTIMI_INTERVENTI_VIEW, Owner: 1DR0GAT3 */

CREATE VIEW IMP_ULTIMI_INTERVENTI_VIEW (
  TIPORECORD,
  MASTER_ID,
  CLIENTE,
  PRATICA,
  DATAPRATICA1,
  IDPRATICA,
  TIPODOC,
  REGDOC,
  NUMDOC,
  DATADOC,
  CODICE,
  DESCRIZIONE,
  UM,
  QTA,
  PRZUNIT,
  PRZUNITIVACOMP,
  S1,
  S2,
  S3,
  IMPORTO,
  IMPORTOIVACOMP,
  TECNICO_ID,
  TECNICO_NOME,
  IDAPPARECCHIOPRAT,
  GUID,
  IDALLEGATOFG,
  INABBONAMENTO,
  RifDoc_Tipo,
  RifDoc_Num,
  RifDoc_Reg,
  RifDoc_Data,
  RifDoc_CorrispNoPag,
  RifDoc_TotaleDocumento
) AS

/*======================================================
SEZIONE RIGHI DOCUMENTI: RIGHIPRV
======================================================*/
SELECT
 CAST('30-RIGO DOCUMENTO' AS VARCHAR(25)) AS TIPORECORD
,I.MASTER_ID
,I.CLIENTE
,I.PRATICA
,I.DATAPRATICA1
,I.IDPRATICA
,R.TIPODOCUMENTO
,R.REGISTRO
,R.NUMORDPREV
,I.DATAORAINTERVENTO  /* Cosi non ci sono problemi con il fatto che la data dell'impegno ha la parte time e quella del documento no */
,CAST(R.CODICEARTICOLO AS VARCHAR(25)) AS CODICE
,CAST(R.DESCRIZIONE AS VARCHAR(5000)) AS DESCRIZIONE
,R.UNITADIMISURA
,R.QTA
,R.PREZZOUNITARIO
,R.PREZZOUNITARIOIVACOMPRESA
,R.SCONTORIGO
,R.SCONTORIGO2
,R.SCONTORIGO3
,R.IMPORTORIGO
,R.IMPORTORIGOIVACOMPRESA
,I.RESOURCEID
,TECN.RESOURCENAME
,CAST(COALESCE(R.IDAPPARECCHIOPRAT,0) AS INTEGER)
,R.GUID
,CAST(NULL AS INTEGER) AS IDALLEGATOFG
,CAST('F' AS CHAR(1)) AS INABBONAMENTO
,T.RifDoc_Tipo
,T.RifDoc_Num
,T.RifDoc_Reg
,T.RifDoc_Data
,T.RifDoc_CorrispNoPag
,T.TOTALEDAPAGARE AS RifDoc_TotaleDocumento
FROM RIGHIPRV R
LEFT JOIN IMPEGNI I ON (I.ID = R.NUMORDPREV)
LEFT JOIN PRVORDCL T ON (T.TIPODOCUMENTO='Intervento' AND T.NUMORDPREV=I.ID)
LEFT JOIN TECNICI TECN ON (TECN.RESOURCEID = I.RESOURCEID)
LEFT JOIN PROGRESS P ON (1=1)
WHERE R.TIPODOCUMENTO = 'Intervento'
  AND R.CODICEARTICOLO IS NOT NULL
  AND TRIM(R.CODICEARTICOLO) <> ''
  AND TRIM(R.CODICEARTICOLO) <> '(Abbonamento)'
  AND (R.CODICEARTICOLO <> COALESCE(P.CODICEOPERA,'DATONULLO123') OR (SELECT FIRST 1 P2.MANODOPERANEIPRECEDENTIIMPIANTO FROM PROGRESS2 P2) = 'T')
  AND (R.CODICEARTICOLO <> COALESCE(P.CODICEOPERA_2,'DATONULLO123') OR (SELECT FIRST 1 P2.MANODOPERANEIPRECEDENTIIMPIANTO FROM PROGRESS2 P2) = 'T')
  AND (R.CODICEARTICOLO <> COALESCE(P.CODICEOPERA_3,'DATONULLO123') OR (SELECT FIRST 1 P2.MANODOPERANEIPRECEDENTIIMPIANTO FROM PROGRESS2 P2) = 'T')
  AND (R.CODICEARTICOLO <> COALESCE(P.CODICEOPERA_4,'DATONULLO123') OR (SELECT FIRST 1 P2.MANODOPERANEIPRECEDENTIIMPIANTO FROM PROGRESS2 P2) = 'T')
  AND (R.CODICEARTICOLO <> COALESCE(P.CODICEOPERA_5,'DATONULLO123') OR (SELECT FIRST 1 P2.MANODOPERANEIPRECEDENTIIMPIANTO FROM PROGRESS2 P2) = 'T')
  AND (R.IDOPIMPEGNO IS NULL) /* Esclude le OP altrimenti sarebbero doppie */
  AND (R.PROGRIGO2 = -1) /* Esclude i sottorighi di articoli composti */ 
/* ================================================== */

UNION ALL

/*======================================================
SEZIONE OPERAZIONI PIANIFICATE: OPIMPEGNO
======================================================*/
SELECT
 CAST('20-OPERAZIONE PIANIFICATA' AS VARCHAR(25)) AS TIPORECORD
,I.MASTER_ID
,I.CLIENTE
,I.PRATICA
,I.DATAPRATICA1
,I.IDPRATICA
,I.TIPOIMPEGNO
,I.REGISTRO
,I.ID
,I.DATAORAINTERVENTO
,CAST(OP.IDOP AS VARCHAR(25)) AS CODICE
,CAST(OP.DESCRIZIONE AS VARCHAR(5000)) AS DESCRIZIONE
,CAST('NR' AS VARCHAR(2)) AS UM
,CAST(1 AS DECIMAL(15,4)) AS QTA
,OP.PRZUNIT
,OP.PRZUNITIVACOMP
,OP.SCONTO1
,OP.SCONTO2
,OP.SCONTO3
,OP.PRZUNITNETTO AS IMPORTORIGO
,OP.PRZUNITNETTOIVACOMP AS IMPORTORIGOIVACOMPRESA
,I.RESOURCEID
,TECN.RESOURCENAME
,CAST(COALESCE(OP.IDAPPARECCHIOPRAT,0) AS INTEGER)
,CAST(NULL AS VARCHAR(40)) AS GUID
,CAST(NULL AS INTEGER) AS IDALLEGATOFG
,OP.INABBONAMENTO
,T.RifDoc_Tipo
,T.RifDoc_Num
,T.RifDoc_Reg
,T.RifDoc_Data
,T.RifDoc_CorrispNoPag
,T.TOTALEDAPAGARE AS RifDoc_TotaleDocumento
FROM IMPEGNI I
LEFT JOIN PRVORDCL T ON (T.TIPODOCUMENTO='Intervento' AND T.NUMORDPREV=I.ID)
JOIN OPIMPEGNO OP ON (OP.IDIMPEGNO = I.ID)
LEFT JOIN TECNICI TECN ON (TECN.RESOURCEID = I.RESOURCEID)
WHERE I.TIPOIMPEGNO = 'Intervento'
  AND OP.EFFETTUATA = 'T'

/* ================================================== */

UNION ALL

/*======================================================
SEZIONE RELAZIONE DELL'INTERVENTO: IMPEGNO
======================================================*/
SELECT
 CAST('10-RELAZIONE INTERVENTO' AS VARCHAR(25)) AS TIPORECORD
,I.MASTER_ID
,I.CLIENTE
,I.PRATICA
,I.DATAPRATICA1
,I.IDPRATICA
,I.TIPOIMPEGNO
,I.REGISTRO
,I.ID
,I.DATAORAINTERVENTO
,CAST('(Relazione)' AS VARCHAR(25)) AS CODICE
,CAST(I.RELAZIONEINTERVENTO AS VARCHAR(5000)) AS DESCRIZIONE
,CAST('' AS VARCHAR(2)) AS UM
,CAST(0 AS DECIMAL(15,4)) AS QTA
,CAST(0 AS DECIMAL(15,4)) AS PRZUNIT
,CAST(0 AS DECIMAL(15,4)) AS PRZUNITIVACOMP
,CAST(0 AS DECIMAL(15,4)) AS S1
,CAST(0 AS DECIMAL(15,4)) AS S2
,CAST(0 AS DECIMAL(15,4)) AS S3
,CAST(0 AS DECIMAL(15,4)) AS IMPORTORIGO
,CAST(0 AS DECIMAL(15,4)) AS IMPORTORIGOIVACOMPRESA
,I.RESOURCEID
,TECN.RESOURCENAME
,CAST(2147483647 AS INTEGER) AS IDAPPARECCHIOPRAT   /* Così appare sempre ll'inizio dell'intervento */
,CAST(NULL AS VARCHAR(40)) AS GUID
,CAST(NULL AS INTEGER) AS IDALLEGATOFG
,CAST('F' AS CHAR(1)) AS INABBONAMENTO
,T.RifDoc_Tipo
,T.RifDoc_Num
,T.RifDoc_Reg
,T.RifDoc_Data
,T.RifDoc_CorrispNoPag
,T.TOTALEDAPAGARE AS RifDoc_TotaleDocumento
FROM IMPEGNI I
LEFT JOIN PRVORDCL T ON (T.TIPODOCUMENTO='Intervento' AND T.NUMORDPREV=I.ID)
LEFT JOIN TECNICI TECN ON (TECN.RESOURCEID = I.RESOURCEID)
WHERE I.TIPOIMPEGNO = 'Intervento'
  AND I.RELAZIONEINTERVENTO IS NOT NULL
  AND TRIM(I.RELAZIONEINTERVENTO) <> ''

/* ================================================== */

UNION ALL

/*======================================================
SEZIONE OSSERVAZIONI ALLEGATI: ALLEGATI
======================================================*/
SELECT
 CAST('40-OSSERVAZIONI ALLEGATO' AS VARCHAR(25)) AS TIPORECORD
,I.MASTER_ID
,I.CLIENTE
,I.PRATICA
,I.DATAPRATICA1
,I.IDPRATICA
,I.TIPOIMPEGNO
,I.REGISTRO
,I.ID
,I.DATAORAINTERVENTO
,CAST('(Osservazioni)' AS VARCHAR(25)) AS CODICE
,CAST(A.OSSERVAZIONI AS VARCHAR(5000)) AS DESCRIZIONE
,CAST('' AS VARCHAR(2)) AS UM
,CAST(0 AS DECIMAL(15,4)) AS QTA
,CAST(0 AS DECIMAL(15,4)) AS PRZUNIT
,CAST(0 AS DECIMAL(15,4)) AS PRZUNITIVACOMP
,CAST(0 AS DECIMAL(15,4)) AS S1
,CAST(0 AS DECIMAL(15,4)) AS S2
,CAST(0 AS DECIMAL(15,4)) AS S3
,CAST(0 AS DECIMAL(15,4)) AS IMPORTORIGO
,CAST(0 AS DECIMAL(15,4)) AS IMPORTORIGOIVACOMPRESA
,I.RESOURCEID
,TECN.RESOURCENAME
,CAST(COALESCE(A.GENCAL_ID,0) AS INTEGER) AS IDAPPARECCHIOPRAT
,CAST(NULL AS VARCHAR(40)) AS GUID
,A.ID AS IDALLEGATOFG
,CAST('F' AS CHAR(1)) AS INABBONAMENTO
,T.RifDoc_Tipo
,T.RifDoc_Num
,T.RifDoc_Reg
,T.RifDoc_Data
,T.RifDoc_CorrispNoPag
,T.TOTALEDAPAGARE AS RifDoc_TotaleDocumento
FROM IMPEGNI I
LEFT JOIN PRVORDCL T ON (T.TIPODOCUMENTO='Intervento' AND T.NUMORDPREV=I.ID)
JOIN ALLEGATI_MANUT A ON (A.IDIMPEGNO = I.MASTER_ID)
LEFT JOIN TECNICI TECN ON (TECN.RESOURCEID = I.RESOURCEID)
WHERE I.TIPOIMPEGNO = 'Intervento'
  AND A.OSSERVAZIONI IS NOT NULL
  AND TRIM(A.OSSERVAZIONI) <> ''

/* ================================================== */

UNION ALL

/*======================================================
SEZIONE ULTIMA ANALISI FUMI: ALLEGATI
======================================================*/
SELECT
 CAST('15-ANALISI FUMI ALLEGATO' AS VARCHAR(25)) AS TIPORECORD
,I.MASTER_ID
,I.CLIENTE
,I.PRATICA
,I.DATAPRATICA1
,I.IDPRATICA
,I.TIPOIMPEGNO
,I.REGISTRO
,I.ID
,I.DATAORAINTERVENTO
,CAST('(Analisi fumi)' AS VARCHAR(25)) AS CODICE
/*,CAST(   'Tf=' || TRIM('.' from TRIM('0' from TRIM(A.ANFUMI_TEMPFUMI))) || '°; Ta=' || TRIM('.' from TRIM('0' from TRIM(A.ANFUMI_TEMPAMBIENTE))) || '°; O2=' || TRIM('.' from TRIM('0' from TRIM(A.ANFUMI_O2_PERC))) || '%; CO2=' || TRIM('.' from TRIM('0' from TRIM(A.ANFUMI_CO2_PERC))) || '%; CO=' || TRIM('.' from TRIM('0' from TRIM(A.ANFUMI_CO_PPM))) || 'ppm; R=' || TRIM('.' from TRIM('0' from TRIM(A.ANFUMI_RENDIMENTO_PERC))) || '%; T=' || TRIM('.' from TRIM('0' from TRIM(A.ANFUMI_TIRAGGIO_PA))) || 'pa'    AS VARCHAR(5000)) AS DESCRIZIONE*/
,CAST(   'Tf=' || TRIM('.' from TRIM('0' from TRIM(A.ANFUMI_TEMPFUMI))) || '°; Ta=' || TRIM('.' from TRIM('0' from TRIM(A.ANFUMI_TEMPAMBIENTE))) || '°; O2=' || TRIM('.' from TRIM('0' from TRIM(A.ANFUMI_O2_PERC))) || '%; CO2=' || TRIM('.' from TRIM('0' from TRIM(A.ANFUMI_CO2_PERC))) || '%; CO=' || TRIM('.' from TRIM('0' from TRIM(A.ANFUMI_CO_PPM))) || 'ppm; R=' || TRIM('.' from TRIM('0' from TRIM(A.ANFUMI_RENDIMENTO_PERC))) || '%'    AS VARCHAR(5000)) AS DESCRIZIONE
,CAST('' AS VARCHAR(2)) AS UM
,CAST(0 AS DECIMAL(15,4)) AS QTA
,CAST(0 AS DECIMAL(15,4)) AS PRZUNIT
,CAST(0 AS DECIMAL(15,4)) AS PRZUNITIVACOMP
,CAST(0 AS DECIMAL(15,4)) AS S1
,CAST(0 AS DECIMAL(15,4)) AS S2
,CAST(0 AS DECIMAL(15,4)) AS S3
,CAST(0 AS DECIMAL(15,4)) AS IMPORTORIGO
,CAST(0 AS DECIMAL(15,4)) AS IMPORTORIGOIVACOMPRESA
,I.RESOURCEID
,TECN.RESOURCENAME
,CAST(COALESCE(A.GENCAL_ID,0) AS INTEGER) AS IDAPPARECCHIOPRAT
,CAST(NULL AS VARCHAR(40)) AS GUID
,A.ID AS IDALLEGATOFG
,CAST('F' AS CHAR(1)) AS INABBONAMENTO
,T.RifDoc_Tipo
,T.RifDoc_Num
,T.RifDoc_Reg
,T.RifDoc_Data
,T.RifDoc_CorrispNoPag
,T.TOTALEDAPAGARE AS RifDoc_TotaleDocumento
FROM IMPEGNI I
LEFT JOIN PRVORDCL T ON (T.TIPODOCUMENTO='Intervento' AND T.NUMORDPREV=I.ID)
JOIN ALLEGATI_MANUT A ON (A.IDIMPEGNO = I.MASTER_ID)
LEFT JOIN TECNICI TECN ON (TECN.RESOURCEID = I.RESOURCEID)
WHERE I.TIPOIMPEGNO = 'Intervento'
  AND A.ANFUMI_EFFETTUATO IS NOT NULL
  AND ANFUMI_EFFETTUATO = 'T'

/* ================================================== */
;